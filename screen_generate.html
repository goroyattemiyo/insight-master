<script>
// ===========================================
// ä½œæˆãƒãƒ–ï¼ˆAIç”Ÿæˆ / æ¤œç´¢ / ä¸‹æ›¸ãï¼‰
// ===========================================

App.renderCreateContent = function() {
  var tab = this.state.createTab || 'ai';
  return '<div>' +
    '<div style="padding:16px 16px 0;">' +
      '<div class="subtabs" data-group="create">' +
        '<button class="subtab' + (tab === 'ai' ? ' active' : '') + '" data-group="create" data-tab="ai">AIç”Ÿæˆ</button>' +
        '<button class="subtab' + (tab === 'search' ? ' active' : '') + '" data-group="create" data-tab="search">æ¤œç´¢</button>' +
        '<button class="subtab' + (tab === 'drafts' ? ' active' : '') + '" data-group="create" data-tab="drafts">ä¸‹æ›¸ã</button>' +
      '</div>' +
    '</div>' +
    '<div class="subtab-panels">' +
      '<div id="create-tab-ai" class="subtab-panel' + (tab === 'ai' ? ' active' : '') + '">' +
        this.renderGenerateContent() +
      '</div>' +
      '<div id="create-tab-search" class="subtab-panel' + (tab === 'search' ? ' active' : '') + '">' +
      '</div>' +
      '<div id="create-tab-drafts" class="subtab-panel' + (tab === 'drafts' ? ' active' : '') + '">' +
      '</div>' +
    '</div>' +
  '</div>';
};

App.loadCreate = function() {
  var self = this;
  var saved = localStorage.getItem('insight_master_subtab_create');
  var tab = saved || this.state.createTab || 'ai';
  document.querySelectorAll('.subtab[data-group="create"]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      self.switchCreateTab_(this.getAttribute('data-tab'));
    });
  });
  this.switchCreateTab_(tab, true);
  this.bindGenerateEvents();
};

App.switchCreateTab_ = function(tab, silent) {
  this.state.createTab = tab;
  localStorage.setItem('insight_master_subtab_create', tab);
  document.querySelectorAll('.subtab[data-group="create"]').forEach(function(btn) {
    btn.classList.toggle('active', btn.getAttribute('data-tab') === tab);
  });
  var panels = ['ai','search','drafts'];
  panels.forEach(function(t) {
    var el = document.getElementById('create-tab-' + t);
    if (el) el.classList.toggle('active', t === tab);
  });
  if (tab === 'search') {
    var searchPanel = document.getElementById('create-tab-search');
    if (searchPanel && searchPanel.innerHTML.trim() === '') {
      searchPanel.innerHTML = this.renderKeywordsContent();
      if (this.loadKeywords) this.loadKeywords();
    }
  }
  if (tab === 'drafts') {
    var draftsPanel = document.getElementById('create-tab-drafts');
    if (draftsPanel && draftsPanel.innerHTML.trim() === '') {
      draftsPanel.innerHTML = this.renderDraftsContent();
      if (this.loadDrafts) this.loadDrafts();
    }
  }
  if (!silent) {
    this.bindTipsEvents();
  }
};

// ===========================================
// AIæŠ•ç¨¿ç”Ÿæˆï¼ˆåˆ†æãƒ™ãƒ¼ã‚¹å¯¾å¿œç‰ˆï¼‰
// ===========================================

App.renderGenerateContent = function() {
  var hasKey = !!(this.state.settings && this.state.settings.hasGeminiKey);
  var savedSettings = null;
  try { savedSettings = JSON.parse(localStorage.getItem('insight_master_ai_settings') || 'null'); } catch (e) {}
  var savedTheme = savedSettings && savedSettings.theme ? savedSettings.theme : '';
  var savedMode = savedSettings && savedSettings.mode ? savedSettings.mode : 'normal';
  var keyWarning = '';
  if (!hasKey) {
    keyWarning = '<div class="card warning-banner mb-12">' +
      '<div class="flex-row gap-8 mb-8"><span class="icon-lg">âš ï¸</span><span class="text-subheading">AIæ©Ÿèƒ½ã‚’ä½¿ã†ã«ã¯Gemini APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™</span></div>' +
      '<button id="goGeminiSettingsBtn" class="btn btn-secondary btn-small">è¨­å®šç”»é¢ã¸</button>' +
      '</div>';
  }

   return '<div class="screen-content">' +
    this.renderTips([
      { title: 'ğŸ“ é€šå¸¸ãƒ¢ãƒ¼ãƒ‰', body: 'è‡ªç”±ãªãƒ†ãƒ¼ãƒã§è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æŠ•ç¨¿æ–‡ã‚’ç”Ÿæˆã€‚ã€Œæœæ´»ã€ã€Œå‰¯æ¥­ã€ã€ŒAIã€ãªã©ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã‚‹ã ã‘ã§OKã€‚å…·ä½“çš„ãªã»ã©è‰¯ã„æŠ•ç¨¿ãŒå‡ºã¾ã™ã€‚' },
      { title: 'ğŸ§µ ãƒ„ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰', body: 'è¦ªæŠ•ç¨¿ï¼‹è¿”ä¿¡2ã€œ3æœ¬ã®ãƒ„ãƒªãƒ¼æ§‹æˆã‚’è‡ªå‹•ç”Ÿæˆã€‚ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ€§ã®ã‚ã‚‹é•·æ–‡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«æœ€é©ã€‚Threadsã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯ãƒ„ãƒªãƒ¼æŠ•ç¨¿ã‚’å„ªé‡ã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚' },
      { title: 'ğŸ“Š åˆ†æãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ï¼ˆãŠã™ã™ã‚ï¼‰', body: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®å®Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆé«˜ERæŠ•ç¨¿ãƒ»ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¿ã‚¤ãƒ ãƒ»ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å±æ€§ï¼‰ã‚’AIã«è‡ªå‹•ã§æ¸¡ã—ã¦ç”Ÿæˆã€‚ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸææ¡ˆãªã®ã§å†ç¾æ€§ãŒé«˜ã„ã§ã™ã€‚' },
      { title: 'ğŸ’¡ è‰¯ã„ãƒ†ãƒ¼ãƒã®æ›¸ãæ–¹', body: 'âŒã€Œä»•äº‹ã€â†’ åºƒã™ãã‚‹<br>âœ…ã€Œãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã§é›†ä¸­åŠ›ã‚’ä¿ã¤ã‚³ãƒ„ã€â†’ å…·ä½“çš„<br>âœ…ã€Œ30ä»£ä¼šç¤¾å“¡ãŒå‰¯æ¥­ã§æœˆ3ä¸‡å††ç¨¼ãã¾ã§ã€â†’ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ˜ç¢º<br>ãƒ†ãƒ¼ãƒãŒå…·ä½“çš„ãªã»ã©AIã®å‡ºåŠ›ã‚‚çš„ç¢ºã«ãªã‚Šã¾ã™ã€‚' }
    ]) +
    '<div class="card"><div class="card-title">AIæŠ•ç¨¿ç”Ÿæˆ</div>' +
      keyWarning +
      '<div class="mb-12"><label class="form-label">ãƒ†ãƒ¼ãƒãƒ»ãƒˆãƒ”ãƒƒã‚¯</label>' +
        '<input type="text" id="aiThemeInput" class="input" placeholder="ä¾‹: æœæ´»ã®ãƒ¡ãƒªãƒƒãƒˆã€AIæ™‚ä»£ã®åƒãæ–¹" value="' + this.escapeAttr(savedTheme) + '"></div>' +
      '<div class="mb-16"><label class="form-label">ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰</label>' +
        '<div style="display:flex;gap:8px;flex-wrap:wrap;">' +
          '<button class="btn btn-small gen-mode-btn' + (savedMode === 'normal' ? ' active' : '') + '" data-mode="normal">ğŸ“ é€šå¸¸</button>' +
          '<button class="btn btn-small gen-mode-btn' + (savedMode === 'thread' ? ' active' : '') + '" data-mode="thread">ğŸ§µ ãƒ„ãƒªãƒ¼</button>' +
          '<button class="btn btn-small gen-mode-btn' + (savedMode === 'analysis-based' ? ' active' : '') + '" data-mode="analysis-based">ğŸ“Š åˆ†æãƒ™ãƒ¼ã‚¹</button></div>' +
        '<p class="form-label-small mt-8" id="modeDesc">ãƒ†ãƒ¼ãƒã«æ²¿ã£ãŸ3ã€œ5ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æŠ•ç¨¿æ–‡ã‚’ç”Ÿæˆ</p></div>' +
      '<div id="analysisPreview" style="display:none;"></div>' +
      '<button id="generateBtn" class="btn btn-primary btn-full" ' + (hasKey ? '' : 'disabled') + '>âœ¨ ç”Ÿæˆã™ã‚‹</button>' +
    '</div>' +
    '<div id="generateResults"></div></div>';
};

App.bindGenerateEvents = function() {
  var self = this;
  var goGeminiSettingsBtn = document.getElementById('goGeminiSettingsBtn');
  if (goGeminiSettingsBtn) {
    goGeminiSettingsBtn.addEventListener('click', function() {
      self.showScreen('settings');
    });
  }

  var selectedMode = 'normal';
  var activeBtn = document.querySelector('.gen-mode-btn.active');
  if (activeBtn) selectedMode = activeBtn.getAttribute('data-mode') || 'normal';
  var modeDescs = {
    'normal': 'ãƒ†ãƒ¼ãƒã«æ²¿ã£ãŸ3ã€œ5ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æŠ•ç¨¿æ–‡ã‚’ç”Ÿæˆ',
    'thread': 'è¦ªæŠ•ç¨¿ï¼‹è¿”ä¿¡2ã€œ3æœ¬ã®ãƒ„ãƒªãƒ¼æŠ•ç¨¿ã‚»ãƒƒãƒˆã‚’ç”Ÿæˆ',
    'analysis-based': 'ğŸ“Š ã‚ãªãŸã®åˆ†æãƒ‡ãƒ¼ã‚¿ï¼ˆé«˜ERæŠ•ç¨¿ãƒ»ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¿ã‚¤ãƒ ãƒ»ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å±æ€§ï¼‰ã‚’å…ƒã«æŠ•ç¨¿æ¡ˆã‚’ç”Ÿæˆ'
  };

  document.querySelectorAll('.gen-mode-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.gen-mode-btn').forEach(function(b) { b.classList.remove('active'); });
      this.classList.add('active');
      selectedMode = this.getAttribute('data-mode');
      var desc = document.getElementById('modeDesc');
      if (desc) desc.textContent = modeDescs[selectedMode] || '';

      // åˆ†æãƒ™ãƒ¼ã‚¹é¸æŠæ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      var preview = document.getElementById('analysisPreview');
      if (selectedMode === 'analysis-based') {
        self.loadAnalysisPreview_();
      } else if (preview) {
        preview.style.display = 'none';
      }
    });
  });

  var genBtn = document.getElementById('generateBtn');
  if (genBtn) genBtn.addEventListener('click', async function() {
    var theme = document.getElementById('aiThemeInput').value.trim();
    if (!theme) { self.showToast('ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    localStorage.setItem('insight_master_ai_settings', JSON.stringify({ theme: theme, mode: selectedMode, tone: '' }));
    genBtn.disabled = true;
    genBtn.textContent = selectedMode === 'analysis-based' 
      ? 'ğŸ“Š åˆ†æãƒ‡ãƒ¼ã‚¿åé›†ï¼‹ç”Ÿæˆä¸­ï¼ˆ15ã€œ45ç§’ï¼‰...' 
      : 'ç”Ÿæˆä¸­ï¼ˆ10ã€œ30ç§’ï¼‰...';

    try {
      var action = selectedMode === 'analysis-based' ? 'generatePostWithAnalysis' : 'generatePostWithAI';
      var result = await self.api(action, { theme: theme, mode: selectedMode, count: 3 });
      self.renderGenerateResults_(result);
    } catch (e) { self.showToast('ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + e.message, 'error'); }
    genBtn.disabled = false; genBtn.textContent = 'âœ¨ ç”Ÿæˆã™ã‚‹';
  });
};

// åˆ†æãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰é¸æŠæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿
App.loadAnalysisPreview_ = function() {
  var self = this;
  var preview = document.getElementById('analysisPreview');
  if (!preview) return;

  preview.style.display = 'block';
  preview.innerHTML = '<div class="warning-banner info-banner">' +
    '<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;"><span>ğŸ“Š</span><strong>åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</strong></div>' +
    '<div class="loading-spinner" style="width:20px;height:20px;margin:0 auto;"></div></div>';

  this.api('getAnalyticsData', { periodDays: 30 }).then(function(data) {
    var summary = data.summary || {};
    var posts = data.posts || [];
    var topPosts = posts
      .filter(function(p) { return p.engagementRate > 0; })
      .sort(function(a, b) { return b.engagementRate - a.engagementRate; })
      .slice(0, 3);

    var html = '<div class="warning-banner info-banner">';
    html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:10px;"><span>ğŸ“Š</span><strong>ã‚ãªãŸã®åˆ†æãƒ‡ãƒ¼ã‚¿ï¼ˆç”Ÿæˆã«ä½¿ç”¨ï¼‰</strong></div>';
    
    html += '<div class="grid-3 mb-8">';
    html += '<div style="background:var(--surface);padding:8px;border-radius:6px;text-align:center;">';
    html += '<div class="form-label-small">æŠ•ç¨¿æ•°</div><div style="font-weight:700;">' + (summary.totalPosts || 0) + '</div></div>';
    html += '<div style="background:var(--surface);padding:8px;border-radius:6px;text-align:center;">';
    html += '<div class="form-label-small">å¹³å‡ER</div><div style="font-weight:700;">' + (summary.avgEngagementRate || 0) + '%</div></div>';
    html += '<div style="background:var(--surface);padding:8px;border-radius:6px;text-align:center;">';
    html += '<div class="form-label-small">ç·ãƒ“ãƒ¥ãƒ¼</div><div style="font-weight:700;">' + (summary.totalViews || 0).toLocaleString() + '</div></div>';
    html += '</div>';

    if (topPosts.length > 0) {
      html += '<div style="font-size:12px;font-weight:600;margin-bottom:6px;">ğŸ† é«˜ERæŠ•ç¨¿TOP' + topPosts.length + '</div>';
      topPosts.forEach(function(p, i) {
        var text = (p.text || '').substring(0, 60);
        html += '<div style="background:var(--surface);padding:6px 8px;border-radius:4px;margin-bottom:4px;font-size:11px;">';
        html += '<span style="color:var(--success);font-weight:700;">ER ' + p.engagementRate.toFixed(1) + '%</span> ';
        html += self.escapeHtml(text) + (p.text && p.text.length > 60 ? 'â€¦' : '');
        html += '</div>';
      });
    }

    if (summary.totalPosts === 0) {
      html += '<div style="color:var(--warning-text);margin-top:6px;">âš ï¸ æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã€Œæ›´æ–°ã€ã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚</div>';
    }

    html += '</div>';
    preview.innerHTML = html;
  }).catch(function() {
    preview.innerHTML = '<div class="warning-banner warning-banner-yellow">' +
      'âš ï¸ åˆ†æãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ç”Ÿæˆã•ã‚Œã¾ã™ã€‚</div>';
  });
};

App.renderGenerateResults_ = function(result) {
  var self = this;
  var c = document.getElementById('generateResults');
  if (!result || !result.results || result.results.length === 0) {
    c.innerHTML = '<div class="card" style="text-align:center;color:var(--text-secondary);">ç”ŸæˆçµæœãŒã‚ã‚Šã¾ã›ã‚“</div>'; return;
  }

  var html = '';

  // åˆ†æãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ä½¿ç”¨ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
  if (result.analysisUsed) {
    var au = result.analysisUsed;
    html += '<div class="card" style="background:linear-gradient(135deg,var(--info-bg),var(--panel-bg));border:1px solid var(--info-border);">';
    html += '<div style="font-size:13px;font-weight:600;margin-bottom:6px;">ğŸ“Š åˆ†æãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ç”Ÿæˆã—ã¾ã—ãŸ</div>';
    html += '<div style="font-size:12px;color:var(--text-secondary);display:flex;flex-wrap:wrap;gap:8px;">';
    html += '<span>ğŸ“ ' + au.totalPosts + 'æŠ•ç¨¿åˆ†æ</span>';
    html += '<span>ğŸ“ˆ å¹³å‡ER ' + au.avgER + '%</span>';
    html += '<span>ğŸ† TOP' + au.topPostCount + 'å‚è€ƒ</span>';
    html += au.hasTimeData ? '<span>â° æ™‚é–“å¸¯åˆ†æ âœ…</span>' : '<span>â° æ™‚é–“å¸¯ âŒ</span>';
    html += au.hasDemographics ? '<span>ğŸ‘¥ å±æ€§ãƒ‡ãƒ¼ã‚¿ âœ…</span>' : '<span>ğŸ‘¥ å±æ€§ âŒ</span>';
    html += '</div></div>';
  }

  result.results.forEach(function(item, idx) {
    if (result.mode === 'thread' && item.parent) {
      // ãƒ„ãƒªãƒ¼æŠ•ç¨¿
      html += '<div class="card card-relative"><button class="ai-save-btn" data-index="' + idx + '" title="ä¿å­˜">ğŸ’¾</button><div class="card-title">ğŸ§µ ãƒ„ãƒªãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ ' + (idx+1) + '</div>' +
        '<div style="padding:10px;background:var(--bg-secondary);border-radius:8px;margin-bottom:8px;border-left:3px solid var(--accent-purple);">' +
          '<div style="font-size:11px;color:var(--accent-purple-strong);margin-bottom:4px;">è¦ªæŠ•ç¨¿</div>' +
          '<div style="font-size:14px;line-height:1.6;">' + self.escapeHtml(item.parent) + '</div></div>';
      (item.replies || []).forEach(function(reply, ri) {
        html += '<div style="padding:10px;background:var(--bg-secondary);border-radius:8px;margin-bottom:8px;margin-left:16px;border-left:2px solid var(--accent-purple-soft);">' +
          '<div style="font-size:11px;color:var(--accent-purple-strong);margin-bottom:4px;">è¿”ä¿¡ ' + (ri+1) + '</div>' +
          '<div style="font-size:14px;line-height:1.6;">' + self.escapeHtml(reply) + '</div></div>';
      });
      // â˜… ã€è¦ªã€‘ã€è¿”ä¿¡Nã€‘å½¢å¼ã§ä¿å­˜ï¼ˆparseThreadParts_ ãŒæ­£ã—ãåˆ†å‰²ã§ãã‚‹ï¼‰
      var threadText = 'ã€è¦ªã€‘' + item.parent;
      (item.replies || []).forEach(function(reply, ri) {
        threadText += '\n\nã€è¿”ä¿¡' + (ri+1) + 'ã€‘' + reply;
      });
      html += '<div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">';
      html += '<button class="btn btn-small btn-secondary copy-gen-btn" data-text="' + self.escapeAttr(item.parent) + '">ğŸ“‹ è¦ªã‚³ãƒ”ãƒ¼</button>';
      (item.replies || []).forEach(function(reply, ri) {
        html += '<button class="btn btn-small btn-secondary copy-gen-btn" data-text="' + self.escapeAttr(reply) + '">ğŸ“‹ è¿”ä¿¡' + (ri+1) + '</button>';
      });
      html += '<div class="btn-group">' +
        '<button class="btn btn-small btn-primary save-draft-btn">ã™ã¹ã¦ä¿å­˜</button></div></div>';
    } else {
      // é€šå¸¸ or åˆ†æãƒ™ãƒ¼ã‚¹æŠ•ç¨¿
      var text = item.text || (typeof item === 'string' ? item : JSON.stringify(item));
      html += '<div class="card card-relative"><button class="ai-save-btn" data-index="' + idx + '" title="ä¿å­˜">ğŸ’¾</button>';
      html += '<div style="font-size:14px;margin-bottom:10px;line-height:1.6;white-space:pre-wrap;">' + self.escapeHtml(text) + '</div>';

      // ç†ç”±ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼‰
      if (item.reason) {
        html += '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;padding:8px;background:var(--bg-tertiary);border-radius:8px;">ğŸ’¡ ' + self.escapeHtml(item.reason) + '</div>';
      }

      // åˆ†æãƒ™ãƒ¼ã‚¹å°‚ç”¨ãƒ¡ã‚¿æƒ…å ±
      if (result.mode === 'analysis-based') {
        html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;">';
        if (item.expectedER) {
          html += '<span style="font-size:11px;background:var(--success-soft);color:var(--success);padding:2px 8px;border-radius:10px;">ğŸ“ˆ äºˆæƒ³ER: ' + self.escapeHtml(item.expectedER) + '</span>';
        }
        if (item.bestTime) {
          html += '<span style="font-size:11px;background:var(--info-soft);color:var(--info);padding:2px 8px;border-radius:10px;">â° ' + self.escapeHtml(item.bestTime) + '</span>';
        }
        if (item.mediaAdvice) {
          html += '<span style="font-size:11px;background:var(--warning-soft);color:var(--warning-deep);padding:2px 8px;border-radius:10px;">ğŸ–¼ï¸ ' + self.escapeHtml(item.mediaAdvice) + '</span>';
        }
        html += '</div>';
      }

      html += '<div class="btn-group">' +
        '<button class="btn btn-small btn-secondary copy-gen-btn" data-text="' + self.escapeAttr(text) + '">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>' +
        '<button class="btn btn-small btn-primary save-draft-btn">ã™ã¹ã¦ä¿å­˜</button></div></div>';
    }
  });

  c.innerHTML = html;

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰
  c.querySelectorAll('.copy-gen-btn').forEach(function(btn) {
    btn.addEventListener('click', function() { self.copyToClipboard(this.getAttribute('data-text')); });
  });
  c.querySelectorAll('.save-draft-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var drafts = [];
      result.results.forEach(function(item) {
        if (result.mode === 'thread' && item.parent) {
          var threadText = 'ã€è¦ªã€‘' + item.parent;
          (item.replies || []).forEach(function(reply, ri) {
            threadText += '\n\nã€è¿”ä¿¡' + (ri+1) + 'ã€‘' + reply;
          });
          drafts.push({ text: threadText, type: 'thread' });
        } else {
          var t = item.text || item;
          drafts.push({ text: t, type: 'single' });
        }
      });
      Promise.all(drafts.map(function(d) {
        return self.api('saveDraft', { text: d.text, type: d.type, source: 'ai_generated' });
      })).then(function() {
        self.showToast('ã™ã¹ã¦ä¿å­˜ã—ã¾ã—ãŸ', 'success');
      }).catch(function(e) { self.showToast('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error'); });
    });
  });

  c.querySelectorAll('.ai-save-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var idx = parseInt(this.getAttribute('data-index'), 10);
      var item = result.results[idx];
      if (!item) return;
      var text = (result.mode === 'thread' && item.parent) ? (function() {
        var t = 'ã€è¦ªã€‘' + item.parent;
        (item.replies || []).forEach(function(reply, ri) { t += '\n\nã€è¿”ä¿¡' + (ri+1) + 'ã€‘' + reply; });
        return t;
      })() : (item.text || item);
      var type = (result.mode === 'thread' && item.parent) ? 'thread' : 'single';
      var selfBtn = this;
      self.api('saveDraft', { text: text, type: type, source: 'ai_single' }).then(function() {
        selfBtn.textContent = 'âœ…';
        setTimeout(function() { selfBtn.textContent = 'ğŸ’¾'; }, 1500);
      }).catch(function(e) { self.showToast('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error'); });
    });
  });
};
</script>
