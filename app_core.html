<script>
var App = {
  state: {
    sheetId: null,
    user: null,
    settings: {},
    currentScreen: 'dashboard',
    accounts: [],
    activeAccount: null,
    tokenWarnings: [],
    analyticsData: null,
    sessionToken: '',
    timeAnalysis: null,
    userInsights: null,
    drafts: [],
    generatedPosts: [],
    // ★FIX: competitorData 削除
    currentDraftFilter: '',
    analyticsTab: 'posts',
    createTab: 'ai'
  },
  init: async function() {
    this.state.sessionToken = (window.SERVER_DATA && window.SERVER_DATA.sessionToken) || this.state.sessionToken;
    if (typeof SERVER_DATA !== 'undefined' && SERVER_DATA.sheetId) {
      this.state.sessionToken = SERVER_DATA.sessionToken || this.state.sessionToken;
      this.state.sheetId = SERVER_DATA.sheetId;
      this.state.settings = SERVER_DATA.settings || {};
      this.state.user = SERVER_DATA.user || null;
      this.state.accounts = SERVER_DATA.accounts || [];
      this.state.activeAccount = SERVER_DATA.activeAccount || null;
      this.state.tokenWarnings = SERVER_DATA.tokenWarnings || [];
      localStorage.setItem('threads_tool_sheet_id', SERVER_DATA.sheetId);
      if (window.endSplash) window.endSplash();
      var initial = SERVER_DATA.initialScreen || 'settings';
      if (['welcome','setup','setup-auth','setup-gemini'].indexOf(initial) !== -1) initial = 'settings';
      this.showScreen(initial);
      return;
    }
    var savedId = localStorage.getItem('threads_tool_sheet_id');
    if (savedId) {
      this.state.sheetId = savedId;
      try {
        var settings = await this.api('getSettings', {});
        this.state.settings = settings;
        if (settings && settings.hasAccessToken) {
          var user = await this.api('getUserProfile', {});
          this.state.user = user.user || user;
          await this.loadAccounts();
          if (window.endSplash) window.endSplash();
          var postAuth = sessionStorage.getItem('postAuthRedirect');
          if (postAuth === 'settings') {
            sessionStorage.removeItem('postAuthRedirect');
            this.showScreen('settings');
          } else {
            this.showScreen('dashboard');
          }
          return;
        } else {
          if (window.endSplash) window.endSplash();
          this.showScreen('settings'); return;
        }
      } catch (e) { console.log('init error:', e.message); }
    }
    if (window.endSplash) window.endSplash();
    this.showScreen('settings');
  },
  apiCache_: {},
  api: function(action, params, retryCount) {
    var self = this;
    retryCount = retryCount || 0;
    params = params || {};
    params.action = action;
    params.sheetId = this.state.sheetId;
    var sessionToken = this.state.sessionToken || (window.SERVER_DATA && window.SERVER_DATA.sessionToken);
    if (sessionToken) params.sessionToken = sessionToken;
    if (self.state.demoMode) return self.demoApi_(action, params);
    var cacheActions = ['getAnalyticsData','getTimeAnalysisData','fetchUserInsights','getFollowerHistory','getWeeklyReportList','getCompetitors','getWatchPosts','getDrafts','getAccounts','getActiveAccount'];
    var cacheKey = action + '_' + JSON.stringify(params.periodDays || params.days || '');
    if (cacheActions.indexOf(action) !== -1 && self.apiCache_[cacheKey] && (Date.now() - self.apiCache_[cacheKey].ts < 300000)) {
      return Promise.resolve(self.apiCache_[cacheKey].data);
    }
    return new Promise(function(resolve, reject) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result) {
            self.logError_(action, 'EMPTY_RESPONSE', 'サーバー応答なし');
            reject(new Error('サーバー応答なし'));
          } else if (result.success) {
            if (cacheActions.indexOf(action) !== -1) self.apiCache_[cacheKey] = { data: result.data, ts: Date.now() };
            resolve(result.data);
          } else {
            var errMsg = result.error || '不明なエラー';
            var errCode = self.classifyError_(errMsg);
            self.logError_(action, errCode, errMsg);
            if (errCode === 'RATE_LIMITED' || errCode === 'NETWORK_ERROR') {
              if (retryCount < 3) {
                var delay = Math.pow(2, retryCount) * 1000;
                setTimeout(function() {
                  self.api(action, params, retryCount + 1).then(resolve).catch(reject);
                }, delay);
                return;
              }
            }
            var userMsg = self.getUserErrorMessage_(errCode, errMsg);
            reject(new Error(userMsg));
          }
        })
        .withFailureHandler(function(error) {
          var errMsg = error.message || String(error);
          var errCode = self.classifyError_(errMsg);
          self.logError_(action, errCode, errMsg);
          if ((errCode === 'NETWORK_ERROR') && retryCount < 3) {
            var delay = Math.pow(2, retryCount) * 1000;
            setTimeout(function() {
              self.api(action, params, retryCount + 1).then(resolve).catch(reject);
            }, delay);
            return;
          }
          reject(new Error(self.getUserErrorMessage_(errCode, errMsg)));
        })
        .processApiRequest(params);
    });
  },
  clearApiCache: function() { this.apiCache_ = {}; },
  loadAccounts: async function() {
    try {
      this.state.accounts = await this.api('getAccounts', {}) || [];
      this.state.activeAccount = await this.api('getActiveAccount', {}) || null;
    } catch (e) { this.state.accounts = []; this.state.activeAccount = null; }
  },
  classifyError_: function(msg) {
    if (!msg) return 'UNKNOWN';
    msg = msg.toLowerCase();
    if (msg.indexOf('token') !== -1 || msg.indexOf('認証') !== -1 || msg.indexOf('auth') !== -1 || msg.indexOf('expired') !== -1) return 'AUTH_EXPIRED';
    if (msg.indexOf('rate') !== -1 || msg.indexOf('limit') !== -1 || msg.indexOf('quota') !== -1 || msg.indexOf('429') !== -1) return 'RATE_LIMITED';
    if (msg.indexOf('network') !== -1 || msg.indexOf('fetch') !== -1 || msg.indexOf('timeout') !== -1 || msg.indexOf('connection') !== -1) return 'NETWORK_ERROR';
    if (msg.indexOf('sheet') !== -1 || msg.indexOf('シート') !== -1 || msg.indexOf('not found') !== -1) return 'SHEET_NOT_FOUND';
    if (msg.indexOf('gemini') !== -1 && (msg.indexOf('key') !== -1 || msg.indexOf('キー') !== -1 || msg.indexOf('未設定') !== -1)) return 'GEMINI_NO_KEY';
    if (msg.indexOf('gemini') !== -1 && (msg.indexOf('quota') !== -1 || msg.indexOf('超過') !== -1)) return 'GEMINI_QUOTA';
    return 'UNKNOWN';
  },
  getUserErrorMessage_: function(code, raw) {
    switch (code) {
      case 'AUTH_EXPIRED': return '認証の有効期限が切れました。設定画面から再認証してください';
      case 'RATE_LIMITED': return 'APIの利用制限に達しました。数分後に自動リトライします';
      case 'NETWORK_ERROR': return '通信エラーが発生しました。接続を確認してリトライしてください';
      case 'SHEET_NOT_FOUND': return 'シートが見つかりません。設定を確認してください';
      case 'GEMINI_NO_KEY': return 'Gemini APIキーが未設定です。設定画面から追加してください';
      case 'GEMINI_QUOTA': return 'Gemini API無料枠を超過しました。翌日に再試行するか、有料プランをご検討ください';
      default: return raw || '予期せぬエラーが発生しました';
    }
  },
  logError_: function(action, code, msg) {
    try {
      var logs = JSON.parse(localStorage.getItem('insight_master_error_log') || '[]');
      logs.unshift({ time: new Date().toISOString(), action: action, code: code, msg: msg });
      if (logs.length > 50) logs = logs.slice(0, 50);
      localStorage.setItem('insight_master_error_log', JSON.stringify(logs));
    } catch (e) { /* ignore */ }
  },
  switchAccount: async function(accountId) {
    try {
      this.showToast('切り替え中…');
      var data = await this.api('switchAccount', { accountId: accountId });
      this.state.accounts = data.accounts || [];
      this.state.user = data.user || {};
      this.state.activeAccount = null;
      for (var i = 0; i < this.state.accounts.length; i++) {
        if (this.state.accounts[i].accountId === accountId) {
          this.state.activeAccount = this.state.accounts[i];
          break;
        }
      }
      this.showToast('アカウントを切り替えました', 'success');
      this.showScreen(this.state.currentScreen);
    } catch (e) {
      this.showToast('切り替えエラー: ' + e.message, 'error');
    }
  },
  deleteAccount: async function(accountId) {
    var acc = this.state.accounts.find(function(a) { return a.accountId === accountId; });
    if (!confirm('@' + (acc ? acc.username : accountId) + ' を削除しますか？')) return;
    try {
      await this.api('removeAccount', { accountId: accountId });
      await this.loadAccounts();
      var user = await this.api('getUserProfile', {});
      this.state.user = user.user || user;
      this.showToast('削除しました', 'success');
      this.showScreen('settings');
    } catch (e) { this.showToast('削除エラー: ' + e.message, 'error'); }
  },
  showScreen: function(screen) {
    if (['dashboard', 'analytics', 'create'].indexOf(screen) !== -1 &&
        this.isSetupComplete_ && !this.isSetupComplete_()) {
      this.showToast(' 先に設定を完了してください', 'warning');
      if (this.refreshNavLock_) this.refreshNavLock_();
      return;
    }
    this.state.currentScreen = screen;
    var app = document.getElementById('app');
    var valid = ['dashboard', 'analytics', 'create', 'settings'];
    if (!this.shellRendered_) {
      app.innerHTML = this.renderShell(screen);
      this.shellRendered_ = true;
      this.bindNavEvents();
    }

    var contentEl = document.getElementById('content');
    if (contentEl) {
      contentEl.innerHTML = this.renderScreenContent(screen);
      contentEl.classList.add('screen-animate');
      var onAnimEnd = function() {
        contentEl.classList.remove('screen-animate');
        contentEl.removeEventListener('animationend', onAnimEnd);
      };
      contentEl.addEventListener('animationend', onAnimEnd);
    }

    document.querySelectorAll('.nav-item').forEach(function(item) {
      item.classList.toggle('active', item.getAttribute('data-screen') === screen);
    });
    if (this.refreshNavLock_) this.refreshNavLock_();

    if (this.initSwipeNav_) this.initSwipeNav_();
    switch (screen) {
      case 'dashboard':
        this.loadDashboard();
        break;
      case 'analytics':
        this.loadAnalytics();
        break;
      case 'create':
        this.loadCreate();
        break;
      case 'settings':
        this.bindSettingsEvents();
        break;
      default:
        if (contentEl) contentEl.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
    }

    if (valid.indexOf(screen) !== -1) {
      this.bindTipsEvents();
    }
  }
};

// === デモモード ===

App.startDemoMode = function() {
  this.state.demoMode = true;
  this.state.user = { username: 'demo_user', profilePicUrl: '' };
  this.state.activeAccount = { accountId: 'demo', username: 'demo_user', profilePicUrl: '' };
  this.state.settings = { app_id: 'demo', hasAppSecret: true, hasAccessToken: true, hasGeminiKey: true };
  this.state.accounts = [{ accountId: 'demo', username: 'demo_user' }];
  sessionStorage.setItem('insightmaster_demo', '1');
  this.showScreen('dashboard');
};

App.demoApi_ = function(action, params) {
  var self = this;
  return new Promise(function(resolve) {
    setTimeout(function() {
      resolve(self.demoData_(action, params));
    }, 300 + Math.random() * 500);
  });
};

App.demoData_ = function(action, params) {
  var now = new Date();
  switch (action) {
    case 'fetchUserInsights':
      return {
        accountUsername: 'demo_user',
        views: 12450, followersCount: 1823, likes: 487,
        replies: 63, reposts: 28, quotes: 12, clicks: 95,
        demographics: {
          country: { '日本': 1520, 'アメリカ': 142, 'タイ': 38, '台湾': 31, 'その他': 92 },
          city: { '東京': 680, '大阪': 310, '名古屋': 125, '福岡': 98, '札幌': 72 },
          age: { '18-24': 210, '25-34': 580, '35-44': 620, '45-54': 290, '55-64': 88, '65+': 35 },
          gender: { 'M': 1050, 'F': 680, 'U': 93 }
        }
      };

    case 'getAnalyticsData':
      var demoPosts = [];
      for (var i = 0; i < 25; i++) {
        var d = new Date(now.getTime() - i * 24 * 3600 * 1000);
        var er = Math.round((Math.random() * 8 + 0.5) * 100) / 100;
        var views = Math.floor(Math.random() * 3000 + 200);
        var likes = Math.floor(views * er / 100 * 0.7);
        demoPosts.push({
          postId: 'demo_' + i, text: ['朝活で生産性3倍に！','AIツール5選まとめ','フォロワー1000人達成の裏側','週末の過ごし方で人生変わる','読書習慣のつくり方','副業で月5万稼ぐ方法','Threads運用のコツ','モチベーション維持法','時間管理術','SNSマーケティング入門','継続のコツは仕組み化','朝の5分ルーティン','失敗から学んだ3つのこと','ChatGPTの活用術','ミニマリスト生活のすすめ','集中力を高める食事','睡眠の質を上げる方法','投資初心者ガイド','英語学習のロードマップ','メンタルヘルスの大切さ','プログラミング独学法','転職成功のポイント','人間関係の整理術','健康習慣まとめ','目標設定のフレームワーク'][i],
          mediaType: i % 3 === 0 ? 'IMAGE' : 'TEXT',
          timestamp: d.toISOString(), views: views, likes: likes,
          replies: Math.floor(likes * 0.3), reposts: Math.floor(likes * 0.15),
          quotes: Math.floor(likes * 0.05), engagementRate: er,
          permalink: 'https://www.threads.net/@demo_user/post/' + i
        });
      }
      demoPosts.sort(function(a, b) { return b.engagementRate - a.engagementRate; });
      var totalV = 0, totalL = 0, totalR = 0, totalRp = 0, totalQ = 0;
      demoPosts.forEach(function(p) { totalV += p.views; totalL += p.likes; totalR += p.replies; totalRp += p.reposts; totalQ += p.quotes; });
      var avgEr = totalV > 0 ? Math.round((totalL + totalR + totalRp + totalQ) / totalV * 10000) / 100 : 0;
      return {
        posts: demoPosts,
        summary: { totalPosts: demoPosts.length, totalViews: totalV, totalLikes: totalL, totalReplies: totalR, totalReposts: totalRp, totalQuotes: totalQ, totalShares: 0, avgEngagementRate: avgEr }
      };

    case 'getFollowerHistory':
      var days = (params && params.days) || 7;
      var dates = [], counts = [], changes = [];
      var base = 1780;
      for (var i = days - 1; i >= 0; i--) {
        var d = new Date(now.getTime() - i * 24 * 3600 * 1000);
        dates.push((d.getMonth() + 1) + '/' + d.getDate());
        var change = Math.floor(Math.random() * 12 - 2);
        base += change;
        counts.push(base);
        changes.push(change);
      }
      return { dates: dates, counts: counts, changes: changes };

    case 'getTimeAnalysisData':
      var days = ['日曜','月曜','火曜','水曜','木曜','金曜','土曜'];
      var matrix = {};
      days.forEach(function(day) {
        matrix[day] = {};
        for (var h = 0; h < 24; h++) {
          var val = 0;
          if (h >= 7 && h <= 9) val = Math.random() * 4 + 1;
          else if (h >= 12 && h <= 13) val = Math.random() * 3 + 1;
          else if (h >= 20 && h <= 23) val = Math.random() * 6 + 2;
          else if (h >= 6 && h <= 22) val = Math.random() * 2;
          matrix[day][h] = Math.round(val * 100) / 100;
        }
      });
      return { matrix: matrix, hasData: true };

    case 'generateBuzzReport':
      return {
        stats: {
          avgER: { top: 6.8, bottom: 0.9 }, avgLength: { top: 85, bottom: 32 },
          bestHour: 21, bestDay: '水', avgHour: { top: 20, bottom: 14 },
          mediaRate: { top: 60, bottom: 10 }, questionRate: { top: 50, bottom: 10 },
          hashtagRate: { top: 30, bottom: 5 }, avgHashtags: { top: 1.5, bottom: 0.2 },
          hookLength: { top: 22, bottom: 8 }, avgEngagement: { top: 145, bottom: 12 },
          avgViews: { top: 2800, bottom: 450 }
        },
        topPosts: [
          { text: '朝活で生産性3倍に！実践して1ヶ月の結果を公開します', er: 8.5, likes: 120, views: 2800, hour: 6, day: '月', permalink: '' },
          { text: 'AIツール5選まとめ。全部無料で使えます', er: 7.2, likes: 95, views: 2200, hour: 21, day: '水', permalink: '' },
          { text: 'フォロワー1000人達成！やったことを全公開', er: 6.1, likes: 80, views: 1900, hour: 20, day: '金', permalink: '' }
        ],
        bottomPosts: [{ text: 'おはよう', er: 0.3 }, { text: 'ランチ', er: 0.5 }],
        sampleSize: 25, topN: 5, days: params.days || 30, message: null,
        aiReport: '## 📊 バズパターン分析レポート\n\n### 発見された成功パターン\n1. **具体的な数字を含む投稿**がER 6%超え（例: 「3倍」「5選」「1000人」）\n2. **朝6時台と夜21時台**の投稿が高パフォーマンス\n3. **画像付き投稿**のERはテキストのみの約3倍\n4. **「まとめ」「公開」「方法」**がフック語として有効\n\n### 💡 改善アクション\n1. 投稿文字数を80-100字に調整（現在の上位平均: 85字）\n2. 水・金の21時投稿を週2回ルーティン化\n3. 質問形式「〜していますか？」を冒頭に使う\n\n### 🎯 おすすめテーマ3選\n1. 「AI × 副業」の実践レポート\n2. 「朝活ルーティン」のビフォーアフター\n3. 「フォロワー増加テクニック」数値付き\n\n### ⚠️ 避けるべきパターン\n- 短すぎる投稿（30字未満はER 1%以下）\n- 14時台の投稿（エンゲージメント最低時間帯）'
      };

    case 'generateTimeAnalysis':
      return { success: true };
    case 'fetchAndStorePostAnalytics':
      return { success: true, total: 25, newPosts: 3, updatedPosts: 22, accountUsername: 'demo_user' };
    case 'getWeeklyReportList':
      return [];
    case 'generateWeeklyReport':
      return {
        weekStart: new Date(now.getTime() - 7 * 24 * 3600 * 1000).toISOString().slice(0, 10),
        weekEnd: now.toISOString().slice(0, 10),
        followers: { start: 1780, end: 1823, change: 43 },
        summary: { totalPosts: 12, totalViews: 12450, totalLikes: 487, totalReplies: 63, totalReposts: 28, avgEngagementRate: 4.2 },
        topPosts: [
          { text: '朝活で生産性3倍に！', er: 8.5, likes: 120, views: 2800 },
          { text: 'AIツール5選まとめ', er: 7.2, likes: 95, views: 2200 }
        ],
        aiSummary: '今週はER 4.2%と好調。特に朝活・AI関連の投稿が高反応。フォロワーも+43と順調に成長中。来週は画像付き投稿を増やすとさらに伸びる見込み。'
      };
    case 'setupFollowerTrigger':
    case 'setupWeeklyTrigger':
      return { success: true, message: 'デモモードではトリガーは設定されません' };
    case 'getCompetitors':
      return [];
    case 'getWatchPosts':
      return [];
    case 'generateAnalysisReport':
      return { report: '## 📊 分析レポート（デモ）\n\n直近30日間の投稿パフォーマンスを分析しました。\n\n### 主要指標\n- 平均ER: **4.2%**（業界平均2.1%の約2倍）\n- 最も反応が良い時間帯: **21時台**\n- 最も反応が良い曜日: **水曜日**\n\n### 強み\n- 具体的な数字を含む投稿のERが高い\n- 朝活・生産性テーマとの相性が良い\n\n### 改善点\n- 週末の投稿頻度を上げる\n- 動画コンテンツの導入を検討' };
    case 'generateImprovementSuggestions':
      return { suggestions: '## 💡 改善提案（デモ）\n\n1. **投稿頻度を週5→7に**\n   毎日投稿することでアルゴリズム評価が上がります\n\n2. **画像を積極活用**\n   現在の画像使用率30%を60%に引き上げましょう\n\n3. **質問で終わる投稿を増やす**\n   「皆さんはどうしていますか？」で返信率+40%\n\n4. **投稿時間を21時に統一**\n   分析データから最もERが高い時間帯です\n\n5. **シリーズ投稿の導入**\n   「朝活Day 1/30」のような継続コンテンツが有効' };
    case 'generatePostWithAI':

      return { results: [
        { text: '朝5時起き30日チャレンジの結果。\n\n・集中力が段違い\n・午前中に1日分の仕事が終わる\n・夜の睡眠の質が爆上がり\n\n最初の1週間はキツかった。でも2週目から体が慣れて、3週目には「なんで今までやらなかったんだろう」って思えた。\n\nコツは「起きる時間」じゃなく「寝る時間」を決めること。', score: 82 },
        { text: '「忙しい」が口癖の人へ。\n\n忙しいんじゃなくて、優先順位がつけられていないだけ。\n\n本当に大事なことは3つだけ。それ以外は「やらない」と決める勇気が、人生を変える。', score: 78 },
        { text: '読書を習慣にしたいなら、まず「1日1ページ」から。\n\n1ページ読んだら自分を褒める。\n2ページ読めたらボーナス。\n\n気づいたら30分読んでた、が理想の流れ。\n\nハードルは限界まで下げるのが継続のコツです。', score: 75 }
      ] };
    case 'generatePostWithAnalysis':
      return { results: [
        { text: '【データで判明】伸びる投稿の共通点3つ\n\n① 1行目で「え？」と思わせる\n② 具体的な数字が入っている\n③ 最後に問いかけがある\n\n300投稿を分析して見えたパターンです。\n\nあなたの投稿、この3つ満たしてますか？', score: 88, analysisNote: 'ER上位投稿の特徴（質問形式+数字）を反映' },
        { text: '毎朝5時に投稿し続けて3ヶ月。フォロワー0→1,000人になった。\n\nやったことは3つだけ：\n・毎日投稿（休まない）\n・分析を見て改善\n・伸びた投稿の型を横展開\n\n特別な才能は不要。データと継続が全て。', score: 85, analysisNote: '21時台投稿のER平均が最も高いデータを活用' }
      ] };
    case 'refinePostWithAI':
      return { refined: '【リファイン例】\n\n元の投稿をより魅力的にブラッシュアップしました。\n\n✅ フックを強化（冒頭で興味を引く）\n✅ 具体的な数字を追加\n✅ 最後に問いかけを追加\n\n※ デモモードのため実際のAIリファインは設定完了後にご利用いただけます。' };
    case 'saveDraft':
    case 'deleteDraft':
      return { message: '削除しました（デモ）' };
    case 'toggleDraftStatus':
      return { message: 'ステータスを変更しました（デモ）' };
      return { message: '下書きを保存しました（デモ）' };
    case 'getDrafts':
      return [
        { id: 'demo1', text: '朝5時起き30日チャレンジの結果。集中力が段違い。午前中に1日分の仕事が終わる。', status: 'draft', createdAt: new Date(Date.now() - 86400000).toISOString(), tags: 'AI生成' },
        { id: 'demo2', text: '「忙しい」が口癖の人へ。忙しいんじゃなくて、優先順位がつけられていないだけ。', status: 'posted', createdAt: new Date(Date.now() - 172800000).toISOString(), tags: '分析ベース' },
        { id: 'demo3', text: '読書を習慣にしたいなら、まず「1日1ページ」から。ハードルは限界まで下げるのが継続のコツ。', status: 'draft', createdAt: new Date(Date.now() - 259200000).toISOString(), tags: '' }
      ];
    case 'searchKeyword':
      return { results: [], message: 'デモモードではキーワード検索は利用できません。セットアップ完了後にご利用いただけます。' };
      return [];
    case 'calculateGrowthScore':
    case 'getGrowthScore':
      return { current: 72, previous: 65, change: 7, breakdown: { follower: 18, erTrend: 20, frequency: 17, aiUsage: 17 }, updatedAt: new Date().toISOString() };

    case 'dailyCheckIn':
      var streakDay = parseInt(sessionStorage.getItem('demo_streak') || '0') + 1;
      sessionStorage.setItem('demo_streak', String(streakDay));
      var demoMessages = [
        '今日は21時台の投稿が狙い目！「AIツール」系のテーマがおすすめ。',
        '朝7時台の投稿でER 5%超えを狙いましょう！',
        '水曜日は「まとめ系」投稿がバズりやすい傾向があります。',
        '質問で終わる投稿は返信率が40%アップします！',
        'フォロワーとの対話を意識した投稿をしてみましょう。'
      ];
      return { streak: streakDay, todayMessage: demoMessages[Math.floor(Math.random() * demoMessages.length)], recommendedTime: '21:00', recommendedTheme: 'AIツール活用術', checkedIn: true, alreadyCheckedIn: false };

    case 'getGoals':
      return [{ id: 'demo_g1', type: 'follower_increase', label: '今月の目標: フォロワー+100', target: 100, current: 43, percentage: 43, achieved: false, createdAt: '2026-02-01' }];

    case 'setGoal':
      return { success: true, id: 'demo_g_new', message: '目標を設定しました！（デモ）' };

    case 'deleteGoal':
      return { success: true, message: '目標を削除しました（デモ）' };

    case 'setupWeeklySummaryEmail':
      return { success: true, message: 'デモモードではメールトリガーは設定されません' };

    case 'getSettings':
      return this.state.settings;
    case 'getUserProfile':
      return { user: this.state.user };
    case 'getAccounts':
      return this.state.accounts;
    case 'getActiveAccount':
      return this.state.activeAccount;
    default:
      return {};
  }
};

</script>

