<script>
// ============================================
// screen_keywords.html â€” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ç”»é¢
// ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œãƒ»è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«åˆ†æã‚¿ãƒ–ä»˜ã
// ============================================

App.renderKeywordsContent = function() {
  var history = this.state.searchHistory || [];
  var html = '<div class="keywords-screen">';

  html += this.renderTips([
    { title: 'ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã®æ´»ç”¨æ³•', body: 'ãƒˆãƒ¬ãƒ³ãƒ‰ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿ã‚’å‚è€ƒã«ã—ã¾ã—ã‚‡ã†ã€‚äººæ°—æŠ•ç¨¿ã®æ–‡ä½“ãƒ»çµµæ–‡å­—ã®ä½¿ã„æ–¹ãƒ»ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ãƒã‚§ãƒƒã‚¯ã€‚' },
    { title: 'ğŸ‘¤ æŠ•ç¨¿è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆç«¶åˆåˆ†æï¼‰', body: 'ã€Œè©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€ã®æŠ•ç¨¿è€…æ¬„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿ã®ã¿çµã‚Šè¾¼ã‚ã¾ã™ã€‚ç«¶åˆåˆ†æã«æ´»ç”¨ã§ãã¾ã™ã€‚' },
    { title: 'ğŸ“Š ã‚¹ã‚¿ã‚¤ãƒ«åˆ†æã‚¿ãƒ–', body: 'æ¤œç´¢çµæœã®ã€Œã‚¹ã‚¿ã‚¤ãƒ«åˆ†æã€ã‚¿ãƒ–ã§ã¯ã€ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—ãƒ»æŠ•ç¨¿æ™‚é–“å¸¯ãƒ»æ–‡å­—æ•°ã®å‚¾å‘ã‚’è‡ªå‹•åˆ†æã—ã¾ã™ã€‚ãƒã‚ºã‚‹æŠ•ç¨¿ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€‚' },
    { title: 'ğŸ¤– æ¤œç´¢ â†’ AIåˆ†æã®æ´»ç”¨', body: 'æ¤œç´¢ã§è¦‹ã¤ã‘ãŸè‰¯ã„æŠ•ç¨¿ã®ãƒ†ãƒ¼ãƒã‚„ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã€AIç”Ÿæˆã®ãƒ†ãƒ¼ãƒå…¥åŠ›ã«æ´»ã‹ã—ã¾ã—ã‚‡ã†ã€‚' }
  ]);

  // æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ 
  html += '<div class="card">';
  html += '<h3 style="margin:0 0 14px;">ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</h3>';
  html += '<div class="btn-group mb-12">';
  html += '<input type="text" id="kw-input" class="input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›â€¦" style="flex:1;" onkeydown="if(event.key===\'Enter\')App.kwExecuteSearch()">';
  html += '<button onclick="App.kwExecuteSearch()" class="btn btn-primary" style="white-space:nowrap;padding:10px 20px;">æ¤œç´¢</button>';
  html += '</div>';

  // åŸºæœ¬ã‚ªãƒ—ã‚·ãƒ§ãƒ³
  html += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;">';
  html += '<select id="kw-search-type" class="input" style="flex:1;min-width:100px;padding:8px 12px;font-size:13px;">';
  html += '<option value="TOP">äººæ°—é †</option><option value="RECENT">æ–°ç€é †</option></select>';
  html += '<select id="kw-search-mode" class="input" style="flex:1;min-width:100px;padding:8px 12px;font-size:13px;">';
  html += '<option value="KEYWORD">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</option><option value="TAG">ãƒˆãƒ”ãƒƒã‚¯ã‚¿ã‚°</option></select>';
  html += '<select id="kw-media-type" class="input" style="flex:1;min-width:100px;padding:8px 12px;font-size:13px;">';
  html += '<option value="">å…¨ãƒ¡ãƒ‡ã‚£ã‚¢</option><option value="TEXT">ãƒ†ã‚­ã‚¹ãƒˆ</option><option value="IMAGE">ç”»åƒ</option><option value="VIDEO">å‹•ç”»</option></select>';
  html += '</div>';

  // è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  html += '<details id="kw-advanced" style="margin-bottom:14px;">';
  html += '<summary style="cursor:pointer;font-size:13px;font-weight:600;color:var(--text-secondary);user-select:none;">â–¶ è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</summary>';
  html += '<div style="margin-top:10px;display:flex;flex-direction:column;gap:10px;">';
  html += '<div style="display:flex;gap:8px;align-items:center;"><label style="font-size:13px;min-width:72px;color:var(--text-secondary);">æŠ•ç¨¿è€…</label>';
  html += '<input type="text" id="kw-author" class="input" placeholder="usernameï¼ˆ@ãªã—ï¼‰" style="flex:1;padding:8px 12px;font-size:13px;"></div>';
  html += '<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;"><label style="font-size:13px;min-width:72px;color:var(--text-secondary);">æœŸé–“</label>';
  html += '<input type="date" id="kw-since" class="input" style="flex:1;min-width:110px;padding:8px 12px;font-size:13px;">';
  html += '<span style="color:var(--text-secondary);">ã€œ</span>';
  html += '<input type="date" id="kw-until" class="input" style="flex:1;min-width:110px;padding:8px 12px;font-size:13px;"></div>';
  html += '<div style="display:flex;gap:8px;align-items:center;"><label style="font-size:13px;min-width:72px;color:var(--text-secondary);">å–å¾—ä»¶æ•°</label>';
  html += '<select id="kw-limit" class="input" style="flex:1;padding:8px 12px;font-size:13px;">';
  html += '<option value="25">25ä»¶</option><option value="50">50ä»¶</option><option value="100">100ä»¶ï¼ˆæœ€å¤§ï¼‰</option></select></div>';
  html += '</div></details>';

  // æ¤œç´¢å±¥æ­´
  if (history.length > 0) {
    html += '<div style="margin-top:4px;">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">';
    html += '<span class="text-caption">æœ€è¿‘ã®æ¤œç´¢</span>';
    html += '<button onclick="App.kwClearHistory()" style="font-size:11px;color:var(--text-secondary);background:none;border:none;cursor:pointer;text-decoration:underline;">ã‚¯ãƒªã‚¢</button></div>';
    html += '<div style="display:flex;flex-wrap:wrap;gap:6px;">';
    for (var i = 0; i < history.length; i++) {
      var safeKw = this.escapeAttr(history[i].keyword);
      var modeIcon = history[i].searchMode === 'TAG' ? 'ğŸ·ï¸' : 'ğŸ”¤';
      html += '<span onclick="App.kwHistorySearch(\'' + safeKw + '\')" style="display:inline-flex;align-items:center;gap:4px;padding:4px 12px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:20px;font-size:12px;cursor:pointer;color:var(--text-primary);transition:background 0.2s;">';
      html += modeIcon + ' ' + this.escapeHtml(history[i].keyword);
      html += '<span style="color:var(--text-secondary);font-size:10px;margin-left:2px;">(' + (history[i].resultCount || 0) + ')</span></span>';
    }
    html += '</div></div>';
  }

  html += '</div>';
  html += '<div id="kw-results"></div>';
  html += '</div>';
  return html;
};

// ============================================
// åˆæœŸåŒ–
// ============================================
App.loadKeywords = function() {
  var self = this;
  this.api('getSearchHistory', {})
    .then(function(data) {
      self.state.searchHistory = Array.isArray(data) ? data : [];
      var panel = document.getElementById('create-tab-search');
      if (panel) panel.innerHTML = self.renderKeywordsContent();
      self.bindTipsEvents();
    })
    .catch(function() { self.state.searchHistory = []; });
};

App.kwHistorySearch = function(keyword) {
  var input = document.getElementById('kw-input');
  if (input) { input.value = keyword; this.kwExecuteSearch(); }
};

App.kwClearHistory = function() {
  if (!confirm('æ¤œç´¢å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
  var self = this;
  this.api('clearSearchHistory', {}).then(function() {
    self.state.searchHistory = [];
    self.showToast('æ¤œç´¢å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
    var panel = document.getElementById('create-tab-search');
    if (panel) panel.innerHTML = self.renderKeywordsContent();
    self.bindTipsEvents();
  }).catch(function(err) { self.showToast('ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); });
};

// ============================================
// æ¤œç´¢å®Ÿè¡Œ
// ============================================
App.kwExecuteSearch = function() {
  var input = document.getElementById('kw-input');
  var keyword = input ? input.value.trim() : '';
  if (!keyword) { this.showToast('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }

  var params = {
    keyword: keyword,
    searchType: (document.getElementById('kw-search-type') || {}).value || 'TOP',
    searchMode: (document.getElementById('kw-search-mode') || {}).value || 'KEYWORD',
    mediaType: (document.getElementById('kw-media-type') || {}).value || '',
    limit: parseInt((document.getElementById('kw-limit') || {}).value) || 25
  };

  var author = document.getElementById('kw-author');
  if (author && author.value.trim()) params.authorUsername = author.value.trim().replace(/^@/, '');

  var sinceEl = document.getElementById('kw-since');
  if (sinceEl && sinceEl.value) {
    var sd = new Date(sinceEl.value); sd.setHours(0,0,0,0);
    params.since = Math.floor(sd.getTime() / 1000);
  }
  var untilEl = document.getElementById('kw-until');
  if (untilEl && untilEl.value) {
    var ud = new Date(untilEl.value); ud.setHours(23,59,59,999);
    params.until = Math.floor(ud.getTime() / 1000);
  }

  var resultsDiv = document.getElementById('kw-results');
  if (resultsDiv) {
      resultsDiv.innerHTML = '<div class="ai-result-box text-center">' +
      '<div class="loading-spinner" style="margin:0 auto 12px;"></div>' +
      '<div style="color:var(--text-secondary);">ã€Œ' + this.escapeHtml(keyword) + 'ã€ã‚’æ¤œç´¢ä¸­â€¦</div></div>';
  }

  var self = this;
  this.api('searchKeyword', params).then(function(data) {
    self.state.kwLastResult = data;
    if (data.source === 'gemini_fallback') self.kwRenderGeminiFallback_(data, keyword);
    else self.kwRenderThreadsResults_(data, keyword);

    // ãƒ­ãƒ¼ã‚«ãƒ«å±¥æ­´æ›´æ–°
    self.state.searchHistory = self.state.searchHistory || [];
    var found = false;
    for (var i = 0; i < self.state.searchHistory.length; i++) {
      if (self.state.searchHistory[i].keyword === keyword) {
        self.state.searchHistory[i].resultCount = data.totalCount || 0;
        found = true; break;
      }
    }
    if (!found) {
      self.state.searchHistory.unshift({ keyword: keyword, searchMode: data.searchMode || 'KEYWORD', resultCount: data.totalCount || 0, searchedAt: new Date().toISOString() });
      if (self.state.searchHistory.length > 20) self.state.searchHistory.pop();
    }
  }).catch(function(err) {
    if (resultsDiv) {
      resultsDiv.innerHTML = '<div class="ai-result-box text-center">' +
        '<div style="font-size:32px;margin-bottom:8px;">âŒ</div>' +
        '<div style="color:#e74c3c;white-space:pre-wrap;">' + self.escapeHtml(err.message) + '</div></div>';
    }
  });
};

// ============================================
// Threads API çµæœè¡¨ç¤º
// ============================================
App.kwRenderThreadsResults_ = function(data, keyword) {
  var resultsDiv = document.getElementById('kw-results');
  if (!resultsDiv) return;
  var posts = data.posts || [];
  var analysis = data.styleAnalysis || {};
  var html = '';

  if (posts.length === 0) {
    html += '<div class="card" style="text-align:center;padding:30px;"><div style="font-size:32px;margin-bottom:8px;">ğŸ“­</div>';
    html += '<div style="color:var(--text-secondary);">ã€Œ' + this.escapeHtml(keyword) + 'ã€ã®æ¤œç´¢çµæœã¯ã‚ã‚Šã¾ã›ã‚“</div></div>';
    resultsDiv.innerHTML = html; return;
  }

  // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰
  html += '<div class="card">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">';
  html += '<h3 style="margin:0;">ğŸ” ã€Œ' + this.escapeHtml(keyword) + 'ã€ã®çµæœ</h3>';
  html += '<span class="text-caption">' + posts.length + 'ä»¶</span></div>';

  // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚°ãƒªãƒƒãƒ‰
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(70px,1fr));gap:8px;margin-bottom:14px;">';
  var mediaLabels = { TEXT: 'ğŸ“', IMAGE: 'ğŸ–¼ï¸', VIDEO: 'ğŸ¬', CAROUSEL_ALBUM: 'ğŸ“¸' };
  var mb = analysis.mediaBreakdown || {};
  for (var mtype in mb) {
    if (mb[mtype] > 0) {
      html += '<div style="text-align:center;padding:8px;background:var(--bg-tertiary);border-radius:8px;">';
      html += '<div style="font-size:16px;">' + (mediaLabels[mtype] || 'ğŸ“„') + '</div>';
      html += '<div style="font-size:16px;font-weight:bold;">' + mb[mtype] + '</div>';
      html += '<div style="font-size:10px;color:var(--text-secondary);">' + mtype + '</div></div>';
    }
  }
  if (analysis.avgTextLength) {
    html += '<div style="text-align:center;padding:8px;background:var(--bg-tertiary);border-radius:8px;">';
    html += '<div style="font-size:16px;">ğŸ“</div><div style="font-size:16px;font-weight:bold;">' + analysis.avgTextLength + '</div>';
    html += '<div style="font-size:10px;color:var(--text-secondary);">å¹³å‡æ–‡å­—æ•°</div></div>';
  }
  html += '</div>';

  // AIåˆ†æãƒœã‚¿ãƒ³
  html += '<div style="text-align:center;"><button id="kw-ai-btn" onclick="App.kwRunAIAnalysis()" style="padding:8px 24px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;font-size:13px;cursor:pointer;font-weight:600;">ğŸ¤– AIãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ</button></div>';
  html += '<div id="kw-ai-result"></div></div>';

  // ã‚¿ãƒ–
  html += '<div class="card" style="padding:0;overflow:hidden;">';
  html += '<div style="display:flex;border-bottom:1px solid var(--border-color);">';
  html += '<button class="kw-tab active" data-kw-tab="posts" style="flex:1;padding:12px;background:none;border:none;font-weight:600;cursor:pointer;border-bottom:2px solid var(--accent-color);color:var(--text-primary);font-size:13px;">ğŸ“‹ æŠ•ç¨¿ä¸€è¦§ (' + posts.length + ')</button>';
  html += '<button class="kw-tab" data-kw-tab="style" style="flex:1;padding:12px;background:none;border:none;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;color:var(--text-secondary);font-size:13px;">ğŸ“Š ã‚¹ã‚¿ã‚¤ãƒ«åˆ†æ</button>';
  html += '</div>';

  html += '<div id="kw-tab-posts" style="padding:12px;">';
  for (var p = 0; p < posts.length; p++) html += this.kwPostCard_(posts[p], p + 1);
  html += '</div>';

  html += '<div id="kw-tab-style" style="padding:16px;display:none;">';
  html += this.kwRenderStyleAnalysis_(analysis, posts);
  html += '</div></div>';

  resultsDiv.innerHTML = html;
  this.kwBindTabEvents_();
  this.kwBindCopyEvents_();
};

// ============================================
// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// ============================================
App.kwBindTabEvents_ = function() {
  var tabs = document.querySelectorAll('.kw-tab');
  tabs.forEach(function(tab) {
    tab.addEventListener('click', function() {
      var target = this.getAttribute('data-kw-tab');
      tabs.forEach(function(t) {
        t.classList.remove('active');
        t.style.borderBottomColor = 'transparent';
        t.style.color = 'var(--text-secondary)';
      });
      this.classList.add('active');
      this.style.borderBottomColor = 'var(--accent-color)';
      this.style.color = 'var(--text-primary)';
      ['posts', 'style'].forEach(function(id) {
        var el = document.getElementById('kw-tab-' + id);
        if (el) el.style.display = (id === target) ? 'block' : 'none';
      });
    });
  });
};

// ============================================
// ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ä¸€æ‹¬ãƒã‚¤ãƒ³ãƒ‰ï¼ˆXSSå®‰å…¨ï¼‰
// ============================================
App.kwBindCopyEvents_ = function() {
  var self = this;
  document.querySelectorAll('[data-kw-copy]').forEach(function(btn) {
    if (btn.dataset.bound) return;
    btn.dataset.bound = 'true';
    btn.addEventListener('click', function() {
      self.copyToClipboard(this.getAttribute('data-kw-copy'));
    });
  });
};

// ============================================
// ã‚¹ã‚¿ã‚¤ãƒ«åˆ†æã‚¿ãƒ–
// ============================================
App.kwRenderStyleAnalysis_ = function(analysis, posts) {
  if (!analysis || !analysis.totalPosts) return '<div style="text-align:center;color:var(--text-secondary);padding:20px;">åˆ†æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  var html = '';
  var total = analysis.totalPosts;

  // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—å†…è¨³
  html += '<div style="margin-bottom:24px;"><h4 style="margin:0 0 10px;font-size:14px;">ğŸ“¸ ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—å†…è¨³</h4>';
  var mediaColors = { TEXT: '#667eea', IMAGE: '#27ae60', VIDEO: '#e74c3c', CAROUSEL_ALBUM: '#f39c12' };
  var mediaNames = { TEXT: 'ãƒ†ã‚­ã‚¹ãƒˆ', IMAGE: 'ç”»åƒ', VIDEO: 'å‹•ç”»', CAROUSEL_ALBUM: 'ã‚«ãƒ«ãƒ¼ã‚»ãƒ«' };
  var mb = analysis.mediaBreakdown || {};
  for (var mt in mb) {
    var pct = total > 0 ? Math.round((mb[mt] / total) * 100) : 0;
    html += '<div style="margin-bottom:6px;"><div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:2px;">';
    html += '<span>' + (mediaNames[mt] || mt) + '</span><span style="color:var(--text-secondary);">' + mb[mt] + 'ä»¶ (' + pct + '%)</span></div>';
    html += '<div style="height:8px;background:var(--bg-tertiary);border-radius:4px;overflow:hidden;">';
    html += '<div style="height:100%;width:' + pct + '%;background:' + (mediaColors[mt] || '#999') + ';border-radius:4px;transition:width 0.5s;"></div></div></div>';
  }
  html += '</div>';

  // æ–‡å­—æ•°åˆ†å¸ƒ
  html += '<div style="margin-bottom:24px;"><h4 style="margin:0 0 10px;font-size:14px;">ğŸ“ æ–‡å­—æ•°åˆ†å¸ƒ</h4>';
  var buckets = analysis.textLengthBuckets || {};
  var bDefs = [
    { key: 'short', label: 'çŸ­æ–‡ï¼ˆã€œ50å­—ï¼‰', color: '#667eea' },
    { key: 'medium', label: 'ä¸­æ–‡ï¼ˆ51ã€œ150å­—ï¼‰', color: '#27ae60' },
    { key: 'long', label: 'é•·æ–‡ï¼ˆ151ã€œ300å­—ï¼‰', color: '#f39c12' },
    { key: 'verylong', label: 'è¶…é•·æ–‡ï¼ˆ301å­—ã€œï¼‰', color: '#e74c3c' }
  ];
  for (var b = 0; b < bDefs.length; b++) {
    var bd = bDefs[b], cnt = buckets[bd.key] || 0, bpct = total > 0 ? Math.round((cnt / total) * 100) : 0;
    html += '<div style="margin-bottom:6px;"><div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:2px;">';
    html += '<span>' + bd.label + '</span><span style="color:var(--text-secondary);">' + cnt + 'ä»¶ (' + bpct + '%)</span></div>';
    html += '<div style="height:8px;background:var(--bg-tertiary);border-radius:4px;overflow:hidden;">';
    html += '<div style="height:100%;width:' + bpct + '%;background:' + bd.color + ';border-radius:4px;"></div></div></div>';
  }
  html += '<div style="font-size:12px;color:var(--text-secondary);margin-top:6px;">å¹³å‡æ–‡å­—æ•°: <strong>' + (analysis.avgTextLength || 0) + 'å­—</strong></div></div>';

  // æŠ•ç¨¿æ™‚é–“å¸¯
  html += '<div style="margin-bottom:24px;"><h4 style="margin:0 0 10px;font-size:14px;">ğŸ• æŠ•ç¨¿æ™‚é–“å¸¯ï¼ˆJSTï¼‰</h4>';
  var hd = analysis.hourDistribution || {};
  var maxH = 0;
  for (var h = 0; h < 24; h++) { if ((hd[h] || 0) > maxH) maxH = hd[h]; }
  html += '<div style="display:flex;align-items:flex-end;gap:2px;height:80px;">';
  for (var h2 = 0; h2 < 24; h2++) {
    var hVal = hd[h2] || 0, hPct = maxH > 0 ? Math.round((hVal / maxH) * 100) : 0;
    var barColor = hVal === maxH && maxH > 0 ? '#e74c3c' : (hPct >= 60 ? '#f39c12' : '#667eea');
    html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;" title="' + h2 + 'æ™‚: ' + hVal + 'ä»¶">';
    html += '<div style="width:100%;background:' + barColor + ';border-radius:2px 2px 0 0;min-height:2px;height:' + Math.max(hPct, 3) + '%;opacity:' + (hVal > 0 ? '1' : '0.2') + ';"></div></div>';
  }
  html += '</div>';
  html += '<div style="display:flex;gap:2px;margin-top:2px;">';
  for (var h3 = 0; h3 < 24; h3++) html += '<div style="flex:1;text-align:center;font-size:8px;color:var(--text-secondary);">' + (h3 % 3 === 0 ? h3 : '') + '</div>';
  html += '</div>';
  if (maxH > 0) {
    var peaks = [];
    for (var h4 = 0; h4 < 24; h4++) { if ((hd[h4] || 0) === maxH) peaks.push(h4 + 'æ™‚'); }
    html += '<div style="font-size:12px;color:var(--text-secondary);margin-top:8px;">ãƒ”ãƒ¼ã‚¯: <strong style="color:var(--text-primary);">' + peaks.join('ã€') + '</strong>ï¼ˆ' + maxH + 'ä»¶ï¼‰</div>';
  }
  html += '</div>';

  // ãƒˆãƒƒãƒ—æŠ•ç¨¿è€…
  var ta = analysis.topAuthors || [];
  if (ta.length > 0) {
    html += '<div style="margin-bottom:24px;"><h4 style="margin:0 0 10px;font-size:14px;">ğŸ‘¤ ã‚ˆãæŠ•ç¨¿ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼</h4>';
    for (var a = 0; a < ta.length; a++) {
      html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">';
      html += '<span style="font-size:12px;min-width:20px;color:var(--text-secondary);">' + (a + 1) + '.</span>';
      html += '<span style="font-size:13px;font-weight:600;">@' + this.escapeHtml(ta[a].username) + '</span>';
      html += '<span class="text-caption">' + ta[a].count + 'ä»¶</span></div>';
    }
    html += '</div>';
  }

  // è¿”ä¿¡ãƒ»å¼•ç”¨ç‡
  html += '<div><h4 style="margin:0 0 10px;font-size:14px;">ğŸ’¬ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ã®å‚¾å‘</h4>';
  html += '<div style="display:flex;gap:16px;font-size:13px;">';
  html += '<div>è¿”ä¿¡ç‡: <strong>' + (analysis.replyRate || 0) + '%</strong></div>';
  html += '<div>å¼•ç”¨ç‡: <strong>' + (analysis.quoteRate || 0) + '%</strong></div></div></div>';
  return html;
};

// ============================================
// Geminiãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµæœè¡¨ç¤º
// ============================================
App.kwRenderGeminiFallback_ = function(data, keyword) {
  var resultsDiv = document.getElementById('kw-results');
  if (!resultsDiv) return;
  var myPosts = data.myPosts || [], analysis = data.analysis || '';
  var html = '';

  html += '<div class="card" style="background:var(--warning-bg);border-left:4px solid var(--warning-color);">';
  html += '<div style="display:flex;align-items:flex-start;gap:10px;">';
  html += '<span style="font-size:24px;">ğŸ¤–</span><div>';
  html += '<div style="font-weight:700;font-size:14px;">AIåˆ†æãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã—ãŸ</div>';
  html += '<div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">Threads APIãŒä¸€æ™‚åˆ©ç”¨ä¸å¯ã®ãŸã‚ã€Gemini AIãŒã‚ãªãŸã®æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«åˆ†æã—ã¾ã—ãŸ</div>';
  if (data.apiError) html += '<div style="font-size:11px;color:var(--text-secondary);margin-top:4px;opacity:0.7;">APIå¿œç­”: ' + this.escapeHtml(data.apiError) + '</div>';
  html += '</div></div></div>';

  if (analysis) {
    html += '<div class="card"><h3 style="margin:0 0 12px;">ğŸ“Š ã€Œ' + this.escapeHtml(keyword) + 'ã€ã®AIåˆ†æ</h3>';
    html += '<div style="line-height:1.8;font-size:14px;">' + this.formatMarkdown_(analysis) + '</div></div>';
  }

  if (myPosts.length > 0) {
    html += '<div class="card"><h3 style="margin:0 0 8px;">ğŸ“ ã‚ãªãŸã®é–¢é€£æŠ•ç¨¿ (' + myPosts.length + 'ä»¶)</h3>';
    html += '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡é †ã§è¡¨ç¤º</div>';
    for (var i = 0; i < myPosts.length; i++) html += this.kwMyPostCard_(myPosts[i]);
    html += '</div>';
  } else {
    html += '<div class="card" style="text-align:center;padding:24px;"><div class="text-caption">';
    html += 'ã€Œ' + this.escapeHtml(keyword) + 'ã€ã«é–¢é€£ã™ã‚‹ã‚ãªãŸã®æŠ•ç¨¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div></div>';
  }

  resultsDiv.innerHTML = html;
  this.kwBindCopyEvents_();
};

// ============================================
// AIãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
// ============================================
App.kwRunAIAnalysis = function() {
  var aiDiv = document.getElementById('kw-ai-result');
  var aiBtn = document.getElementById('kw-ai-btn');
  if (!aiDiv) return;
  var last = this.state.kwLastResult;
  if (!last || !last.keyword) { this.showToast('æ¤œç´¢ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„', 'error'); return; }
  if (aiBtn) { aiBtn.disabled = true; aiBtn.textContent = 'ğŸ¤– åˆ†æä¸­â€¦'; }
  aiDiv.innerHTML = '<div style="text-align:center;padding:20px;"><div class="loading-spinner" style="margin:0 auto 8px;"></div><div style="color:var(--text-secondary);font-size:13px;">AIãŒåˆ†æä¸­â€¦</div></div>';
  var self = this;
  this.api('analyzeKeywordTrend', { keyword: last.keyword }).then(function(data) {
    aiDiv.innerHTML = '<div style="margin-top:16px;padding-top:16px;border-top:2px solid var(--border-color);"><h4 style="margin:0 0 12px;">ğŸ¤– AIãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æçµæœ</h4><div style="line-height:1.8;font-size:14px;">' + self.formatMarkdown_(data.analysis) + '</div></div>';
    if (aiBtn) { aiBtn.disabled = false; aiBtn.textContent = 'ğŸ¤– AIãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ'; }
  }).catch(function(err) {
    aiDiv.innerHTML = '<div style="text-align:center;padding:12px;color:#e74c3c;">âš ï¸ ' + self.escapeHtml(err.message) + '</div>';
    if (aiBtn) { aiBtn.disabled = false; aiBtn.textContent = 'ğŸ¤– AIãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ'; }
  });
};

// ============================================
// ã‚«ãƒ¼ãƒ‰æç”»ãƒ˜ãƒ«ãƒ‘ãƒ¼
// ============================================
App.kwPostCard_ = function(post, index) {
  var text = post.text || '';
  var displayText = text.length > 250 ? text.substring(0, 250) + 'â€¦' : text;
  var typeIcons = { TEXT: 'ğŸ“', IMAGE: 'ğŸ–¼ï¸', VIDEO: 'ğŸ¬', CAROUSEL_ALBUM: 'ğŸ“¸' };

  var html = '<div style="border:1px solid var(--border-color);border-radius:10px;padding:12px;margin-bottom:8px;">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">';
  html += '<div style="display:flex;align-items:center;gap:6px;">';
  if (index) html += '<span style="font-size:11px;color:var(--text-secondary);min-width:20px;">' + index + '.</span>';
  html += '<span style="font-weight:700;font-size:13px;">@' + this.escapeHtml(post.username || 'unknown') + '</span></div>';
  html += '<span style="font-size:11px;color:var(--text-secondary);">' + this.kwTime_(post.timestamp) + '</span></div>';
  html += '<div style="font-size:13px;line-height:1.6;margin-bottom:8px;word-break:break-word;">' + this.escapeHtml(displayText) + '</div>';
  html += '<div style="display:flex;gap:8px;font-size:11px;color:var(--text-secondary);margin-bottom:8px;flex-wrap:wrap;">';
  html += '<span>' + (typeIcons[post.mediaType] || 'ğŸ“') + ' ' + (post.mediaType || 'TEXT') + '</span>';
  if (post.hasReplies) html += '<span>ğŸ’¬ è¿”ä¿¡ã‚ã‚Š</span>';
  if (post.isQuotePost) html += '<span>ğŸ”– å¼•ç”¨</span>';
  if (post.isReply) html += '<span>â†©ï¸ è¿”ä¿¡</span>';
  if (post.topicTag) html += '<span>ğŸ·ï¸ ' + this.escapeHtml(post.topicTag) + '</span>';
  html += '</div>';
  html += '<div class="btn-group">';
  if (text) html += '<button data-kw-copy="' + this.escapeAttr(text) + '" style="font-size:11px;padding:4px 10px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;cursor:pointer;color:var(--text-primary);">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>';
  if (post.permalink) html += '<a href="' + this.escapeAttr(post.permalink) + '" target="_blank" rel="noopener" style="font-size:11px;padding:4px 10px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;text-decoration:none;color:var(--text-primary);">ğŸ”— é–‹ã</a>';
  html += '</div></div>';
  return html;
};

App.kwMyPostCard_ = function(post) {
  var text = post.text || '';
  var displayText = text.length > 200 ? text.substring(0, 200) + 'â€¦' : text;
  var erColor = (post.engagementRate || 0) >= 5 ? '#27ae60' : ((post.engagementRate || 0) >= 2 ? '#f39c12' : 'var(--text-secondary)');

  var html = '<div style="border:1px solid var(--border-color);border-radius:10px;padding:12px;margin-bottom:8px;">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">';
  html += '<span class="text-caption">' + this.kwTime_(post.timestamp) + '</span>';
  html += '<span style="font-size:12px;font-weight:bold;color:' + erColor + ';">ER: ' + (post.engagementRate || 0).toFixed(1) + '%</span></div>';
  html += '<div style="font-size:13px;line-height:1.6;margin-bottom:8px;word-break:break-word;">' + this.escapeHtml(displayText) + '</div>';
  html += '<div style="display:flex;gap:12px;font-size:12px;color:var(--text-secondary);margin-bottom:8px;flex-wrap:wrap;">';
  if (post.views !== undefined) html += '<span>ğŸ‘ï¸ ' + (post.views || 0).toLocaleString() + '</span>';
  if (post.likes !== undefined) html += '<span>â¤ï¸ ' + (post.likes || 0).toLocaleString() + '</span>';
  if (post.replies !== undefined) html += '<span>ğŸ’¬ ' + (post.replies || 0).toLocaleString() + '</span>';
  if (post.reposts !== undefined) html += '<span>ğŸ”„ ' + (post.reposts || 0).toLocaleString() + '</span>';
  html += '</div>';
  html += '<div class="btn-group">';
  if (text) html += '<button data-kw-copy="' + this.escapeAttr(text) + '" style="font-size:11px;padding:4px 10px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;cursor:pointer;color:var(--text-primary);">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>';
  if (post.permalink) html += '<a href="' + this.escapeAttr(post.permalink) + '" target="_blank" rel="noopener" style="font-size:11px;padding:4px 10px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;text-decoration:none;color:var(--text-primary);">ğŸ”— é–‹ã</a>';
  html += '</div></div>';
  return html;
};

// ============================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ============================================
App.kwMarkdown_ = function(text) {
  return this.formatMarkdown_(text);
};

App.kwInline_ = function(text) {
  text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
  text = text.replace(/`([^`]+)`/g, '<code style="background:var(--bg-tertiary);padding:1px 5px;border-radius:3px;font-size:13px;">$1</code>');
  return text;
};

App.kwTime_ = function(ts) {
  if (!ts) return '';
  try {
    var d = new Date(ts), diff = Date.now() - d.getTime();
    if (diff < 60000) return 'ãŸã£ãŸä»Š';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†å‰';
    if (diff < 86400000) return Math.floor(diff / 3600000) + 'æ™‚é–“å‰';
    if (diff < 604800000) return Math.floor(diff / 86400000) + 'æ—¥å‰';
    return d.getFullYear() + '/' + (d.getMonth() + 1) + '/' + d.getDate();
  } catch (e) { return String(ts); }
};
</script>
