# InsightMaster Phase 5: プロダクション品質化ロードマップ

## 背景
Phase 1-4 で機能実装は概ね完了（機能完成度 9.3/10）。
しかし「動くプロトタイプ」から「人に使ってもらえるプロダクト」への
ギャップが大きい。本フェーズでは品質・体験・拡張性を引き上げる。

## 現実的スコア（厳格評価）
- VC視点: 27/60 (45%)
- シニアエンジニア視点: 25/100
- 最大の弱点: テストゼロ、オンボーディング離脱、スケーラビリティ

---

## Step 5-1: オンボーディング改革（離脱防止）
### 優先度: 最高 / 工数: 中

### 問題
- 初回起動で App ID / App Secret 入力を要求 → 99%が離脱
- セットアップ手順が多すぎる（Meta Developer登録 → アプリ作成 → APIキー取得）

### 解決策
1. **デモモード実装**
   - App ID未設定でも「サンプルデータ」で全画面を体験可能
   - ダッシュボード・分析・AI生成をダミーデータで動作させる
   - 画面上部に「デモモード - 本番データを見るにはセットアップ」バナー表示

2. **ワンクリックセットアップ**
   - スプレッドシートのメニューから「InsightMaster > 初期設定」で起動
   - ステップ数を5→3に削減
   - 各ステップにスクリーンショット付きガイドを埋め込み

3. **プログレッシブ・オンボーディング**
   - 最初はThreads認証だけで使い始められる
   - Gemini APIキーは「AI機能を使いたくなったら」で後回し
   - 競合分析・エクスポートは使い始めてから案内

### 成果指標
- 初回起動→ダッシュボード到達率: 現状推定5% → 目標60%
- セットアップ完了率: 現状推定10% → 目標40%

---

## Step 5-2: エラーハンドリング体系化
### 優先度: 高 / 工数: 中

### 問題
- 全エラーが「処理中にエラーが発生しました」で統一
- ユーザーが何を直せばいいかわからない
- リトライ可能なエラーとそうでないものの区別なし

### 解決策
1. **エラー分類体系**
Copy
AUTH_EXPIRED → 「認証の有効期限が切れました。再認証してください」[再認証ボタン] RATE_LIMITED → 「APIの利用制限です。{N}分後に自動リトライします」[カウントダウン] NETWORK_ERROR → 「通信エラーです」[リトライボタン] SHEET_NOT_FOUND → 「シート'{name}'が見つかりません」[シート作成ボタン] GEMINI_NO_KEY → 「Gemini APIキーが未設定です」[設定画面へボタン] GEMINI_QUOTA → 「Gemini API無料枠を超過しました」[プラン案内リンク] UNKNOWN → 「予期せぬエラー」[詳細ログ表示 + 再読み込みボタン]


2. **自動リトライ機構**
- RATE_LIMITED / NETWORK_ERROR は最大3回、指数バックオフで自動リトライ
- リトライ中はプログレス表示

3. **エラーログ蓄積**
- クライアント側: localStorage に直近50件保存
- 設定画面に「エラーログ」セクション追加
- デバッグ時にコピペで共有可能

### ファイル変更
- app_core.html: api() 関数にリトライロジック追加
- Code.js: processApiRequest でエラーコード付きレスポンス返却
- 各screen: エラー表示をコンポーネント化

---

## Step 5-3: テスト基盤構築
### 優先度: 高 / 工数: 大

### 問題
- テストがゼロ。変更のたびに手動確認が必要
- リグレッションに気づけない
- PowerShellでの行番号指定編集がバグの温床

### 解決策
1. **サーバーサイドテスト（GAS用）**
- `Tests.js` ファイル新規作成
- GASのメニューから「テスト実行」で全テスト実行
- 主要関数のユニットテスト:
  - getSettings / saveSettings の読み書き整合性
  - analyzeBuzzPattern のゼロデータ・少量データ・正常データ
  - generateWeeklyReport の重複生成防止
  - checkTokenExpiry のトークン状態判定
- テスト結果をスプレッドシートの「テスト結果」シートに出力

2. **クライアントサイドテスト**
- 手動テストチェックリスト（Markdownで管理）
- 各画面の表示確認、ボタン動作、エラー表示
- docs/TEST_CHECKLIST.md として管理

3. **リグレッション防止**
- git push 前に `clasp push` → テスト実行 → 結果確認のフロー
- docs/DEPLOY_PROCEDURE.md にデプロイ手順を文書化

### テスト対象の優先順位
| 関数 | リスク | テスト内容 |
|---|---|---|
| analyzeBuzzPattern | 高 | 0件/1件/100件/ヘッダー不一致 |
| generateWeeklyReport | 高 | 重複防止/データなし/AI失敗 |
| fetchAndStorePostAnalytics | 高 | API失敗/重複排除/バッチ処理 |
| exchangeToken | 高 | 正常/無効コード/期限切れ |
| getAnalyticsData | 中 | 期間フィルタ/アカウント分離 |
| exportCSV (client) | 中 | 特殊文字エスケープ/BOM付き |

---

## Step 5-4: パフォーマンス最適化
### 優先度: 中 / 工数: 中

### 問題
- ダッシュボード初回ロードで3-4回のAPI呼び出し（各2-5秒）
- 401投稿を毎回全件取得してクライアントでソート
- DOM構築が文字列連結→innerHTML代入で毎回フル再構築

### 解決策
1. **APIレスポンスキャッシュ**
```javascript
App.apiCache_ = {};
App.cachedApi = function(action, params, ttlMs) {
  var key = action + JSON.stringify(params);
  var cached = this.apiCache_[key];
  if (cached && (Date.now() - cached.time) < ttlMs) {
    return Promise.resolve(cached.data);
  }
  return this.api(action, params).then(function(data) {
    App.apiCache_[key] = { data: data, time: Date.now() };
    return data;
  });
};
ダッシュボード: 5分キャッシュ
分析データ: 10分キャッシュ
設定・アカウント: 30分キャッシュ
サーバー側ページネーション

getAnalyticsData にoffset/limitパラメータ追加
クライアントで必要な分だけ取得
「もっと見る」で追加ロード
初回ロード最適化

doGet で initialData に直近7日のインサイトを含める
ダッシュボード表示時のAPI呼び出しを1回削減
スプラッシュ中にデータプリフェッチ
目標
ダッシュボード初回表示: 8秒 → 3秒
画面遷移: 2秒 → 0.5秒
分析タブ切替: 1.5秒 → 即時（キャッシュヒット時）
Step 5-5: アクセシビリティ（ARIA + キーボード）
優先度: 中 / 工数: 中
解決策
ARIA属性追加

ナビゲーション: role="navigation", aria-label
タブ: role="tablist", role="tab", aria-selected
ボタン: aria-label（アイコンのみボタン）
ライブリージョン: aria-live="polite"（トースト通知）
モーダル: role="dialog", aria-modal="true"
キーボード操作

Tab キーで全操作可能
Enter/Space でボタン操作
Escape でモーダル/ドロワー閉じ
矢印キーでタブ切替
フォーカス管理

フォーカスリング表示（:focus-visible）
画面遷移時のフォーカス移動
モーダル内フォーカストラップ
Step 5-6: リテンション設計
優先度: 中 / 工数: 大
問題
「開いて分析して閉じる」で終わり
毎日開く理由がない
解決策
成長スコアシステム

週ごとの「成長スコア」を0-100で算出
要素: フォロワー増減、ER推移、投稿頻度、AI活用度
ダッシュボードに大きく表示
前週比で上昇/下降を可視化
デイリーチェックイン

ダッシュボード上部に「今日のひとこと」AI提案
「今日投稿するなら○○がおすすめ」（時間帯分析+トレンド連動）
連続ログイン日数の表示（ストリーク）
目標設定・進捗トラッキング

「今月の目標: フォロワー+100」のような設定機能
進捗バーで達成率を表示
達成時にお祝い演出
メール/プッシュ通知（将来）

GAS のトリガーで週次サマリーメール送信
「先週のER: 5.2% (+0.8%)。この調子！」
Step 5-7: アーキテクチャ改善
優先度: 低（リファクタ） / 工数: 大
問題
全ロジックがグローバル関数とAppオブジェクトに集中
HTML構築が文字列連結（XSSリスク + 保守性低下）
ファイル間の依存関係が暗黙的
解決策（段階的）
Phase A: 関数の名前空間整理

サーバー: 機能別にプレフィックス統一（既にほぼ完了）
クライアント: App.dashboard., App.analytics. のようにネスト
Phase B: HTMLテンプレート化

文字列連結 → テンプレートリテラル（GASのV8対応済み）
共通コンポーネントの関数化（MetricCard, PostCard, ErrorState等）
XSSリスクのある箇所を escapeHtml で統一
Phase C: 状態管理の整理

App.state を画面ごとに分離
状態変更 → UI更新のフローを明示化
localStorageとの同期ロジックを一元化
Step 5-8: マネタイズ設計（将来）
優先度: 低 / 工数: 検討段階
フリーミアム案
機能    無料    Pro (月額980円)
ダッシュボード    ✅    ✅
投稿分析    直近7日    全期間
AI生成    5回/月    無制限
バズ分析    30日のみ    90日+カスタム
週次レポート    閲覧のみ    CSV+画像出力
競合分析    1アカウント    10アカウント
優先サポート    -    ✅
技術的実装
ライセンスキーをスプレッドシートのプロパティに保存
サーバー側で機能制限チェック
Stripe/Gumroad 等で決済 → ライセンスキー発行
実装順序（推奨）
順番    Step    期待効果    工数
1    5-1 オンボーディング    ユーザー獲得率 10x    3日
2    5-2 エラーハンドリング    サポート問い合わせ 50%減    2日
3    5-4 パフォーマンス    体感速度 2-3x    2日
4    5-6 リテンション    DAU維持率向上    3日
5    5-3 テスト基盤    開発速度 + 品質安定    3日
6    5-5 アクセシビリティ    ユーザー層拡大    2日
7    5-7 アーキテクチャ    長期保守性    5日
8    5-8 マネタイズ    収益化    検討中
スコア目標
厳格評価での目標
カテゴリ    現在    5-1後    5-3後    全完了
VC視点    27/60    35/60    40/60    50/60
エンジニア視点    25/100    35/100    50/100    70/100
通常評価での目標
カテゴリ    現在    全完了
合計    66/80    78/80
