<script>
App.renderSetupWizard_ = function(s, appUrl) {
  var appSecretPlaceholder = s.hasAppSecret ? '••••••••（設定済み）' : '';
  var geminiPlaceholder = s.hasGeminiKey ? '••••••••（設定済み）' : 'AIzaSy...';
  return '<div id="setup-wizard" class="card">' +
    '<div class="wizard-progress">' +
      '<div class="wizard-progress-head"><span id="wizardProgressText">ステップ 1/3</span><span>セットアップ</span></div>' +
      '<div class="progress"><div id="wizardProgressBar" class="progress-bar" style="width:33%"></div></div>' +
    '</div>' +
    '<div class="wizard-step wizard-step-1">' +
      '<div class="card-title">ステップ1: Meta Developer 設定</div>' +
      '<label class="form-label">App ID</label>' +
      '<input type="text" id="wizardAppIdInput" class="input" value="' + this.escapeAttr(s.app_id || '') + '">' +
      '<label class="form-label mt-12">App Secret</label>' +
      '<input type="password" id="wizardAppSecretInput" class="input" value="" placeholder="' + this.escapeAttr(appSecretPlaceholder) + '">' +
      '<label class="form-label mt-12">リダイレクトURL</label>' +
      '<div class="btn-group"><input type="text" id="wizardRedirectUrl" class="input" value="' + this.escapeAttr(appUrl) + '" readonly><button id="wizardCopyRedirectBtn" class="btn btn-secondary btn-small">コピー</button></div>' +
      '<div class="btn-group mt-16"><button id="wizardStep1Next" class="btn btn-full">次へ</button></div>' +
    '</div>' +
    '<div class="wizard-step wizard-step-2" style="display:none">' +
      '<div class="card-title">ステップ2: Threads 認証</div>' +
      '<p class="text-caption mb-12">Threadsアカウントを認証してください。</p>' +
      '<div class="btn-group"><button id="wizardStartAuthBtn" class="btn btn-small">Threads認証を開始</button><button id="wizardCopyAuthBtn" class="btn btn-secondary btn-small">認証URLをコピー</button></div>' +
      '<div class="btn-group mt-12"><button id="wizardCheckAuthBtn" class="btn btn-secondary btn-small">認証状態を確認</button></div>' +
      '<div class="btn-group mt-16"><button id="wizardStep2Back" class="btn btn-secondary">戻る</button><button id="wizardStep2Next" class="btn">次へ</button></div>' +
    '</div>' +
    '<div class="wizard-step wizard-step-3" style="display:none">' +
      '<div class="card-title">ステップ3: Gemini APIキー（任意）</div>' +
      '<input type="password" id="wizardGeminiKeyInput" class="input" placeholder="' + this.escapeAttr(geminiPlaceholder) + '" value="">' +
      '<div class="btn-group mt-16"><button id="wizardStep3Back" class="btn btn-secondary">戻る</button><button id="wizardSkipBtn" class="btn btn-secondary">スキップ</button><button id="wizardFinishBtn" class="btn">完了</button></div>' +
    '</div>' +
  '</div>';
};

App.renderSettingsContent = function() {
  var s = this.state.settings || {};
  var sheetId = this.state.sheetId || '';
  var sheetUrl = sheetId ? 'https://docs.google.com/spreadsheets/d/' + sheetId + '/edit' : '';
  var appUrl = ((window.APP_CONFIG && window.APP_CONFIG.deploymentUrl) || window.location.href || '').replace(/\/+$/, '');
  var accounts = this.state.accounts || [];
  var active = this.state.activeAccount;

  var hasMeta = !!(s.app_id && s.hasAppSecret);
  var hasAuth = !!s.hasAccessToken;
  var hasGemini = !!s.hasGeminiKey;
  var appSecretPlaceholder = s.hasAppSecret ? '••••••••（設定済み）' : '';
  var geminiPlaceholder = s.hasGeminiKey ? '••••••••（設定済み）' : 'AIzaSy...';
  var is設定済み = hasMeta || hasAuth;

  if (!is設定済み) {
    return '<div class="screen-content">' + this.renderSetupWizard_(s, appUrl) + '</div>';
  }

  var activeUserHtml = active ?
    '<div class="flex-row gap-12">' +
      (active.profilePicUrl ? '<img src="' + active.profilePicUrl + '" class="avatar">' : '<div class="avatar-placeholder">👤</div>') +
      '<div><div class="text-subheading">@' + this.escapeHtml(active.username || '') + '</div>' +
      '<div class="text-caption">アクティブアカウント</div></div></div>'
    : '<div class="text-caption">No アクティブアカウント</div>';

  var accountList = '';
  if (accounts.length > 1) {
    accountList = '<div class="btn-group mt-12">' +
      accounts.map(function(acc) {
        return '<button class="btn btn-secondary btn-small account-switch-btn" data-id="' + acc.accountId + '">@' + (acc.username || acc.accountId) + '</button>';
      }).join('') +
    '</div>';
  }

  var links = [
    { icon: '📖', label: 'セットアップガイド', url: 'https://sordid-echinacea-374.notion.site/Threads-InsightMaster-AI-1-313b3545dbc6809aa5d6fcf0f710091f' },
    { icon: '🔧', label: 'Meta Developer コンソール', url: s.app_id ? ('https://developers.facebook.com/apps/' + s.app_id + '/dashboard/') : 'https://developers.facebook.com/apps/' },
    { icon: '🤖', label: 'Google AI Studio（APIキー取得）', url: 'https://aistudio.google.com/apikey' }
  ];
  if (sheetUrl) links.push({ icon: '📋', label: 'スプレッドシート', url: sheetUrl });

  var linkListHtml = '<ul class="link-list">' +
    links.map(function(l) {
      return '<li><a class="link-list-item" target="_blank" href="' + l.url + '">' +
        '<div class="flex-row gap-8"><span class="link-icon">' + l.icon + '</span><span>' + l.label + '</span></div>' +
        '<span class="link-arrow">›</span></a></li>';
    }).join('') +
  '</ul>';

  return '<div class="screen-content">' +
    '<div class="card">' +
      '<div class="card-title">アカウント</div>' +
      activeUserHtml +
      accountList +
      '<div id="authActionsArea" class="mt-16">' + this.renderAuthActionsHtml_(hasMeta) + '</div>' +
      '<div class="btn-group mt-12"><button id="importAccountBtn" class="btn btn-secondary btn-small">他のシートから取り込み</button></div>' +
      '<div class="btn-group mt-12">' +
        (accounts.map(function(acc) { return '<button class="btn btn-secondary btn-small account-delete-btn" data-id="' + acc.accountId + '">@' + (acc.username || acc.accountId) + ' 削除</button>'; }).join('')) +
      '</div>' +
    '</div>' +

    '<div class="accordion">' +
      '<div class="accordion-header open" data-accordion="meta"><div class="flex-row gap-8"><span>Meta Developer</span><span class="status-badge ' + (hasMeta ? 'success' : 'warning') + '">' + (hasMeta ? '設定済み' : '未設定') + '</span></div><span class="accordion-chevron">›</span></div>' +
      '<div class="accordion-body open" data-accordion-body="meta"><div class="accordion-body-inner">' +
        '<label class="text-subheading">App ID</label><input type="text" id="appIdInput" class="input" value="' + this.escapeAttr(s.app_id || '') + '">' +
        '<label class="text-subheading mt-12">App Secret</label><input type="password" id="appSecretInput" class="input" value="" placeholder="' + this.escapeAttr(appSecretPlaceholder) + '">' +
        '<div class="mt-16"><div class="text-caption mb-8">リダイレクトURL</div><div class="btn-group"><input type="text" id="redirectUrl" class="input" value="' + this.escapeAttr(appUrl) + '" readonly><button id="copyRedirectBtn" class="btn btn-secondary btn-small">コピー</button></div></div>' +
        '<div class="mt-16"><button id="saveMetaBtn" class="btn btn-full">保存</button></div>' +
      '</div></div>' +
    '</div>' +

    '<div class="accordion">' +
      '<div class="accordion-header" data-accordion="gemini"><div class="flex-row gap-8"><span>Gemini AI</span><span class="status-badge ' + (hasGemini ? 'success' : 'info') + '">' + (hasGemini ? '設定済み' : '任意') + '</span></div><span class="accordion-chevron">›</span></div>' +
      '<div class="accordion-body" data-accordion-body="gemini"><div class="accordion-body-inner">' +
        '<input type="password" id="geminiKeyInput" class="input" placeholder="' + this.escapeAttr(geminiPlaceholder) + '" value="">' +
        '<div class="btn-group mt-12"><a href="https://sordid-echinacea-374.notion.site/Gemini-API-1-313b3545dbc680cda9d2e2eed59028af" target="_blank" class="btn btn-secondary btn-small" style="text-decoration:none;">取得方法</a><button id="saveGeminiKeyBtn" class="btn btn-small">保存</button></div>' +
      '</div></div>' +
    '</div>' +

    '<div class="card"><div class="card-title">ガイド＆リンク</div>' + linkListHtml + '</div>' +
    '<div class="card"><div class="card-title">アプリ情報</div><div class="text-body mb-4">Insight Master</div><div class="text-caption mb-12">v1.5.0 (2026-02-27)</div><div class="btn-group"><input type="text" id="appUrlInput" class="input" value="' + this.escapeAttr(appUrl) + '" readonly><button id="copyAppUrlBtn" class="btn btn-secondary btn-small">コピー</button></div><div class="mt-16"><button id="disconnectBtn" class="btn btn-danger btn-full">連携解除</button></div></div>' +
  '</div>';
};

App.renderAuthActionsHtml_ = function(hasMeta) {
  if (!hasMeta) return '<div class="text-caption">App ID / App Secret を先に設定してください.</div>';
  return '<div class="btn-group"><button id="startAuthBtn" class="btn btn-small">Threads認証を開始</button><button id="copyAuthBtn" class="btn btn-secondary btn-small">認証URLをコピー</button></div>';
};

App.bindSetupWizardEvents_ = function() {
  var self = this;
  var step = 1;
  var showStep = function(next) {
    step = next;
    [1,2,3].forEach(function(n) {
      var el = document.querySelector('.wizard-step-' + n);
      if (el) el.style.display = (n === step) ? 'block' : 'none';
    });
    var text = document.getElementById('wizardProgressText');
    var bar = document.getElementById('wizardProgressBar');
    if (text) text.textContent = 'ステップ ' + step + '/3';
    if (bar) bar.style.width = (step * 33) + '%';
  };

  var copyRedirectBtn = document.getElementById('wizardCopyRedirectBtn');
  if (copyRedirectBtn) copyRedirectBtn.addEventListener('click', function() { self.copyToClipboard((document.getElementById('wizardRedirectUrl') || {}).value || ''); });

  var saveMeta = async function() {
    var appId = ((document.getElementById('wizardAppIdInput') || {}).value || '').trim();
    var appSecret = ((document.getElementById('wizardAppSecretInput') || {}).value || '').trim();
    var appUrl = ((document.getElementById('wizardRedirectUrl') || {}).value || '').trim();
    if (!appId || !appSecret) { self.showToast('App ID / App Secret を入力してください', 'warning'); return false; }
    await self.api('saveSettings', { app_id: appId, app_secret: appSecret, app_url: appUrl });
    self.state.settings.app_id = appId;
    self.state.settings.hasAppSecret = !!appSecret;
    if (self.refreshNavLock_) self.refreshNavLock_();
    self.showToast('Meta設定を保存しました', 'success');
    return true;
  };

  var step1Next = document.getElementById('wizardStep1Next');
  if (step1Next) step1Next.addEventListener('click', async function() { try { if (await saveMeta()) showStep(2); } catch (e) { self.showToast('保存に失敗: ' + e.message, 'error'); } });

  var startAuth = async function() { sessionStorage.setItem('postAuthRedirect', 'settings'); var r = await self.api('getAuthUrl', {}); if (r && r.url) window.open(r.url, '_blank'); };
  var wizardStartAuthBtn = document.getElementById('wizardStartAuthBtn');
  if (wizardStartAuthBtn) wizardStartAuthBtn.addEventListener('click', function() { startAuth().catch(function(e) { self.showToast(e.message, 'error'); }); });
  var wizardCopyAuthBtn = document.getElementById('wizardCopyAuthBtn');
  if (wizardCopyAuthBtn) wizardCopyAuthBtn.addEventListener('click', async function() { try { var r = await self.api('getAuthUrl', {}); if (r && r.url) self.copyToClipboard(r.url); } catch (e) { self.showToast(e.message, 'error'); } });

  var checkAuth = async function() {
    var latest = await self.api('getSettings', {});
    self.state.settings = latest || self.state.settings;
    if (self.state.settings.hasAccessToken) {
      if (self.refreshNavLock_) self.refreshNavLock_();
      self.showToast('認証済み', 'success');
      return true;
    }
    self.showToast('まだ認証されていません', 'warning');
    return false;
  };

  var wizardCheckAuthBtn = document.getElementById('wizardCheckAuthBtn');
  if (wizardCheckAuthBtn) wizardCheckAuthBtn.addEventListener('click', function() { checkAuth().then(function(ok) { if (ok) showStep(3); }).catch(function(e) { self.showToast(e.message, 'error'); }); });

  var step2Back = document.getElementById('wizardStep2Back');
  if (step2Back) step2Back.addEventListener('click', function() { showStep(1); });
  var step2Next = document.getElementById('wizardStep2Next');
  if (step2Next) step2Next.addEventListener('click', function() { checkAuth().then(function(ok) { if (ok) showStep(3); }).catch(function(e) { self.showToast(e.message, 'error'); }); });

  var step3Back = document.getElementById('wizardStep3Back');
  if (step3Back) step3Back.addEventListener('click', function() { showStep(2); });
  var wizardSkipBtn = document.getElementById('wizardSkipBtn');
  if (wizardSkipBtn) wizardSkipBtn.addEventListener('click', function() { self.showScreen('settings'); });
  var wizardFinishBtn = document.getElementById('wizardFinishBtn');
  if (wizardFinishBtn) wizardFinishBtn.addEventListener('click', async function() {
    try {
      var key = ((document.getElementById('wizardGeminiKeyInput') || {}).value || '').trim();
      await self.api('saveSettings', { gemini_api_key: key });
      self.state.settings.hasGeminiKey = !!key;
      if (self.refreshNavLock_) self.refreshNavLock_();
      self.showToast('セットアップ完了', 'success');
      self.showScreen('settings');
    } catch (e) {
      self.showToast('保存に失敗: ' + e.message, 'error');
    }
  });

  if (self.state.settings && self.state.settings.hasAccessToken) showStep(3);
};

App.bindSettingsEvents = function() {
  var self = this;
  var wizard = document.getElementById('setup-wizard');
  if (wizard) {
    this.bindSetupWizardEvents_();
    return;
  }

  document.querySelectorAll('.account-switch-btn').forEach(function(btn) { btn.addEventListener('click', function() { self.switchAccount(this.getAttribute('data-id')); }); });
  document.querySelectorAll('.account-delete-btn').forEach(function(btn) { btn.addEventListener('click', function() { self.deleteAccount(this.getAttribute('data-id')); }); });

  var importBtn = document.getElementById('importAccountBtn');
  if (importBtn) importBtn.addEventListener('click', function() { self.showImportModal_(); });

  var saveMetaBtn = document.getElementById('saveMetaBtn');
  if (saveMetaBtn) saveMetaBtn.addEventListener('click', async function() {
    var appId = (document.getElementById('appIdInput') || {}).value || '';
    var appSecret = (document.getElementById('appSecretInput') || {}).value || '';
    var appUrl = ((window.APP_CONFIG && window.APP_CONFIG.deploymentUrl) || window.location.href || '').replace(/\/+$/, '');
    try {
      await self.api('saveSettings', { app_id: appId, app_secret: appSecret, app_url: appUrl });
      self.state.settings.app_id = appId;
      self.state.settings.hasAppSecret = !!appSecret;
      if (self.refreshNavLock_) self.refreshNavLock_();
      self.showToast('保存しました', 'success');
      var area = document.getElementById('authActionsArea');
      if (area) { area.innerHTML = self.renderAuthActionsHtml_(!!(appId && appSecret)); bindAuthButtons(); }
    } catch (e) { self.showToast('保存に失敗: ' + e.message, 'error'); }
  });

  var geminiBtn = document.getElementById('saveGeminiKeyBtn');
  if (geminiBtn) geminiBtn.addEventListener('click', async function() {
    var key = (document.getElementById('geminiKeyInput') || {}).value || '';
    try {
      await self.api('saveSettings', { gemini_api_key: key });
      self.state.settings.hasGeminiKey = !!key;
      if (self.refreshNavLock_) self.refreshNavLock_();
      self.showToast('保存しました', 'success');
    } catch (e) { self.showToast('保存に失敗: ' + e.message, 'error'); }
  });

  var bindAuthButtons = function() {
    var startAuthBtn = document.getElementById('startAuthBtn');
    if (startAuthBtn && !startAuthBtn.dataset.bound) {
      startAuthBtn.dataset.bound = 'true';
      startAuthBtn.addEventListener('click', async function() { try { sessionStorage.setItem('postAuthRedirect', 'settings'); var r = await self.api('getAuthUrl', {}); if (r && r.url) window.open(r.url, '_blank'); } catch (e) { self.showToast(e.message, 'error'); } });
    }
    var copyAuthBtn = document.getElementById('copyAuthBtn');
    if (copyAuthBtn && !copyAuthBtn.dataset.bound) {
      copyAuthBtn.dataset.bound = 'true';
      copyAuthBtn.addEventListener('click', async function() { try { var r = await self.api('getAuthUrl', {}); if (r && r.url) self.copyToClipboard(r.url); } catch (e) { self.showToast(e.message, 'error'); } });
    }
  };
  bindAuthButtons();

  var copyRedirectBtn = document.getElementById('copyRedirectBtn');
  if (copyRedirectBtn) copyRedirectBtn.addEventListener('click', function() { self.copyToClipboard((document.getElementById('redirectUrl') || {}).value || ''); });
  var copyAppBtn = document.getElementById('copyAppUrlBtn');
  if (copyAppBtn) copyAppBtn.addEventListener('click', function() { self.copyToClipboard((document.getElementById('appUrlInput') || {}).value || ''); });

  document.querySelectorAll('.accordion-header').forEach(function(h) {
    h.addEventListener('click', function() {
      var key = this.getAttribute('data-accordion');
      var body = document.querySelector('[data-accordion-body="' + key + '"]');
      var open = this.classList.toggle('open');
      if (body) body.classList.toggle('open', open);
    });
  });

  var dcBtn = document.getElementById('disconnectBtn');
  if (dcBtn) dcBtn.addEventListener('click', function() {
    if (!confirm('連携を解除しますか？')) return;
    localStorage.removeItem('threads_tool_sheet_id');
    self.state = { sheetId:null, user:null, settings:{}, currentScreen:'settings', accounts:[], activeAccount:null, tokenWarnings:[], analyticsData:null, timeAnalysis:null, userInsights:null, drafts:[], generatedPosts:[], currentDraftFilter:'', analyticsTab:'posts', createTab:'ai' };
    if (self.refreshNavLock_) self.refreshNavLock_();
    self.showScreen('settings');
    self.showToast('連携を解除しました', 'success');
  });
};

App.showImportModal_ = function() {
  var self = this;
  var overlay = document.createElement('div');
  overlay.className = 'modal-overlay show';
  overlay.innerHTML = '<div class="modal-sheet">' +
    '<div class="modal-header"><div class="text-heading">Import Settings</div><button class="modal-close" id="closeImportModal">✕</button></div>' +
    '<div class="text-caption mb-12">Scan another sheet and import selected values.</div>' +
    '<div class="btn-group mb-12"><input type="text" id="importSheetInput" class="input" placeholder="Spreadsheet URL or ID"><button id="scanImportBtn" class="btn btn-small">Scan</button></div>' +
    '<div id="importPreview" class="mb-12"></div>' +
    '<div class="btn-group"><button id="applyImportBtn" class="btn btn-full" disabled>Apply Selected</button></div>' +
  '</div>';
  document.body.appendChild(overlay);

  var closeModal = function() { overlay.remove(); };
  overlay.addEventListener('click', function(e) { if (e.target === overlay) closeModal(); });
  overlay.querySelector('#closeImportModal').addEventListener('click', closeModal);

  var foundData = {};
  var preview = overlay.querySelector('#importPreview');
  var applyBtn = overlay.querySelector('#applyImportBtn');

  function extractSheetId(value) {
    if (!value) return '';
    var v = value.trim();
    var m = v.match(/\/d\/([a-zA-Z0-9-_]+)/);
    if (m && m[1]) return m[1];
    m = v.match(/[?&]id=([a-zA-Z0-9-_]+)/);
    if (m && m[1]) return m[1];
    return v;
  }

  function renderPreview() {
    var keys = Object.keys(foundData);
    if (keys.length === 0) {
      preview.innerHTML = '<div class="text-caption">No values found.</div>';
      applyBtn.disabled = true;
      return;
    }
    var labels = { app_id: 'App ID', app_secret: 'App Secret', access_token: 'Access Token', user_id: 'User ID', gemini_api_key: 'Gemini API Key' };
    var html = '<div class="card"><div class="text-subheading mb-8">Scan Result</div>';
    html += keys.map(function(k) {
      var item = foundData[k];
      return '<label class="flex-row gap-8 mb-8"><input type="checkbox" class="import-check" data-key="' + k + '" checked><div style="flex:1;"><div class="text-subheading">' + (labels[k] || k) + '</div><div class="text-caption">' + self.escapeHtml(String(item.value || '').substring(0, 4) + '****') + '</div></div></label>';
    }).join('');
    html += '</div>';
    preview.innerHTML = html;
    applyBtn.disabled = false;
  }

  overlay.querySelector('#scanImportBtn').addEventListener('click', async function() {
    var sheetId = extractSheetId((overlay.querySelector('#importSheetInput').value || ''));
    if (!sheetId) { self.showToast('シートIDを入力してください', 'error'); return; }
    try {
      this.disabled = true;
      preview.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      var result = await self.api('importFromExternalSheet', { sourceSheetId: sheetId });
      foundData = (result && result.found) ? result.found : {};
      renderPreview();
    } catch (e) {
      preview.innerHTML = '';
      self.showToast(e.message, 'error');
    } finally {
      this.disabled = false;
    }
  });

  applyBtn.addEventListener('click', async function() {
    var selected = {};
    overlay.querySelectorAll('.import-check').forEach(function(chk) {
      if (chk.checked) {
        var key = chk.getAttribute('data-key');
        if (foundData[key]) selected[key] = foundData[key].value;
      }
    });
    if (Object.keys(selected).length === 0) { self.showToast('取り込む項目を選択してください', 'error'); return; }
    try {
      applyBtn.disabled = true;
      await self.api('saveSettings', selected);
      self.state.settings = await self.api('getSettings', {});
      await self.loadAccounts();
      self.showToast('取り込み完了', 'success');
      closeModal();
      self.showScreen('settings');
    } catch (e) {
      self.showToast('取り込みに失敗: ' + e.message, 'error');
      applyBtn.disabled = false;
    }
  });
};
</script>








