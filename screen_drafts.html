<script>
// ===========================================
// ä¸‹æ›¸ãã‚¹ãƒˆãƒƒã‚¯ç”»é¢ï¼ˆãƒ„ãƒªãƒ¼å¯¾å¿œ + AIç·¨é›†ç‰ˆï¼‰
// ===========================================

App.renderDraftsContent = function() {
  return '<div class="screen-content">' +
    '<div class="card"><div class="card-title">ä¸‹æ›¸ãã‚¹ãƒˆãƒƒã‚¯</div>' +
      '<div class="btn-group mb-12">' +
        '<button class="btn btn-small draft-filter-btn active" data-filter="">å…¨ã¦</button>' +
        '<button class="btn btn-small draft-filter-btn" data-filter="unused">æœªä½¿ç”¨</button>' +
        '<button class="btn btn-small draft-filter-btn" data-filter="used">ä½¿ç”¨æ¸ˆã¿</button></div>' +
      '<button id="addDraftBtn" class="btn btn-secondary btn-full">ï¼‹ æ‰‹å‹•ã§ä¸‹æ›¸ãè¿½åŠ </button></div>' +
    this.renderTips([
      { title: 'ğŸ“ ä¸‹æ›¸ãã®æ´»ç”¨ã‚µã‚¤ã‚¯ãƒ«', body: 'â‘  AIç”Ÿæˆã§è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ä½œæˆ â†’ â‘¡ è‰¯ã„ã‚‚ã®ã‚’ä¸‹æ›¸ãä¿å­˜ â†’ â‘¢ ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¿ã‚¤ãƒ ã«æŠ•ç¨¿ â†’ â‘£ æŠ•ç¨¿å¾Œã€Œä½¿ç”¨æ¸ˆã¿ã€ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã€‚ã“ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’å›ã™ã“ã¨ã§æŠ•ç¨¿ã®è³ªã¨é »åº¦ãŒå®‰å®šã—ã¾ã™ã€‚' },
      { title: 'ğŸ§µ ãƒ„ãƒªãƒ¼ä¸‹æ›¸ãã®ä½¿ã„æ–¹', body: 'ãƒ„ãƒªãƒ¼ä¿å­˜ã—ãŸä¸‹æ›¸ãã¯è¦ªæŠ•ç¨¿ã¨è¿”ä¿¡ãŒã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚å€‹åˆ¥ã‚³ãƒ”ãƒ¼ã§1ã¤ãšã¤æŠ•ç¨¿ã™ã‚‹ã‹ã€å…¨æ–‡ã‚³ãƒ”ãƒ¼ã§ã¾ã¨ã‚ã¦ç¢ºèªã§ãã¾ã™ã€‚' },
      { title: 'âœï¸ AIç·¨é›†ã®ä½¿ã„æ–¹', body: 'å„ä¸‹æ›¸ãã®ã€Œâœï¸ AIç·¨é›†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€æ–‡ä½“å¤‰æ›´ã‚„æ”¹å–„ã‚’AIãŒææ¡ˆã—ã¾ã™ã€‚7ã¤ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæ”¹å–„ãƒ»çŸ­ç¸®ãƒ»æ‹¡å¼µãƒ»ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ»ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãƒ»ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ»ãƒ•ãƒƒã‚¯å¼·åŒ–ï¼‰ã‹ã‚‰é¸ã¹ã¾ã™ã€‚' }
    ]) +
    '<div id="draftsListArea"><div class="loading"><div class="loading-spinner"></div></div></div></div>';
};

App.loadDrafts = async function() {
  var self = this;
  this.state.currentDraftFilter = '';

  document.querySelectorAll('.draft-filter-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.draft-filter-btn').forEach(function(b) { b.classList.remove('active'); });
      this.classList.add('active');
      self.state.currentDraftFilter = this.getAttribute('data-filter');
      self.fetchDraftsList_();
    });
  });

  document.getElementById('addDraftBtn').addEventListener('click', function() { self.showAddDraftModal_(); });
  await this.fetchDraftsList_();
};

App.fetchDraftsList_ = async function() {
  var self = this;
  var c = document.getElementById('draftsListArea');
  try {
    var drafts = await this.api('getDrafts', { statusFilter: this.state.currentDraftFilter || null });
    if (!drafts || drafts.length === 0) {
      c.innerHTML = '<div class="card" style="text-align:center;color:#666;padding:30px;">ä¸‹æ›¸ããŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }
    var html = '';
    drafts.forEach(function(d) {
      if (d.threadId && d.parts) {
        html += self.renderThreadDraft_(d);
      } else {
        html += self.renderSingleDraft_(d);
      }
    });
    c.innerHTML = html;
    self.bindDraftEvents_(c);
  } catch (e) {
    c.innerHTML = '<div style="color:#e74c3c;text-align:center;padding:20px;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
  }
};

// â”€â”€ é€šå¸¸æŠ•ç¨¿ã‚«ãƒ¼ãƒ‰ â”€â”€
App.renderSingleDraft_ = function(d) {
  var badge = d.status === 'used'
    ? '<span style="background:#e0e0e0;color:#666;padding:2px 8px;border-radius:4px;font-size:11px;">ä½¿ç”¨æ¸ˆã¿</span>'
    : '<span style="background:#dcfce7;color:#16a34a;padding:2px 8px;border-radius:4px;font-size:11px;">æœªä½¿ç”¨</span>';
  var src = d.source === 'ai_generated' ? 'âœ¨AI' : 'âœï¸æ‰‹å‹•';
  var date = d.createdAt ? new Date(d.createdAt).toLocaleDateString('ja-JP') : '';

  return '<div class="card" style="margin:0 0 8px;">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">' +
      '<div style="display:flex;gap:6px;align-items:center;">' + badge +
        '<span style="font-size:11px;color:var(--text-tertiary);">' + src + '</span></div>' +
      '<span style="font-size:11px;color:var(--text-tertiary);">' + date + '</span></div>' +
    '<div style="font-size:14px;margin-bottom:12px;line-height:1.6;white-space:pre-wrap;">' + this.escapeHtml(d.text) + '</div>' +
    '<div style="display:flex;gap:8px;flex-wrap:wrap;">' +
      '<button class="btn btn-small btn-secondary draft-copy-btn" data-text="' + this.escapeAttr(d.text) + '">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>' +
      '<button class="btn btn-small btn-secondary draft-share-btn" data-text="' + this.escapeAttr(d.text) + '">ğŸ“¤ Threadsã§é–‹ã</button>' +
      '<button class="btn btn-small btn-secondary draft-refine-btn" data-id="' + d.draftId + '" data-text="' + this.escapeAttr(d.text) + '">âœï¸ AIç·¨é›†</button>' +
      '<button class="btn btn-small btn-secondary draft-toggle-btn" data-id="' + d.draftId + '">' +
        (d.status === 'used' ? 'â†©ï¸ æœªä½¿ç”¨ã«' : 'âœ… ä½¿ç”¨æ¸ˆã¿ã«') + '</button>' +
      '<button class="btn btn-small btn-danger draft-delete-btn" data-id="' + d.draftId + '">ğŸ—‘ å‰Šé™¤</button></div></div>';
};

// â”€â”€ ãƒ„ãƒªãƒ¼æŠ•ç¨¿ã‚«ãƒ¼ãƒ‰ â”€â”€
App.renderThreadDraft_ = function(thread) {
  var self = this;
  var parts = thread.parts || [];
  var firstPart = parts[0] || {};
  var badge = firstPart.status === 'used'
    ? '<span style="background:#e0e0e0;color:#666;padding:2px 8px;border-radius:4px;font-size:11px;">ä½¿ç”¨æ¸ˆã¿</span>'
    : '<span style="background:#dcfce7;color:#16a34a;padding:2px 8px;border-radius:4px;font-size:11px;">æœªä½¿ç”¨</span>';
  var src = firstPart.source === 'ai_generated' ? 'âœ¨AI' : 'âœï¸æ‰‹å‹•';
  var date = firstPart.createdAt ? new Date(firstPart.createdAt).toLocaleDateString('ja-JP') : '';

  var fullText = parts.map(function(p) { return p.text; }).join('\n\n');

  var html = '<div class="card" style="margin:0 0 8px;border-left:3px solid #8B5CF6;">';

  // ãƒ˜ãƒƒãƒ€ãƒ¼
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">' +
    '<div style="display:flex;gap:6px;align-items:center;">' +
      '<span style="background:#EDE9FE;color:#7C3AED;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;">ğŸ§µ ãƒ„ãƒªãƒ¼ï¼ˆ' + parts.length + 'æŠ•ç¨¿ï¼‰</span>' +
      badge +
      '<span style="font-size:11px;color:var(--text-tertiary);">' + src + '</span></div>' +
    '<span style="font-size:11px;color:var(--text-tertiary);">' + date + '</span></div>';

  // å„ãƒ‘ãƒ¼ãƒ„ã‚’è¡¨ç¤º
  parts.forEach(function(p, i) {
    var label = i === 0 ? 'è¦ªæŠ•ç¨¿' : 'è¿”ä¿¡ ' + i;
    var borderColor = i === 0 ? '#8B5CF6' : '#C4B5FD';
    var bgColor = i === 0 ? '#FAFAFF' : '#F9F9FC';

    html += '<div style="background:' + bgColor + ';border-radius:8px;padding:10px 12px;margin-bottom:6px;' +
      (i > 0 ? 'margin-left:16px;' : '') + 'border-left:2px solid ' + borderColor + ';">';
    html += '<div style="font-size:11px;color:#7C3AED;font-weight:600;margin-bottom:4px;">' + label + '</div>';
    html += '<div style="font-size:14px;line-height:1.6;white-space:pre-wrap;">' + self.escapeHtml(p.text) + '</div>';
    html += '</div>';
  });

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
  html += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">';

  parts.forEach(function(p, i) {
    var label = i === 0 ? 'ğŸ“‹ è¦ªã‚’ã‚³ãƒ”ãƒ¼' : 'ğŸ“‹ è¿”ä¿¡' + i;
    html += '<button class="btn btn-small btn-secondary draft-copy-btn" data-text="' + self.escapeAttr(p.text) + '">' + label + '</button>';
  });

  html += '<button class="btn btn-small btn-secondary draft-copy-btn" data-text="' + self.escapeAttr(fullText) + '" style="background:#EDE9FE;color:#7C3AED;">ğŸ“‹ å…¨æ–‡ã‚³ãƒ”ãƒ¼</button>';
  html += '<button class="btn btn-small btn-secondary draft-share-btn" data-text="' + self.escapeAttr(fullText) + '">ğŸ“¤ Threadsã§é–‹ã</button>';
  html += '<button class="btn btn-small btn-secondary draft-refine-btn" data-id="' + firstPart.draftId + '" data-text="' + self.escapeAttr(firstPart.text) + '">âœï¸ AIç·¨é›†</button>';
  html += '<button class="btn btn-small btn-secondary draft-toggle-btn" data-id="' + firstPart.draftId + '">' +
    (firstPart.status === 'used' ? 'â†©ï¸ æœªä½¿ç”¨ã«' : 'âœ… ä½¿ç”¨æ¸ˆã¿ã«') + '</button>';
  html += '<button class="btn btn-small btn-danger draft-delete-btn" data-id="' + firstPart.draftId + '">ğŸ—‘ å‰Šé™¤</button>';

  html += '</div></div>';
  return html;
};

// â”€â”€ ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰ï¼ˆå…±é€šï¼‰ â”€â”€
App.bindDraftEvents_ = function(container) {
  var self = this;

  container.querySelectorAll('.draft-copy-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      self.copyToClipboard(this.getAttribute('data-text'));
    });
  });

  container.querySelectorAll('.draft-share-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var text = this.getAttribute('data-text') || '';
      if (navigator.share) {
        navigator.share({ text: text });
      } else {
        self.copyToClipboard(text);
        window.open('https://www.threads.net', '_blank');
      }
    });
  });

  container.querySelectorAll('.draft-toggle-btn').forEach(function(btn) {
    btn.addEventListener('click', async function() {
      try {
        await self.api('toggleDraftStatus', { draftId: this.getAttribute('data-id') });
        self.fetchDraftsList_();
      } catch (e) { self.showToast('ã‚¨ãƒ©ãƒ¼', 'error'); }
    });
  });

  container.querySelectorAll('.draft-delete-btn').forEach(function(btn) {
    btn.addEventListener('click', async function() {
      if (!confirm('ã“ã®ä¸‹æ›¸ãã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try {
        await self.api('deleteDraft', { draftId: this.getAttribute('data-id') });
        self.showToast('å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        self.fetchDraftsList_();
      } catch (e) { self.showToast('å‰Šé™¤ã‚¨ãƒ©ãƒ¼', 'error'); }
    });
  });

  // â”€â”€ AIç·¨é›†ãƒœã‚¿ãƒ³ â”€â”€
  container.querySelectorAll('.draft-refine-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var text = this.getAttribute('data-text');
      var draftId = this.getAttribute('data-id');
      self.showRefineModal_(text, draftId);
    });
  });
};

// â”€â”€ AIç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€
App.showRefineModal_ = function(text, draftId) {
  var self = this;

  // æ—¢å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚ã‚Œã°é™¤å»
  var existing = document.getElementById('refineModal');
  if (existing) document.body.removeChild(existing);

  var styles = [
    { key: 'improve',      label: 'ğŸ”§ æ”¹å–„',         desc: 'å…¨ä½“çš„ãªå“è³ªå‘ä¸Š' },
    { key: 'shorter',      label: 'âœ‚ï¸ çŸ­ç¸®',         desc: 'ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«è¦ç´„' },
    { key: 'longer',       label: 'ğŸ“ æ‹¡å¼µ',         desc: 'å†…å®¹ã‚’è†¨ã‚‰ã¾ã›ã‚‹' },
    { key: 'casual',       label: 'ğŸ˜Š ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«',    desc: 'è¦ªã—ã¿ã‚„ã™ã„æ–‡ä½“' },
    { key: 'professional', label: 'ğŸ’¼ ãƒ—ãƒ­',          desc: 'ãƒ“ã‚¸ãƒã‚¹å‘ã‘æ–‡ä½“' },
    { key: 'engaging',     label: 'ğŸ”¥ ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸',    desc: 'åå¿œã‚’å¾—ã‚„ã™ã' },
    { key: 'hook',         label: 'ğŸ£ ãƒ•ãƒƒã‚¯å¼·åŒ–',    desc: 'å†’é ­ã§å¼•ãã¤ã‘ã‚‹' }
  ];

  var styleButtons = styles.map(function(s) {
    return '<button class="btn btn-small btn-secondary refine-style-btn" data-style="' + s.key + '" ' +
      'style="display:flex;flex-direction:column;align-items:center;padding:8px 12px;min-width:80px;transition:all 0.2s;">' +
      '<span class="text-body">' + s.label + '</span>' +
      '<span style="font-size:10px;color:var(--text-tertiary);margin-top:2px;">' + s.desc + '</span></button>';
  }).join('');

  var previewText = text.length > 100 ? text.substring(0, 100) + 'â€¦' : text;

  var overlay = document.createElement('div');
  overlay.id = 'refineModal';
  overlay.setAttribute('role', 'dialog');
  overlay.setAttribute('aria-modal', 'true');
  overlay.setAttribute('aria-label', 'AIç·¨é›†');
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;padding:16px;';

  overlay.innerHTML =
    '<div style="background:var(--bg-primary,#fff);border-radius:16px;padding:24px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;">' +

      // ãƒ˜ãƒƒãƒ€ãƒ¼
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">' +
        '<div style="font-size:18px;font-weight:bold;">âœï¸ AIç·¨é›†</div>' +
        '<button id="refineCloseBtn" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-secondary);">âœ•</button></div>' +

      // å…ƒãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      '<div style="background:var(--bg-secondary,#f5f5f5);border-radius:8px;padding:10px 12px;margin-bottom:16px;font-size:13px;line-height:1.5;color:var(--text-secondary);">' +
        '<div style="font-size:11px;font-weight:600;color:var(--text-tertiary);margin-bottom:4px;">å…ƒã®æŠ•ç¨¿</div>' +
        self.escapeHtml(previewText) + '</div>' +

      // ã‚¹ã‚¿ã‚¤ãƒ«é¸æŠ
      '<div class="mb-12">' +
        '<div style="font-size:13px;font-weight:600;margin-bottom:8px;">ç·¨é›†ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é¸æŠ</div>' +
        '<div style="display:flex;flex-wrap:wrap;gap:6px;">' + styleButtons + '</div></div>' +

      // è‡ªç”±æŒ‡ç¤º
      '<div style="margin-bottom:16px;">' +
        '<div style="font-size:13px;font-weight:600;margin-bottom:6px;">è¿½åŠ ã®æŒ‡ç¤ºï¼ˆä»»æ„ï¼‰</div>' +
        '<input id="refineInstruction" class="input" type="text" placeholder="ä¾‹ï¼šçµµæ–‡å­—ã‚’å¤šã‚ã«ã€ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°3ã¤è¿½åŠ â€¦" style="font-size:13px;"></div>' +

      // å®Ÿè¡Œãƒœã‚¿ãƒ³
      '<button id="refineExecuteBtn" class="btn btn-primary btn-full" disabled style="margin-bottom:16px;">ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„</button>' +

      // çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢
      '<div id="refineResultArea"></div>' +
    '</div>';

  document.body.appendChild(overlay);

  // çŠ¶æ…‹
  var selectedStyle = null;

  // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) document.body.removeChild(overlay);
  });

  // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
  document.getElementById('refineCloseBtn').addEventListener('click', function() {
    document.body.removeChild(overlay);
  });

  // ã‚¹ã‚¿ã‚¤ãƒ«é¸æŠ
  overlay.querySelectorAll('.refine-style-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      overlay.querySelectorAll('.refine-style-btn').forEach(function(b) {
        b.style.border = '';
        b.style.background = '';
      });
      this.style.border = '2px solid var(--primary)';
      this.style.background = 'var(--bg-secondary,#f0f0ff)';
      selectedStyle = this.getAttribute('data-style');

      var execBtn = document.getElementById('refineExecuteBtn');
      execBtn.disabled = false;
      var match = styles.find(function(s) { return s.key === selectedStyle; });
      execBtn.textContent = 'âœ¨ ã€Œ' + (match ? match.label : selectedStyle) + 'ã€ã§ç·¨é›†ã™ã‚‹';
    });
  });

  // å®Ÿè¡Œ
  document.getElementById('refineExecuteBtn').addEventListener('click', function() {
    if (!selectedStyle) return;
    var instruction = (document.getElementById('refineInstruction').value || '').trim();
    self.executeRefine_(text, selectedStyle, instruction, draftId, overlay);
  });
};

// â”€â”€ AIç·¨é›†å®Ÿè¡Œï¼ˆä¿®æ­£ç‰ˆï¼‰ â”€â”€
App.executeRefine_ = async function(text, style, instruction, draftId, overlay) {
  var self = this;
  var resultArea = document.getElementById('refineResultArea');
  var execBtn = document.getElementById('refineExecuteBtn');

  execBtn.disabled = true;
  execBtn.textContent = 'â³ AIãŒç·¨é›†ä¸­â€¦';
  resultArea.innerHTML =
    '<div style="text-align:center;padding:20px;">' +
      '<div class="loading-spinner" style="margin:0 auto 8px;"></div>' +
      '<div class="text-caption">3ã¤ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™â€¦</div></div>';

  try {
    var res = await this.api('refinePostWithAI', {
      text: text,
      style: style,
      instruction: instruction || null
    });

    // â”€â”€ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆé…åˆ—ã‚’ç¢ºå®Ÿã«æŠ½å‡º â”€â”€
    var variants = self.extractRefineVariants_(res);

    if (variants.length === 0) {
      resultArea.innerHTML = '<div style="color:#e74c3c;text-align:center;padding:16px;">çµæœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
      execBtn.textContent = 'å†è©¦è¡Œ';
      execBtn.disabled = false;
      return;
    }

    var html = '<div style="font-size:14px;font-weight:600;margin-bottom:10px;">âœ¨ ç·¨é›†çµæœï¼ˆ' + variants.length + 'ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰</div>';

    variants.forEach(function(v, i) {
      html += '<div style="background:var(--bg-secondary,#f5f5f5);border-radius:10px;padding:12px;margin-bottom:10px;border:1px solid var(--border-color,#e5e5e5);">';

      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">' +
        '<span style="font-size:12px;font-weight:600;color:var(--primary);">ãƒ‘ã‚¿ãƒ¼ãƒ³ ' + (i + 1) + '</span>' +
        '<span style="font-size:11px;color:var(--text-tertiary);">' + v.text.length + 'æ–‡å­—</span></div>';

      if (v.reason) {
        html += '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:6px;padding:4px 8px;background:var(--bg-primary,#fff);border-radius:4px;">ğŸ’¡ ' + self.escapeHtml(v.reason) + '</div>';
      }

      html += '<div style="font-size:14px;line-height:1.7;white-space:pre-wrap;margin-bottom:10px;">' + self.escapeHtml(v.text) + '</div>';

      html += '<div style="display:flex;gap:6px;flex-wrap:wrap;">' +
        '<button class="btn btn-small btn-secondary refine-copy-btn" data-text="' + self.escapeAttr(v.text) + '">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>' +
        '<button class="btn btn-small btn-primary refine-save-btn" data-text="' + self.escapeAttr(v.text) + '">ğŸ’¾ ä¸‹æ›¸ãä¿å­˜</button>' +
        '<button class="btn btn-small btn-secondary refine-replace-btn" data-text="' + self.escapeAttr(v.text) + '" data-id="' + (draftId || '') + '" ' +
          (draftId ? '' : 'disabled style="opacity:0.5;"') + '>ğŸ”„ ä¸Šæ›¸ã</button>' +
      '</div></div>';
    });

    resultArea.innerHTML = html;
    execBtn.textContent = 'âœ¨ ã‚‚ã†ä¸€åº¦ç”Ÿæˆã™ã‚‹';
    execBtn.disabled = false;
    self.bindRefineResultEvents_(resultArea, overlay);

  } catch (e) {
    var errMsg = (e && e.message) ? e.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
    resultArea.innerHTML =
      '<div style="color:#e74c3c;text-align:center;padding:16px;">' +
        '<div style="font-size:14px;margin-bottom:4px;">AIç·¨é›†ã‚¨ãƒ©ãƒ¼</div>' +
        '<div style="font-size:12px;">' + self.escapeHtml(errMsg) + '</div></div>';
    execBtn.textContent = 'å†è©¦è¡Œ';
    execBtn.disabled = false;
  }
};

// â”€â”€ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¢ºå®Ÿã«æŠ½å‡º â”€â”€
App.extractRefineVariants_ = function(res) {
  var raw = res;
  var variants = [];

  // 1. res.results ãŒé…åˆ—ãªã‚‰ãã®ã¾ã¾ä½¿ã†
  if (res && Array.isArray(res.results) && res.results.length > 0) {
    raw = res.results;
  }
  // 2. res.result ãŒæ–‡å­—åˆ—ï¼ˆJSONç”Ÿãƒ†ã‚­ã‚¹ãƒˆï¼‰
  else if (res && typeof res.results === 'string') {
    raw = res.results;
  }
  // 3. res è‡ªä½“ãŒæ–‡å­—åˆ—
  else if (typeof res === 'string') {
    raw = res;
  }

  // æ–‡å­—åˆ—ãªã‚‰JSONãƒ‘ãƒ¼ã‚¹ã‚’è©¦è¡Œ
  if (typeof raw === 'string') {
    // ```json ... ``` ãƒ–ãƒ­ãƒƒã‚¯é™¤å»
    var match = raw.match(/```(?:json)?\s*([\s\S]*?)```/);
    if (match) raw = match[1].trim();

    try {
      raw = JSON.parse(raw);
    } catch (e) {
      // ãƒ‘ãƒ¼ã‚¹ä¸å¯ï¼šãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ãã®ã¾ã¾1ä»¶æ‰±ã„
      return [{ text: raw.replace(/```[\s\S]*?```/g, '').trim(), reason: '' }];
    }
  }

  // é…åˆ—ã¨ã—ã¦å‡¦ç†
  if (Array.isArray(raw)) {
    raw.forEach(function(item) {
      if (typeof item === 'string') {
        variants.push({ text: item.trim(), reason: '' });
      } else if (item && typeof item === 'object') {
        var t = (item.text || item.content || '').trim();
        if (t) {
          variants.push({ text: t, reason: (item.reason || '').trim() });
        }
      }
    });
  }
  // å˜ä¸€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  else if (raw && typeof raw === 'object' && !Array.isArray(raw)) {
    var t = (raw.text || raw.content || '').trim();
    if (t) variants.push({ text: t, reason: (raw.reason || '').trim() });
  }

  return variants;
};

// â”€â”€ AIç·¨é›†çµæœã®ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰ â”€â”€
App.bindRefineResultEvents_ = function(container, overlay) {
  var self = this;

  // ã‚³ãƒ”ãƒ¼
  container.querySelectorAll('.refine-copy-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      self.copyToClipboard(this.getAttribute('data-text'));
    });
  });

  // ä¸‹æ›¸ãä¿å­˜ï¼ˆæ–°è¦ï¼‰
  container.querySelectorAll('.refine-save-btn').forEach(function(btn) {
    btn.addEventListener('click', async function() {
      var text = this.getAttribute('data-text');
      var saveBtn = this;
      saveBtn.disabled = true;
      saveBtn.textContent = 'â³ ä¿å­˜ä¸­â€¦';
      try {
        await self.api('saveDraft', { text: text, type: 'single', source: 'ai_generated' });
        saveBtn.textContent = 'âœ… ä¿å­˜æ¸ˆã¿';
        self.showToast('ä¸‹æ›¸ãã«ä¿å­˜ã—ã¾ã—ãŸ', 'success');
      } catch (e) {
        saveBtn.textContent = 'ğŸ’¾ ä¸‹æ›¸ãä¿å­˜';
        saveBtn.disabled = false;
        self.showToast('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error');
      }
    });
  });

  // ä¸Šæ›¸ãï¼ˆæ—¢å­˜ã®ä¸‹æ›¸ãã‚’ç½®ãæ›ãˆï¼‰
  container.querySelectorAll('.refine-replace-btn').forEach(function(btn) {
    btn.addEventListener('click', async function() {
      var text = this.getAttribute('data-text');
      var id = this.getAttribute('data-id');
      if (!id) return;
      if (!confirm('ã“ã®å†…å®¹ã§å…ƒã®ä¸‹æ›¸ãã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) return;
      var replaceBtn = this;
      replaceBtn.disabled = true;
      replaceBtn.textContent = 'â³ ä¸Šæ›¸ãä¸­â€¦';
      try {
        // å…ƒã‚’å‰Šé™¤ â†’ æ–°è¦ä¿å­˜
        await self.api('deleteDraft', { draftId: id });
        await self.api('saveDraft', { text: text, type: 'single', source: 'ai_generated' });
        replaceBtn.textContent = 'âœ… ä¸Šæ›¸ãæ¸ˆã¿';
        self.showToast('ä¸Šæ›¸ãã—ã¾ã—ãŸ', 'success');
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ãƒªã‚¹ãƒˆæ›´æ–°
        if (overlay && overlay.parentNode) document.body.removeChild(overlay);
        self.fetchDraftsList_();
      } catch (e) {
        replaceBtn.textContent = 'ğŸ”„ ä¸Šæ›¸ã';
        replaceBtn.disabled = false;
        self.showToast('ä¸Šæ›¸ãã‚¨ãƒ©ãƒ¼', 'error');
      }
    });
  });
};

// â”€â”€ æ‰‹å‹•è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€
App.showAddDraftModal_ = function() {
  var self = this;
  var overlay = document.createElement('div');
  overlay.id = 'draftModal';
  overlay.setAttribute('role', 'dialog');
  overlay.setAttribute('aria-modal', 'true');
  overlay.setAttribute('aria-label', 'ä¸‹æ›¸ãè¿½åŠ ');
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;padding:20px;';
  overlay.innerHTML = '<div style="background:var(--bg-primary,#fff);border-radius:16px;padding:24px;max-width:450px;width:100%;">' +
    '<div style="font-size:18px;font-weight:bold;margin-bottom:16px;">ä¸‹æ›¸ãã‚’è¿½åŠ </div>' +
    '<textarea id="manualDraftText" class="textarea" placeholder="æŠ•ç¨¿æ–‡ã‚’å…¥åŠ›..." style="min-height:120px;margin-bottom:8px;"></textarea>' +
    '<p style="font-size:11px;color:#999;margin-bottom:12px;">ğŸ’¡ ãƒ„ãƒªãƒ¼æŠ•ç¨¿ã®å ´åˆã¯ç©ºè¡Œï¼ˆ2å›æ”¹è¡Œï¼‰ã§åŒºåˆ‡ã‚‹ã¨ã€è¦ªæŠ•ç¨¿ï¼‹è¿”ä¿¡ã«è‡ªå‹•åˆ†å‰²ã•ã‚Œã¾ã™</p>' +
    '<div class="btn-group">' +
      '<button id="cancelDraftBtn" class="btn btn-secondary" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>' +
      '<button id="saveSingleDraftBtn" class="btn btn-primary" style="flex:1;">ğŸ’¾ ä¿å­˜</button>' +
      '<button id="saveThreadDraftBtn" class="btn btn-primary" style="flex:1;background:#7C3AED;">ğŸ§µ ãƒ„ãƒªãƒ¼ä¿å­˜</button></div></div>';
  document.body.appendChild(overlay);

  overlay.addEventListener('click', function(e) { if (e.target === overlay) document.body.removeChild(overlay); });
  document.getElementById('cancelDraftBtn').addEventListener('click', function() { document.body.removeChild(overlay); });

  document.getElementById('saveSingleDraftBtn').addEventListener('click', async function() {
    var text = document.getElementById('manualDraftText').value.trim();
    if (!text) { self.showToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    try {
      await self.api('saveDraft', { text: text, type: 'single', source: 'manual' });
      document.body.removeChild(overlay);
      self.showToast('ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
      self.fetchDraftsList_();
    } catch (e) { self.showToast('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error'); }
  });

  document.getElementById('saveThreadDraftBtn').addEventListener('click', async function() {
    var text = document.getElementById('manualDraftText').value.trim();
    if (!text) { self.showToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    try {
      await self.api('saveDraft', { text: text, type: 'thread', source: 'manual' });
      document.body.removeChild(overlay);
      self.showToast('ãƒ„ãƒªãƒ¼ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
      self.fetchDraftsList_();
    } catch (e) { self.showToast('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error'); }
  });
};
</script>

