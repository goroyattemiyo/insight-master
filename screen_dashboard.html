<script>
// ===========================================
// Dashboard ç”»é¢ï¼ˆä¿®æ­£ç‰ˆï¼‰
// ===========================================
App.renderDashboardContent = function() {
  var u = this.state.user || {};
  var activeAcc = this.state.activeAccount;
  var displayName = activeAcc ? activeAcc.username : (u.username || '---');
  var displayPic = activeAcc ? activeAcc.profilePicUrl : (u.profilePicUrl || '');

  var showGeminiBanner = !this.state.settings.hasGeminiKey && !sessionStorage.getItem('hideGeminiBanner');

  return '<div class="screen-content">' +
    '<div class="card"><div class="flex-row gap-12">' +
  (displayPic ? '<img src="' + displayPic + '" class="avatar">' : '<div class="avatar-placeholder">ğŸ‘¤</div>') +
  '<div><div class="text-subheading">@' + this.escapeHtml(displayName) + '</div>' +
  '<div class="text-caption">ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­</div></div></div></div>' +
    (showGeminiBanner ?
      '<div class="card warning-banner card-no-border">' +
        '<div class="flex-between mb-8">' +
          '<div class="flex-row gap-8">' +
            '<div class="icon-lg">âœ¨</div>' +
            '<div class="text-subheading">AIæ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ã‚‡ã†</div>' +
          '</div>' +
          '<button id="closeGeminiBanner" class="btn btn-secondary btn-small">Ã—</button>' +
        '</div>' +
        '<div class="text-body mb-12">Gemini APIã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã¨ã€AIæŠ•ç¨¿ç”Ÿæˆãƒ»åˆ†æãƒ¬ãƒãƒ¼ãƒˆãƒ»æ”¹å–„ææ¡ˆãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</div>' +
        '<button id="goGeminiSettings" class="btn btn-small">APIã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹</button>' +
      '</div>' : '') +
    '<div id="autoRefreshIndicator" class="card mb-8" style="display:none;padding:12px 16px;">' +
      '<div class="flex-row gap-10" style="align-items:center;">' +
        '<div class="loading-spinner" style="width:18px;height:18px;"></div>' +
        '<div>' +
          '<div class="text-subheading">è‡ªå‹•æ›´æ–°ä¸­</div>' +
          '<div class="text-caption">æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™...</div>' +
        '</div>' +
      '</div>' +
    '</div>' +
    // â˜…FIX BUG-2: äºŒé‡æç”»ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ï¼ˆä¸Šã®1ãƒ–ãƒ­ãƒƒã‚¯ã®ã¿æ®‹ã™ï¼‰
      this.renderTips([
      { title: 'ğŸ“Š ãƒ“ãƒ¥ãƒ¼æ•°ã®è¦‹æ–¹', body: 'éå»7æ—¥é–“ã®ç·é–²è¦§æ•°ã§ã™ã€‚å‰é€±ã¨æ¯”è¼ƒã—ã¦å¢—æ¸›ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚æ€¥å¢—ã—ãŸæ—¥ãŒã‚ã‚Œã°ã€ãã®æ—¥ã®æŠ•ç¨¿ãŒåˆºã•ã£ãŸè¨¼æ‹ ã§ã™ã€‚' },
      { title: 'ğŸ“ˆ ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡ï¼ˆERï¼‰ã¨ã¯', body: 'ER =ï¼ˆã„ã„ã­ï¼‹è¿”ä¿¡ï¼‹ãƒªãƒã‚¹ãƒˆï¼‹å¼•ç”¨ï¼‰Ã· ãƒ“ãƒ¥ãƒ¼ Ã— 100ã€‚<br><b>1%æœªæº€</b>: è¦æ”¹å–„ / <b>1ã€œ3%</b>: å¹³å‡çš„ / <b>3ã€œ6%</b>: å„ªç§€ / <b>6%ä»¥ä¸Š</b>: ãƒã‚ºã®å¯èƒ½æ€§å¤§ã€‚ã‚ãªãŸã®ç¾åœ¨ã®ERã‚’ä¸‹ã®æŠ•ç¨¿ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚' },
      { title: 'ğŸ‘¥ ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å±æ€§ã®æ´»ç”¨æ³•', body: 'å›½ãƒ»éƒ½å¸‚ãƒ»å¹´é½¢ãƒ»æ€§åˆ¥ã‚’è¦‹ã¦ã€Œèª°ã«å±Šã„ã¦ã„ã‚‹ã‹ã€ã‚’æŠŠæ¡ã€‚ä¾‹ãˆã°35-44æ­³ã®æ—¥æœ¬ç”·æ€§ãŒå¤šã„ãªã‚‰ã€ãã®å±¤ã«åˆºã•ã‚‹ãƒ†ãƒ¼ãƒï¼ˆä»•äº‹è¡“ãƒ»å‰¯æ¥­ãƒ»ç”Ÿæ´»æ”¹å–„ãªã©ï¼‰ã‚’é¸ã¶ã¨åŠ¹æœçš„ã§ã™ã€‚' },
      { title: 'ğŸ¤– AIã¸ã®æ´»ã‹ã—æ–¹', body: 'ã€ŒAIç”Ÿæˆã€â†’ã€ŒğŸ“Š åˆ†æãƒ™ãƒ¼ã‚¹ã€ã‚’ä½¿ã†ã¨ã€ã“ã“ã®æ•°å€¤ãŒè‡ªå‹•ã§AIã«æ¸¡ã•ã‚Œã¾ã™ã€‚é«˜ERã®æŠ•ç¨¿ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ç¿’ã—ã¦ã€æ¬¡ã®ãƒã‚ºæŠ•ç¨¿ã‚’ææ¡ˆã—ã¦ãã‚Œã¾ã™ã€‚' },
      { title: 'ğŸ“‹ æ‰‹å‹•æŠ•ç¨¿ã®æµã‚Œ', body: 'AIç”Ÿæˆ â†’ ä¸‹æ›¸ãä¿å­˜ â†’ ä¸‹æ›¸ãç”»é¢ã§ã‚³ãƒ”ãƒ¼ â†’ Threadsã‚¢ãƒ—ãƒªã«è²¼ã‚Šä»˜ã‘ã¦æŠ•ç¨¿ã€‚ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³1ã¤ã§æ‰‹è»½ã«æŠ•ç¨¿ã§ãã¾ã™ã€‚' }
    ]) +
    // â˜…SKELETON: ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚¨ãƒªã‚¢ã«ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚’åˆæœŸè¡¨ç¤º
    '<div id="userInsightsArea">' + this.renderSkeletonDashboard() + '</div>' +
    '<div class="card mb-16" id="followerChartCard">' +
      '<div class="flex-row gap-8 mb-12">' +
        '<div class="card-title" style="flex:1;">ğŸ“ˆ ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ¨ç§»</div>' +
        '<div class="btn-group">' +
          '<button class="subtab active" data-follower-days="7">7æ—¥</button>' +
          '<button class="subtab" data-follower-days="30">30æ—¥</button>' +
          '<button class="subtab" data-follower-days="90">90æ—¥</button>' +
        '</div>' +
      '</div>' +
      '<div id="followerSummary" class="flex-row gap-12 mb-12"></div>' +
      '<canvas id="followerCanvas" width="600" height="200" style="width:100%;height:200px;"></canvas>' +
      '<div class="flex-row gap-8 mt-8">' +
        '<button id="exportFollowerCSV" class="btn btn-secondary btn-small" style="flex:1;">ğŸ“¥ CSV</button>' +
        '<button id="exportFollowerImg" class="btn btn-secondary btn-small" style="flex:1;">ğŸ“· ç”»åƒä¿å­˜</button>' +
      '</div>' +
      '<div class="mt-8"><button id="setupFollowerTriggerBtn" class="btn btn-secondary btn-full btn-small">â° æ¯æ—¥è‡ªå‹•è¨˜éŒ²ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button></div>' +
    '</div>' +
    '<div id="demographicsArea"></div>' +
    '<div id="summaryArea"></div>' +
    '<div class="card">' +
      '<div id="lastUpdateLabel" class="text-caption mb-8">æœ€çµ‚æ›´æ–°: -</div>' +
      '<button id="refreshDashboardBtn" class="btn btn-primary btn-full" style="margin-bottom:8px;">ğŸ”„ @' + this.escapeHtml(displayName) + ' ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</button>' +
      '<button id="goToDetailBtn" class="btn btn-secondary btn-full">ğŸ“ˆ è©³ç´°åˆ†æãƒ»æ™‚é–“å¸¯åˆ†æ</button>' +
      // â˜…FIX: ç«¶åˆåˆ†æãƒœã‚¿ãƒ³å‰Šé™¤
    '</div>' +
    // â˜…FIX BUG-6: AIåˆ†æã‚«ãƒ¼ãƒ‰ã‚’ç‹¬ç«‹ï¼ˆãƒã‚¹ãƒˆè§£æ¶ˆï¼‰
    '<div class="card">' +
      '<div class="card-title">ğŸ¤– AIåˆ†æ</div>' +
      '<div style="display:flex;gap:8px;flex-wrap:wrap;">' +
        '<button id="aiReportBtn" class="btn btn-small btn-secondary" style="flex:1;min-width:140px;">ğŸ“Š åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</button>' +
        '<button id="aiSuggestBtn" class="btn btn-small btn-secondary" style="flex:1;min-width:140px;">ğŸ’¡ æ”¹å–„ææ¡ˆ</button>' +
      '</div>' +
      '<div id="aiDashboardResult" style="margin-top:12px;"></div>' +
    '</div>' +
    '<div class="card">' +
      '<div class="flex-row gap-8 mb-12">' +
        '<div class="card-title" style="flex:1;">ğŸ“‹ é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</div>' +
        '<button id="setupWeeklyTriggerBtn" class="btn btn-secondary btn-small">â° è‡ªå‹•ç”Ÿæˆ</button>' +
      '</div>' +
      '<div id="weeklyReportArea">' +
        '<button id="generateWeeklyBtn" class="btn btn-primary btn-full mb-8">ğŸ“‹ ä»Šé€±ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ</button>' +
        '<div id="weeklyReportContent"></div>' +
        '<div id="weeklyReportList" class="mt-12"></div>' +
      '</div>' +
    '</div>' +
  '</div>';
};

App.loadDashboard = async function() {
  var self = this;

  var closeBanner = document.getElementById('closeGeminiBanner');
  if (closeBanner) {
    closeBanner.addEventListener('click', function() {
      sessionStorage.setItem('hideGeminiBanner', '1');
      var card = this.closest('.card');
      if (card) card.remove();
    });
  }
  var goSettings = document.getElementById('goGeminiSettings');
  if (goSettings) {
    goSettings.addEventListener('click', function() { self.showScreen('settings'); });
  }
  
  var refreshHandler = async function() {
    var btn = this;
    btn.disabled = true; btn.textContent = 'æ›´æ–°ä¸­ï¼ˆ1ã€œ2åˆ†ã‹ã‹ã‚Šã¾ã™ï¼‰...';
    try {
      self.showToast('æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...', 'info');
      var fetchResult = await self.api('fetchAndStorePostAnalytics', {});
      self.showToast(fetchResult.accountUsername ? '@' + fetchResult.accountUsername + ': ' + fetchResult.total + 'ä»¶å–å¾—' : 'å–å¾—å®Œäº†', 'info');
      self.showToast('æ™‚é–“å¸¯åˆ†æã‚’ç”Ÿæˆä¸­...', 'info');
      await self.api('generateTimeAnalysis', {});
      self.showToast('ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†ï¼', 'success');
    } catch (e) { self.showToast('æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error'); }
    btn.disabled = false;
    var acc = self.state.activeAccount;
    btn.textContent = 'ğŸ”„ @' + (acc ? acc.username : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼') + ' ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°';
    self.loadDashboardData_();
  };
  self.refreshDashboardHandler_ = refreshHandler;
  var refreshBtn = document.getElementById('refreshDashboardBtn');
  if (refreshBtn && !refreshBtn.dataset.bound) {
    refreshBtn.dataset.bound = 'true';
    refreshBtn.addEventListener('click', refreshHandler);
  }
  document.getElementById('goToDetailBtn').addEventListener('click', function() {
    self.state.analyticsTab = 'posts';
    self.showScreen('analytics');
  });

  await this.loadDashboardData_();
  this.bindDashboardRefreshButtons_();
  this.updateLastFetchLabel_();
  this.maybeAutoRefreshDashboard_();

  var aiReportBtn = document.getElementById('aiReportBtn');
  if (aiReportBtn) {
    aiReportBtn.addEventListener('click', function() {
      self.dashboardRunAI_('generateAnalysisReport', 'ğŸ“Š åˆ†æãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­...', this);
    });
  }
  var aiSuggestBtn = document.getElementById('aiSuggestBtn');
  if (aiSuggestBtn) {
    aiSuggestBtn.addEventListener('click', function() {
      self.dashboardRunAI_('generateImprovementSuggestions', 'ğŸ’¡ æ”¹å–„ææ¡ˆç”Ÿæˆä¸­...', this);
    });
  }

  this.bindWeeklyReportEvents_();
  this.loadWeeklyReportList_();
};

App.loadDashboardData_ = async function() {
  var uiArea = document.getElementById('userInsightsArea');
  var demoArea = document.getElementById('demographicsArea');
  var sumArea = document.getElementById('summaryArea');
  var fetchedOk = false;
  var insPromise = this.api('fetchUserInsights', { sinceDays: 7 })
    .then(function(value) { return { ok: true, value: value }; })
    .catch(function(error) { return { ok: false, error: error }; });
  var analyticsPromise = this.api('getAnalyticsData', { periodDays: 7 })
    .then(function(value) { return { ok: true, value: value }; })
    .catch(function(error) { return { ok: false, error: error }; });
  var results = await Promise.all([insPromise, analyticsPromise]);
  var insResult = results[0];
  var analyticsResult = results[1];
  if (insResult.ok) {
    var ins = insResult.value;
    this.state.userInsights = ins;
    var accLabel = ins.accountUsername ? '@' + this.escapeHtml(ins.accountUsername) : '';
    
    uiArea.innerHTML = '<div class="card"><div class="card-title">' + accLabel + ' éå»7æ—¥é–“ã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</div>' +
      '<div class="metric-grid">' +
        this.renderMetricCard('ğŸ‘', 'ãƒ“ãƒ¥ãƒ¼', ins.views) +
        this.renderMetricCard('ğŸ‘¥', 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼', ins.followersCount) +
        this.renderMetricCard('â¤ï¸', 'ã„ã„ã­', ins.likes) +
        this.renderMetricCard('ğŸ’¬', 'è¿”ä¿¡', ins.replies) +
        this.renderMetricCard('ğŸ”„', 'ãƒªãƒã‚¹ãƒˆ', ins.reposts) +
        this.renderMetricCard('ğŸ’', 'å¼•ç”¨', ins.quotes) +
        this.renderMetricCard('ğŸ”—', 'ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯', ins.clicks) +
      '</div></div>';
    fetchedOk = true;
    if (ins.demographics) {
      demoArea.innerHTML = this.renderDemographics_(ins.demographics);
    }
  } else {
    var insMsg = (insResult.error && insResult.error.message) ? insResult.error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
    uiArea.innerHTML = '<div class="card empty-state">' +
      '<div class="empty-state-icon">âš ï¸</div>' +
      '<div class="empty-state-title">ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>' +
      '<div class="empty-state-desc">' + this.escapeHtml(insMsg) + '</div>' +
      '</div>';
    demoArea.innerHTML = '';
  }
  if (analyticsResult.ok) {
    var a = analyticsResult.value;
    if (a && a.summary && a.summary.totalPosts > 0) {
      var s = a.summary;
      sumArea.innerHTML = '<div class="card"><div class="card-title">æŠ•ç¨¿ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆ7æ—¥é–“ï¼‰</div>' +
        '<div class="metric-grid">' +
          this.renderMetricCard('ğŸ“', 'æŠ•ç¨¿æ•°', s.totalPosts) +
          this.renderMetricCard('ğŸ“ˆ', 'å¹³å‡ER', s.avgEngagementRate + '%') +
          this.renderMetricCard('ğŸ‘', 'ç·ãƒ“ãƒ¥ãƒ¼', s.totalViews) +
          this.renderMetricCard('â¤ï¸', 'ç·ã„ã„ã­', s.totalLikes) +
          this.renderMetricCard('ğŸ”„', 'ç·ãƒªãƒã‚¹ãƒˆ', s.totalReposts) +
          this.renderMetricCard('ğŸ“¤', 'ç·ã‚·ã‚§ã‚¢', s.totalShares) +
        '</div></div>';
    } else {
      sumArea.innerHTML = '<div class="card empty-state">' +
        '<div class="empty-state-icon">ğŸ“¥</div>' +
        '<div class="empty-state-title">æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>' +
        '<div class="empty-state-desc">ã¾ãšã¯æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„</div>' +
        '<button id="summaryRefreshBtn" class="btn btn-primary btn-full">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</button>' +
      '</div>';
      this.bindDashboardRefreshButtons_();
    }
    fetchedOk = true;
  }

  if (fetchedOk) {
    var accountId = (this.state.activeAccount && this.state.activeAccount.accountId) || 'default';
    var key = 'insight_master_last_fetch_' + accountId;
    localStorage.setItem(key, String(Date.now()));
    this.updateLastFetchLabel_();
  }
  // ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ¨ç§»ã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿ï¼ˆfetchedOk ã«é–¢ä¿‚ãªãå®Ÿè¡Œï¼‰
  this.loadFollowerChart_(7);
  this.bindFollowerChartEvents_();
};

App.bindDashboardRefreshButtons_ = function() {
  var handler = this.refreshDashboardHandler_;
  if (!handler) return;
  var btns = [
    document.getElementById('refreshDashboardBtn'),
    document.getElementById('summaryRefreshBtn')
  ];
  btns.forEach(function(btn) {
    if (btn && !btn.dataset.bound) {
      btn.dataset.bound = 'true';
      btn.addEventListener('click', handler);
    }
  });
};

App.maybeAutoRefreshDashboard_ = function() {
  var self = this;
  if (this.dashboardAutoRefreshRunning_) return;
  var accountId = (this.state.activeAccount && this.state.activeAccount.accountId) || 'default';
  var key = 'insight_master_last_fetch_' + accountId;
  var last = parseInt(localStorage.getItem(key) || '0', 10);
  if (last && (Date.now() - last) < (6 * 60 * 60 * 1000)) return;
  var indicator = document.getElementById('autoRefreshIndicator');
  if (indicator) indicator.style.display = 'block';
  this.dashboardAutoRefreshRunning_ = true;
  Promise.resolve()
    .then(function() { return Promise.all([
      self.api('fetchAndStorePostAnalytics', {}),
      self.api('generateTimeAnalysis', {})
    ]); })
    .then(function() { return self.loadDashboardData_(); })
    .catch(function() { /* ignore */ })
    .finally(function() {
      if (indicator) indicator.style.display = 'none';
      self.dashboardAutoRefreshRunning_ = false;
    });
};

App.updateLastFetchLabel_ = function() {
  var accountId = (this.state.activeAccount && this.state.activeAccount.accountId) || 'default';
  var key = 'insight_master_last_fetch_' + accountId;
  var last = parseInt(localStorage.getItem(key) || '0', 10);
  var label = document.getElementById('lastUpdateLabel');
  if (!label) return;
  if (!last) {
    label.textContent = 'æœ€çµ‚æ›´æ–°: -';
    label.removeAttribute('title');
    return;
  }
  label.textContent = 'æœ€çµ‚æ›´æ–°: ' + this.formatTimeAgo_(last);
  label.setAttribute('title', new Date(last).toLocaleString('ja-JP'));
};

App.formatTimeAgo_ = function(ts) {
  var diff = Math.max(0, Date.now() - ts);
  var min = Math.floor(diff / 60000);
  if (min < 1) return 'ãŸã£ãŸä»Š';
  if (min < 60) return min + 'åˆ†å‰';
  var hours = Math.floor(min / 60);
  if (hours < 24) return hours + 'æ™‚é–“å‰';
  var days = Math.floor(hours / 24);
  return days + 'æ—¥å‰';
};

App.renderDemographics_ = function(demo) {
  var html = '<div class="card"><div class="card-title">ğŸ‘¥ ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å±æ€§</div>';
  html += '<div class="grid-2" style="gap:16px;">';
  var sections = [
    { key: 'country', icon: 'ğŸŒ', label: 'å›½', max: 5 },
    { key: 'city',    icon: 'ğŸ™ï¸', label: 'éƒ½å¸‚', max: 5 },
    { key: 'age',     icon: 'ğŸ“Š', label: 'å¹´é½¢', max: 10 },
    { key: 'gender',  icon: 'ğŸ‘¤', label: 'æ€§åˆ¥', max: 5 }
  ];
  for (var s = 0; s < sections.length; s++) {
    var sec = sections[s];
    var data = demo[sec.key];
    if (data && typeof data === 'object' && Object.keys(data).length > 0) {
      html += '<div>';
      html += '<div style="font-weight:600;font-size:13px;margin-bottom:8px;">' + sec.icon + ' ' + sec.label + '</div>';
      html += this.renderDemoBreakdown_(data, sec.max);
      html += '</div>';
    }
  }
  html += '</div></div>';
  return html;
};

App.renderDemoBreakdown_ = function(data, maxItems) {
  var html = '';
  var genderMap = { M: 'ç”·æ€§', F: 'å¥³æ€§', U: 'æœªè¨­å®š' };
  var items = [];
  var keys = Object.keys(data);
  for (var i = 0; i < keys.length; i++) {
    items.push({ label: keys[i], value: data[keys[i]] });
  }
  items.sort(function(a, b) { return b.value - a.value; });
  if (items.length > maxItems) items = items.slice(0, maxItems);
  var maxVal = items.length > 0 ? items[0].value : 1;
  var total = 0;
  for (var i = 0; i < items.length; i++) total += items[i].value;
  for (var i = 0; i < items.length; i++) {
    var item = items[i];
    var label = genderMap[item.label] || item.label;
    var pct = total > 0 ? Math.round((item.value / total) * 100) : 0;
    var barWidth = maxVal > 0 ? Math.round((item.value / maxVal) * 100) : 0;
    html += '<div style="margin-bottom:6px;">';
    html += '<div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:2px;">';
    html += '<span>' + label + '</span>';
    html += '<span style="color:var(--text-secondary);">' + item.value + 'äºº (' + pct + '%)</span>';
    html += '</div>';
    html += '<div class="demo-bar-track">';
    html += '<div class="demo-bar-fill" style="width:' + barWidth + '%;"></div>';
    html += '</div></div>';
  }
  return html;
};

App.dashboardRunAI_ = function(action, loadingText, btn) {
  var self = this;
  var resultDiv = document.getElementById('aiDashboardResult');
  if (!resultDiv) return;
  btn.disabled = true;
  var origText = btn.textContent;
  btn.textContent = loadingText;
  resultDiv.innerHTML = '<div style="text-align:center;padding:20px;"><div class="loading-spinner" style="margin:0 auto 12px;"></div><div class="text-caption">Gemini AIãŒåˆ†æä¸­ï¼ˆ15ã€œ45ç§’ï¼‰...</div></div>';
  this.api(action, { periodDays: 30 }).then(function(res) {
    btn.disabled = false;
    btn.textContent = origText;
    var content = res.report || res.suggestions || '';
    if (!content) {
      resultDiv.innerHTML = '<div style="color:var(--text-secondary);font-size:13px;padding:12px;">çµæœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
      return;
    }
    resultDiv.innerHTML = '<div class="ai-result-container">' +
      self.formatMarkdown_(content) +
    '</div>';
  }).catch(function(err) {
    btn.disabled = false;
    btn.textContent = origText;
    resultDiv.innerHTML = '<div style="color:var(--error);font-size:13px;padding:12px;">' + self.escapeHtml(err.message || String(err)) + '</div>';
  });
};

// === ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ¨ç§»ã‚°ãƒ©ãƒ• ===

App.drawFollowerChart = function(canvasId, data) {
  var canvas = document.getElementById(canvasId);
  if (!canvas || !data || !data.dates || data.dates.length === 0) return;
  var ctx = canvas.getContext('2d');
  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  var W = rect.width, H = rect.height;
  var pad = { top: 20, right: 16, bottom: 30, left: 48 };
  var gW = W - pad.left - pad.right;
  var gH = H - pad.top - pad.bottom;

  ctx.clearRect(0, 0, W, H);

  var counts = data.counts;
  var mn = Math.min.apply(null, counts);
  var mx = Math.max.apply(null, counts);
  if (mn === mx) { mn = mn - 10; mx = mx + 10; }
  var range = mx - mn;
  mn = mn - range * 0.1;
  mx = mx + range * 0.1;

  function xPos(i) { return pad.left + (i / (counts.length - 1 || 1)) * gW; }
  function yPos(v) { return pad.top + gH - ((v - mn) / (mx - mn)) * gH; }

  // Grid lines
  var isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  ctx.strokeStyle = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.08)';
  ctx.lineWidth = 1;
  for (var g = 0; g <= 4; g++) {
    var gy = pad.top + (gH / 4) * g;
    ctx.beginPath(); ctx.moveTo(pad.left, gy); ctx.lineTo(W - pad.right, gy); ctx.stroke();
  }

  // Gradient fill
  var grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + gH);
  grad.addColorStop(0, isDark ? 'rgba(99,102,241,0.3)' : 'rgba(99,102,241,0.15)');
  grad.addColorStop(1, 'rgba(99,102,241,0)');
  ctx.beginPath();
  ctx.moveTo(xPos(0), yPos(counts[0]));
  for (var i = 1; i < counts.length; i++) ctx.lineTo(xPos(i), yPos(counts[i]));
  ctx.lineTo(xPos(counts.length - 1), pad.top + gH);
  ctx.lineTo(xPos(0), pad.top + gH);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.moveTo(xPos(0), yPos(counts[0]));
  for (var i = 1; i < counts.length; i++) ctx.lineTo(xPos(i), yPos(counts[i]));
  ctx.strokeStyle = '#6366f1';
  ctx.lineWidth = 2.5;
  ctx.lineJoin = 'round';
  ctx.stroke();

  // Dots
  for (var i = 0; i < counts.length; i++) {
    ctx.beginPath();
    ctx.arc(xPos(i), yPos(counts[i]), 3.5, 0, Math.PI * 2);
    ctx.fillStyle = '#6366f1';
    ctx.fill();
    ctx.strokeStyle = isDark ? '#1e1e2e' : '#ffffff';
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  // X labels
  ctx.fillStyle = isDark ? '#94a3b8' : '#64748b';
  ctx.font = '11px sans-serif';
  ctx.textAlign = 'center';
  var step = counts.length <= 7 ? 1 : counts.length <= 30 ? 5 : 15;
  for (var i = 0; i < data.dates.length; i += step) {
    ctx.fillText(data.dates[i], xPos(i), H - 8);
  }

  // Y labels
  ctx.textAlign = 'right';
  for (var g = 0; g <= 4; g++) {
    var val = Math.round(mx - ((mx - mn) / 4) * g);
    var gy = pad.top + (gH / 4) * g;
    ctx.fillText(val.toLocaleString(), pad.left - 6, gy + 4);
  }
};

App.renderFollowerSummary_ = function(data) {
  var el = document.getElementById('followerSummary');
  if (!el || !data || data.counts.length === 0) {
    if (el) el.innerHTML = '<div class="text-caption">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨­å®šç”»é¢ã§ãƒˆãƒªã‚¬ãƒ¼ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚</div>';
    return;
  }
  var current = data.counts[data.counts.length - 1];
  var prev = data.counts.length > 1 ? data.counts[data.counts.length - 2] : current;
  var first = data.counts[0];
  var dailyChange = current - prev;
  var periodChange = current - first;
  var periodPct = first > 0 ? Math.round(periodChange / first * 1000) / 10 : 0;
  var trendIcon = dailyChange > 0 ? 'ğŸ“ˆ' : dailyChange < 0 ? 'ğŸ“‰' : 'â¡ï¸';
  var trendColor = dailyChange > 0 ? 'var(--success)' : dailyChange < 0 ? 'var(--error)' : 'var(--text-secondary)';

  el.innerHTML =
    '<div style="flex:1;text-align:center;">' +
      '<div style="font-size:24px;font-weight:700;color:var(--text-primary);">' + current.toLocaleString() + '</div>' +
      '<div class="text-caption">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</div>' +
    '</div>' +
    '<div style="flex:1;text-align:center;">' +
      '<div style="font-size:18px;font-weight:600;color:' + trendColor + ';">' + trendIcon + ' ' + (dailyChange >= 0 ? '+' : '') + dailyChange + '</div>' +
      '<div class="text-caption">å‰æ—¥æ¯”</div>' +
    '</div>' +
    '<div style="flex:1;text-align:center;">' +
      '<div style="font-size:18px;font-weight:600;color:' + trendColor + ';">' + (periodPct >= 0 ? '+' : '') + periodPct + '%</div>' +
      '<div class="text-caption">æœŸé–“å¤‰å‹•</div>' +
    '</div>';
};

App.loadFollowerChart_ = async function(days) {
  try {
    var data = await this.api('getFollowerHistory', { days: days || 7 });
    if (data) {
      this.followerData_ = data;
      this.renderFollowerSummary_(data);
      this.drawFollowerChart('followerCanvas', data);
    }
  } catch (e) {
    console.error('loadFollowerChart_ error:', e);
  }
};

App.bindFollowerChartEvents_ = function() {
  var self = this;
  var btns = document.querySelectorAll('[data-follower-days]');
  btns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      btns.forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      self.loadFollowerChart_(parseInt(btn.getAttribute('data-follower-days')));
    });
  });

  var csvBtn = document.getElementById('exportFollowerCSV');
  if (csvBtn) csvBtn.addEventListener('click', function() {
    var d = self.followerData_;
    if (!d || !d.dates.length) { self.showToast('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error'); return; }
    var headers = ['æ—¥ä»˜', 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°', 'å‰æ—¥æ¯”'];
    var rows = d.dates.map(function(date, i) { return [date, d.counts[i], d.changes[i]]; });
    self.exportCSV('followers', headers, rows);
  });

  var imgBtn = document.getElementById('exportFollowerImg');
  if (imgBtn) imgBtn.addEventListener('click', function() {
    self.exportAsImage('followerCanvas', 'followers_chart');
  });

  var triggerBtn = document.getElementById('setupFollowerTriggerBtn');
  if (triggerBtn) triggerBtn.addEventListener('click', async function() {
    triggerBtn.disabled = true;
    triggerBtn.textContent = 'è¨­å®šä¸­...';
    try {
      var r = await self.api('setupFollowerTrigger', {});
      self.showToast(r.message || 'ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ', 'success');
      triggerBtn.textContent = 'âœ… è‡ªå‹•è¨˜éŒ²ãŒæœ‰åŠ¹ã§ã™';
    } catch (e) {
      self.showToast('è¨­å®šã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
      triggerBtn.disabled = false;
      triggerBtn.textContent = 'â° æ¯æ—¥è‡ªå‹•è¨˜éŒ²ã‚’æœ‰åŠ¹ã«ã™ã‚‹';
    }
  });
};

// === é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ ===

App.bindWeeklyReportEvents_ = function() {
  var self = this;
  var genBtn = document.getElementById('generateWeeklyBtn');
  if (genBtn) genBtn.addEventListener('click', async function() {
    genBtn.disabled = true;
    genBtn.textContent = 'ç”Ÿæˆä¸­ï¼ˆ30ç§’ã€œ1åˆ†ï¼‰...';
    try {
      var r = await self.api('generateWeeklyReport', {});
      if (r.message) { self.showToast(r.message, 'info'); }
      else { self.showToast('é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success'); }
      self.renderWeeklyReport_(r);
      self.loadWeeklyReportList_();
    } catch (e) { self.showToast('ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + e.message, 'error'); }
    genBtn.disabled = false;
    genBtn.textContent = 'ğŸ“‹ ä»Šé€±ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ';
  });

  var trigBtn = document.getElementById('setupWeeklyTriggerBtn');
  if (trigBtn) trigBtn.addEventListener('click', async function() {
    trigBtn.disabled = true;
    try {
      var r = await self.api('setupWeeklyTrigger', {});
      self.showToast(r.message || 'è¨­å®šã—ã¾ã—ãŸ', 'success');
      trigBtn.textContent = 'âœ… è‡ªå‹•ç”ŸæˆON';
    } catch (e) {
      self.showToast('è¨­å®šã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
      trigBtn.disabled = false;
    }
  });
};

App.renderWeeklyReport_ = function(data) {
  var el = document.getElementById('weeklyReportContent');
  if (!el || !data) return;
  if (data.message && !data.summary) {
    el.innerHTML = '<div class="text-caption">' + this.escapeHtml(data.message) + '</div>';
    return;
  }
  var s = data.summary || {};
  var f = data.followers || {};
  var fSign = f.change >= 0 ? '+' : '';
  var html = '<div class="text-caption mb-8">' + this.escapeHtml(data.weekStart || '') + ' ã€œ ' + this.escapeHtml(data.weekEnd || '') + '</div>';
  html += '<div class="metric-grid">' +
    this.renderMetricCard('ğŸ‘¥', 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼', (f.end || 0) + ' (' + fSign + (f.change || 0) + ')') +
    this.renderMetricCard('ğŸ‘', 'ç·ãƒ“ãƒ¥ãƒ¼', s.totalViews) +
    this.renderMetricCard('ğŸ“ˆ', 'å¹³å‡ER', (s.avgEngagementRate || 0) + '%') +
    this.renderMetricCard('ğŸ“', 'æŠ•ç¨¿æ•°', s.totalPosts) +
  '</div>';
  if (data.topPosts && data.topPosts.length > 0) {
    html += '<div class="text-subheading mt-12 mb-8">ğŸ† TOPæŠ•ç¨¿</div>';
    data.topPosts.forEach(function(p) {
      html += '<div style="padding:8px;background:var(--bg-secondary);border-radius:8px;margin-bottom:6px;font-size:13px;">' +
        '<span style="color:var(--success);font-weight:700;">ER ' + (p.er || 0).toFixed(1) + '%</span> ' +
        this.escapeHtml(p.text || '') + '</div>';
    }.bind(this));
  }
  if (data.aiSummary) {
    html += '<div class="mt-12"><div class="text-subheading mb-8">ğŸ¤– AIåˆ†æ</div>' +
      '<div class="ai-result-container">' + this.formatMarkdown_(data.aiSummary) + '</div></div>';
  }
  html += '<div class="flex-row gap-8 mt-12">' +
    '<button id="exportWeeklyCSV" class="btn btn-secondary btn-small" style="flex:1;">ğŸ“¥ CSVå‡ºåŠ›</button>' +
    '</div>';
  el.innerHTML = html;
  var weeklyData = data;
  var csvBtn = document.getElementById('exportWeeklyCSV');
  if (csvBtn) csvBtn.addEventListener('click', function() {
    var s = weeklyData.summary || {};
    var f = weeklyData.followers || {};
    var headers = ['é€±é–‹å§‹', 'é€±çµ‚äº†', 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼é–‹å§‹', 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼çµ‚äº†', 'å¢—æ¸›', 'ç·ãƒ“ãƒ¥ãƒ¼', 'ã„ã„ã­', 'è¿”ä¿¡', 'ãƒªãƒã‚¹ãƒˆ', 'å¹³å‡ER(%)', 'æŠ•ç¨¿æ•°'];
    var rows = [[weeklyData.weekStart, weeklyData.weekEnd, f.start||0, f.end||0, f.change||0, s.totalViews||0, s.totalLikes||0, s.totalReplies||0, s.totalReposts||0, s.avgEngagementRate||0, s.totalPosts||0]];
    App.exportCSV('weekly_report', headers, rows);
  });

};
App.loadWeeklyReportList_ = async function() {
  var self = this;
  var listEl = document.getElementById('weeklyReportList');
  if (!listEl) return;
  try {
    var list = await this.api('getWeeklyReportList', {});
    if (!list || list.length === 0) {
      listEl.innerHTML = '<div class="text-caption">éå»ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }
    var html = '<div class="text-subheading mb-8">éå»ã®ãƒ¬ãƒãƒ¼ãƒˆ</div>';
    list.slice(0, 8).forEach(function(item, idx) {
      html += '<div class="flex-row gap-8 mb-6" style="padding:8px;background:var(--bg-secondary);border-radius:6px;cursor:pointer;" data-week-offset="' + idx + '">' +
        '<div style="flex:1;"><div class="text-body">' + item.weekStart + ' ã€œ ' + item.weekEnd + '</div>' +
        '<div class="text-caption">' + (item.postCount || 0) + 'æŠ•ç¨¿ / ER ' + (item.avgER || 0) + '% / ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ ' + (item.followersChange >= 0 ? '+' : '') + (item.followersChange || 0) + '</div></div>' +
        '<span class="text-caption">â€º</span></div>';
    });
    listEl.innerHTML = html;
    listEl.querySelectorAll('[data-week-offset]').forEach(function(el) {
      el.addEventListener('click', async function() {
        var offset = parseInt(this.getAttribute('data-week-offset'), 10);
        try {
          var report = await self.api('getWeeklyReport', { weekOffset: offset });
          if (report) self.renderWeeklyReport_(report);
        } catch (e) { self.showToast('å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error'); }
      });
    });
  } catch (e) { console.error('loadWeeklyReportList_ error:', e); }
};
</script>

