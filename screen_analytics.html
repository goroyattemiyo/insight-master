<script>
// ===========================================
// åˆ†æãƒãƒ–ï¼ˆæŠ•ç¨¿åˆ†æ / æ™‚é–“å¸¯ / ç«¶åˆï¼‰
// ===========================================
App.renderAnalyticsContent = function() {
  var tab = this.state.analyticsTab || 'posts';
  return '<div class="screen-content">' +
    '<div class="subtabs" data-group="analytics">' +
      '<button class="subtab' + (tab === 'posts' ? ' active' : '') + '" data-group="analytics" data-tab="posts">æŠ•ç¨¿åˆ†æ</button>' +
      '<button class="subtab' + (tab === 'time' ? ' active' : '') + '" data-group="analytics" data-tab="time">æ™‚é–“å¸¯</button>' +
      '<button class="subtab' + (tab === 'competitor' ? ' active' : '') + '" data-group="analytics" data-tab="competitor">ç«¶åˆ</button>' +
    '</div>' +
    '<div class="subtab-panels">' +
      '<div id="analytics-tab-posts" class="subtab-panel' + (tab === 'posts' ? ' active' : '') + '">' +
        this.renderAnalyticsDetailContent() +
      '</div>' +
      '<div id="analytics-tab-time" class="subtab-panel' + (tab === 'time' ? ' active' : '') + '">' +
      '</div>' +
      '<div id="analytics-tab-competitor" class="subtab-panel' + (tab === 'competitor' ? ' active' : '') + '">' +
      '</div>' +
    '</div>' +
  '</div>';
};

App.renderAnalyticsDetailContent = function() {
  return '<div>' +
    '<div class="card"><div class="card-title">æŠ•ç¨¿ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¸€è¦§</div>' +
      '<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">' +
        '<button class="btn btn-small period-btn active" data-period="7">7æ—¥</button>' +
        '<button class="btn btn-small period-btn" data-period="30">30æ—¥</button>' +
        '<button class="btn btn-small period-btn" data-period="all">å…¨æœŸé–“</button></div>' +
      '<div id="postListArea">' + this.renderSkeletonPostList() + '</div></div>' +
      '<div class="card mb-12" id="buzzAnalysisCard">' +
        '<div class="flex-row gap-8 mb-8">' +
          '<div class="card-title" style="flex:1;">ğŸ”¥ ãƒã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ</div>' +
          '<select id="buzzPeriodSelect" class="input" style="width:auto;padding:4px 8px;font-size:12px;">' +
            '<option value="30">30æ—¥</option>' +
            '<option value="60">60æ—¥</option>' +
            '<option value="90">90æ—¥</option>' +
          '</select>' +
        '</div>' +
        '<p style="font-size:12px;color:#64748b;margin-bottom:8px;">ä¸Šä½æŠ•ç¨¿ã¨ä¸‹ä½æŠ•ç¨¿ã‚’æ¯”è¼ƒã—ã€ãƒã‚ºã‚‹æ³•å‰‡ã‚’è‡ªå‹•æŠ½å‡ºã—ã¾ã™</p>' +
        '<button id="buzzAnalyzeBtn" class="btn btn-primary btn-full mb-8">ğŸ“Š ãƒã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æã™ã‚‹</button>' +
        '<div id="buzzStatsArea" style="display:none;"></div>' +
        '<div id="buzzAIReportArea" style="display:none;"></div>' +
      '</div>' +
      this.renderTips([
        { title: 'ğŸ“Š ERï¼ˆã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡ï¼‰ã¨ã¯ï¼Ÿ', body: 'ER ï¼ï¼ˆã„ã„ã­ï¼‹è¿”ä¿¡ï¼‹ãƒªãƒã‚¹ãƒˆï¼‹å¼•ç”¨ï¼‰Ã· ãƒ“ãƒ¥ãƒ¼æ•° Ã— 100ã€‚ã¤ã¾ã‚Šã€Œè¦‹ãŸäººã®ã†ã¡ä½•%ãŒåå¿œã—ãŸã‹ã€ã‚’ç¤ºã™æ•°å­—ã§ã™ã€‚<br>ç›®å®‰: <b>1%æœªæº€</b>=æ”¹å–„ã®ä½™åœ°ã‚ã‚Š / <b>1ã€œ3%</b>=å¹³å‡çš„ / <b>3ã€œ6%</b>=å„ªç§€ / <b>6%è¶…</b>=ãƒã‚ºæŠ•ç¨¿ã€‚å„æŠ•ç¨¿ã®å³ä¸‹ ğŸ“ˆ ã®æ•°å­—ãŒERã§ã™ã€‚' },
        { title: 'ğŸ“‹ æŠ•ç¨¿ä¸€è¦§ã®åˆ†æãƒã‚¤ãƒ³ãƒˆ', body: 'â‘  ğŸ“ˆã®æ•°å­—ï¼ˆERï¼‰ãŒé«˜ã„æŠ•ç¨¿ã‚’æ¢ã™<br>â‘¡ å…±é€šç‚¹ã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆãƒ†ãƒ¼ãƒï¼Ÿæ–‡ä½“ï¼ŸæŠ•ç¨¿æ™‚é–“ï¼Ÿçµµæ–‡å­—ï¼Ÿï¼‰<br>â‘¢ ãã®æ³•å‰‡ã‚’æ¬¡ã®æŠ•ç¨¿ã«æ´»ã‹ã™<br>â‘£ ERãŒä½ã„æŠ•ç¨¿ã‚‚ç¢ºèªã—ã¦ã€Œé¿ã‘ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã‚’æŠŠæ¡ã™ã‚‹' },
        { title: 'ğŸ“… æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ã®ä½¿ã„åˆ†ã‘', body: '<b>7æ—¥</b>: ç›´è¿‘ã®ãƒˆãƒ¬ãƒ³ãƒ‰ç¢ºèªï¼ˆæ¯æ—¥ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰<br><b>30æ—¥</b>: æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆãƒ»å…¨ä½“å‚¾å‘ã®æŠŠæ¡<br><b>å…¨æœŸé–“</b>: ã“ã‚Œã¾ã§ã®å…¨æŠ•ç¨¿ã‚’æŒ¯ã‚Šè¿”ã‚Šã€ãƒ™ã‚¹ãƒˆæŠ•ç¨¿ã‚’ç™ºè¦‹' }
      ]) +
  '</div>';
};

App.renderTimeAnalysisContent_ = function() {
  return '<div>' +
    '<div class="card"><div class="card-title">æœ€é©æŠ•ç¨¿æ™‚é–“å¸¯ï¼ˆãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼‰</div>' +
      '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">ç·‘ï¼é«˜ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ / èµ¤ï¼ä½ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ï¼ˆå¹³å‡ER%ï¼‰</p>' +
      '<div id="heatmapArea"><div class="loading"><div class="loading-spinner"></div></div></div></div>' +
      this.renderTips([
      { title: 'ğŸ• æŠ•ç¨¿æ™‚é–“ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®èª­ã¿æ–¹', body: 'è‰²ãŒ<span style="color:var(--success);font-weight:600;">æ¿ƒã„ç·‘</span>ã»ã©åå¿œãŒè‰¯ã„æ™‚é–“å¸¯ã€‚<span style="color:var(--warning);font-weight:600;">é»„è‰²</span>ã¯ä¸­ç¨‹åº¦ã€<span style="color:var(--error);font-weight:600;">èµ¤</span>ã¯ä½ã‚ã€‚æœ€ã‚‚ç·‘ãŒæ¿ƒã„æ›œæ—¥Ã—æ™‚é–“ãŒã€Œã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¿ã‚¤ãƒ ã€ï¼æŠ•ç¨¿ã™ã¹ããƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚' },
        { title: 'ğŸ¤– åˆ†æãƒ‡ãƒ¼ã‚¿ â†’ AIç”Ÿæˆã®æµã‚Œ', body: 'ã“ã®ç”»é¢ã§ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¿ã‚¤ãƒ ã‚’æŠŠæ¡ã—ãŸã‚‰ã€ã€Œä½œæˆã€ã‚¿ãƒ–ã®ã€ŒğŸ“Š åˆ†æãƒ™ãƒ¼ã‚¹ã€ãƒ¢ãƒ¼ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚' }
      ]) +
  '</div>';
};

App.loadAnalytics = function() {
  var self = this;
  var saved = localStorage.getItem('insight_master_subtab_analytics');
  var tab = saved || this.state.analyticsTab || 'posts';
  this.timeLoaded_ = false;
  this.compLoaded_ = false;
  document.querySelectorAll('.subtab[data-group="analytics"]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      self.switchAnalyticsTab_(this.getAttribute('data-tab'));
    });
  });
  this.switchAnalyticsTab_(tab, true);
  this.loadAnalyticsDetail();
  this.bindBuzzAnalysisEvents_();
};

App.switchAnalyticsTab_ = function(tab, silent) {
  this.state.analyticsTab = tab;
  localStorage.setItem('insight_master_subtab_analytics', tab);
  document.querySelectorAll('.subtab[data-group="analytics"]').forEach(function(btn) {
    btn.classList.toggle('active', btn.getAttribute('data-tab') === tab);
  });
  var panels = ['posts','time','competitor'];
  panels.forEach(function(t) {
    var el = document.getElementById('analytics-tab-' + t);
    if (el) el.classList.toggle('active', t === tab);
  });
  if (tab === 'time') {
    var timePanel = document.getElementById('analytics-tab-time');
    if (timePanel && timePanel.innerHTML.trim() === '') {
      timePanel.innerHTML = this.renderTimeAnalysisContent_();
    }
    if (!this.timeLoaded_) {
      this.timeLoaded_ = true;
      this.loadHeatmap_();
    }
  }
  if (tab === 'competitor') {
    var compPanel = document.getElementById('analytics-tab-competitor');
    if (compPanel && compPanel.innerHTML.trim() === '') {
      compPanel.innerHTML = this.renderCompetitorContent();
    }
    if (!this.compLoaded_) {
      this.compLoaded_ = true;
      this.loadCompetitor();
    }
  }
  if (!silent) {
    this.bindTipsEvents();
  }
};

App.loadAnalyticsDetail = async function() {
  var self = this;
  document.querySelectorAll('.period-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.period-btn').forEach(function(b) { b.classList.remove('active'); });
      this.classList.add('active');
      var p = this.getAttribute('data-period');
      // â˜…SKELETON: åˆ‡æ›¿æ™‚ã«ã‚‚ã‚¹ã‚±ãƒ«ãƒˆãƒ³è¡¨ç¤º
      document.getElementById('postListArea').innerHTML = self.renderSkeletonPostList();
      self.loadPostList_(p === 'all' ? 'all' : parseInt(p));
    });
  });
  await this.loadPostList_(7);
};

App.loadPostList_ = async function(periodDays) {
  var c = document.getElementById('postListArea');
  try {
    var data = await this.api('getAnalyticsData', { periodDays: periodDays });
    if (!data || !data.posts || data.posts.length === 0) {
      c.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:20px;">ãƒ‡ãƒ¼ã‚¿ãªã—ã€‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã€Œãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã€ã—ã¦ãã ã•ã„ã€‚</div>';
      return;
    }
    var posts = data.posts || [];
    var chunkSize = 20;
    var initialCount = Math.min(chunkSize, posts.length);
    var html = '<div id="postListScroll" class="scrollable-500">';
    html += this.renderPostListItems_(posts, 0, initialCount);
    html += '</div>';
    if (posts.length > initialCount) {
      html += '<button id="postListMoreBtn" class="btn btn-secondary btn-full" style="margin-top:10px;">ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆæ®‹ã‚Š ' + (posts.length - initialCount) + ' ä»¶ï¼‰</button>';
    }
    if (data.summary) {
      html += '<div style="margin-top:12px;padding:14px;background:var(--bg-tertiary);border-radius:10px;font-size:13px;color:var(--text-secondary);">' +
        'åˆè¨ˆ: ' + data.summary.totalPosts + 'ä»¶ / å¹³å‡ER: ' + data.summary.avgEngagementRate + '% / ç·ãƒ“ãƒ¥ãƒ¼: ' + (data.summary.totalViews||0).toLocaleString() + '</div>';
    }
    c.innerHTML = html;
    this.postListState_ = { posts: posts, offset: initialCount, chunkSize: chunkSize };
    var scrollArea = document.getElementById('postListScroll');
    if (scrollArea) this.bindPostLinkEvents_(scrollArea);
    var self = this;
    var moreBtn = document.getElementById('postListMoreBtn');
    if (moreBtn) {
      moreBtn.addEventListener('click', function() {
        var state = self.postListState_;
        if (!state || !state.posts) return;
        var start = state.offset;
        var end = Math.min(state.offset + state.chunkSize, state.posts.length);
        var list = document.getElementById('postListScroll');
        if (list) {
          list.insertAdjacentHTML('beforeend', self.renderPostListItems_(state.posts, start, end));
          self.bindPostLinkEvents_(list);
        }
        state.offset = end;
        var remaining = state.posts.length - state.offset;
        if (remaining > 0) {
          this.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆæ®‹ã‚Š ' + remaining + ' ä»¶ï¼‰';
        } else {
          this.remove();
        }
      });
    }
  } catch (e) {
    c.innerHTML = '<div style="color:var(--error);text-align:center;">å–å¾—ã‚¨ãƒ©ãƒ¼: ' + App.escapeHtml(e.message) + '</div>';
  }
};

App.renderPostListItems_ = function(posts, start, end) {
  var html = '';
  for (var i = start; i < end; i++) {
    var p = posts[i];
    var date = p.timestamp ? new Date(p.timestamp).toLocaleDateString('ja-JP') : '';
    html += '<div class="post-card">' +
      (p.permalink ? '<div class="post-link" data-link="' + p.permalink + '">ğŸ”—</div>' : '') +
      '<div class="post-text">' + App.escapeHtml(p.text) + '</div>' +
      '<div class="post-meta">' + date + ' | ' + (p.mediaType || 'TEXT') + '</div>' +
      '<div class="post-metrics">' +
        '<span class="post-metric"><span class="post-metric-icon">ğŸ‘</span>' + (p.views||0).toLocaleString() + '</span>' +
        '<span class="post-metric post-metric-like"><span class="post-metric-icon">â¤ï¸</span>' + (p.likes||0) + '</span>' +
        '<span class="post-metric"><span class="post-metric-icon">ğŸ’¬</span>' + (p.replies||0) + '</span>' +
        '<span class="post-metric"><span class="post-metric-icon">ğŸ”„</span>' + (p.reposts||0) + '</span>' +
        '<span class="er-badge"><span class="post-metric-icon">ğŸ“ˆ</span>' + (p.engagementRate||0) + '%</span>' +
      '</div></div>';
  }
  return html;
};

App.bindPostLinkEvents_ = function(container) {
  container.querySelectorAll('.post-link').forEach(function(btn) {
    if (btn.dataset.bound) return;
    btn.dataset.bound = 'true';
    btn.addEventListener('click', function() {
      var link = this.getAttribute('data-link');
      if (link) window.open(link, '_blank');
    });
  });
};

App.loadHeatmap_ = async function() {
  var c = document.getElementById('heatmapArea');
  if (!c) return;
  try {
    var data = await this.api('getTimeAnalysisData', {});
    if (!data || !data.hasData) {
      c.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:20px;">æ™‚é–“å¸¯åˆ†æãƒ‡ãƒ¼ã‚¿ãªã—</div>'; return;
    }
    var days = ['æ—¥æ›œ','æœˆæ›œ','ç«æ›œ','æ°´æ›œ','æœ¨æ›œ','é‡‘æ›œ','åœŸæ›œ'];
    var allV = [];
    days.forEach(function(d) { if (data.matrix[d]) for (var h=0;h<24;h++) { var v=data.matrix[d][h]; if(v>0)allV.push(v); } });
    var maxV = allV.length > 0 ? Math.max.apply(null, allV) : 1;
    var html = '<div class="scrollable-500"><div style="overflow-x:auto;"><table class="heatmap-table">';
    html += '<tr><th class="heatmap-head"></th>';
    for (var h=0;h<24;h++) html += '<th class="heatmap-hour">' + h + '</th>';
    html += '</tr>';
    days.forEach(function(day) {
      html += '<tr><td class="heatmap-day">' + day + '</td>';
      for (var h=0;h<24;h++) {
        var val = (data.matrix[day] && data.matrix[day][h]) ? data.matrix[day][h] : 0;
        var bg = 'var(--bg-tertiary)';
        if (val > 0 && maxV > 0) {
          var ratio = val / maxV;
          var r = Math.round(255*(1-ratio)), g = Math.round(200*ratio+55);
          bg = 'rgb('+r+','+g+',100)';
        }
        html += '<td class="heatmap-cell ' + (val>0 ? 'has-value' : 'no-value') + '" style="background:' + bg + ';" title="'+day+' '+h+'æ™‚: '+val+'%">'+(val>0?val:'')+'</td>';
      }
      html += '</tr>';
    });
    html += '</table></div></div>';
    c.innerHTML = html;
  } catch (e) {
    c.innerHTML = '<div style="color:var(--error);text-align:center;">ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚¨ãƒ©ãƒ¼</div>';
  }
};


// ===========================================
// ç«¶åˆã‚¦ã‚©ãƒƒãƒç”»é¢
// ===========================================
App.renderCompetitorContent = function() {
  return '<div>' +
    this.renderTips([
      { title: 'ğŸ” Groundingæ¤œç´¢ã¨ã¯', body: 'Gemini AIãŒGoogleæ¤œç´¢ã‚’å®Ÿè¡Œã—ã€Threadsä¸Šã®å…¬é–‹æŠ•ç¨¿ã‚„ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’èª¿æŸ»ã—ã¾ã™ã€‚Threads APIã®Advanced Accessã¯ä¸è¦ã§ã™ã€‚' },
      { title: 'ğŸ“‹ æ‰‹å‹•è¨˜éŒ²ã®ã‚³ãƒ„', body: 'ç«¶åˆã®æŠ•ç¨¿ã‚’Threadsã‚¢ãƒ—ãƒªã§è¦‹ãªãŒã‚‰ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒšï¼‹æ•°å€¤ã‚’å…¥åŠ›ã€‚ã€Œãƒã‚ºã€ã‚¿ã‚°ã‚’ä»˜ã‘ã‚‹ã¨ã€å¾Œã§ãƒã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æã«ä½¿ãˆã¾ã™ã€‚' },
      { title: 'ğŸ¤– AIåˆ†æã®ç²¾åº¦', body: 'è¨˜éŒ²æŠ•ç¨¿ãŒå¤šã„ã»ã©åˆ†æç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚1ç«¶åˆã‚ãŸã‚Š10ä»¶ä»¥ä¸ŠãŒãŠã™ã™ã‚ã€‚' }
    ]) +
    // ã‚¿ãƒ–UI
    '<div class="card" style="padding:0;overflow:hidden;">' +
      '<div id="compTabs" style="display:flex;border-bottom:1px solid var(--border-color);">' +
        '<button class="comp-tab active" data-tab="search" style="flex:1;padding:12px;border:none;background:none;font-weight:600;font-size:13px;cursor:pointer;border-bottom:2px solid var(--primary-color);">ğŸ” æ¤œç´¢</button>' +
        '<button class="comp-tab" data-tab="record" style="flex:1;padding:12px;border:none;background:none;font-weight:600;font-size:13px;cursor:pointer;color:var(--text-secondary);">ğŸ“‹ è¨˜éŒ²</button>' +
        '<button class="comp-tab" data-tab="list" style="flex:1;padding:12px;border:none;background:none;font-weight:600;font-size:13px;cursor:pointer;color:var(--text-secondary);">ğŸ“Š ä¸€è¦§</button>' +
        '<button class="comp-tab" data-tab="analysis" style="flex:1;padding:12px;border:none;background:none;font-weight:600;font-size:13px;cursor:pointer;color:var(--text-secondary);">ğŸ¤– åˆ†æ</button>' +
      '</div>' +
      '<div id="compTabContent" class="screen-content"></div>' +
    '</div>' +
  '</div>';
};

App.loadCompetitor = function() {
  var self = this;
  this.compState_ = { competitors: [], posts: [], activeTab: 'search' };
  // ã‚¿ãƒ–åˆ‡æ›¿
  document.querySelectorAll('.comp-tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
      self.compSwitchTab_(this.getAttribute('data-tab'));
    });
  });
  // ç«¶åˆä¸€è¦§ã‚’ãƒ­ãƒ¼ãƒ‰
  this.api('getCompetitors', {}).then(function(data) {
    self.compState_.competitors = data || [];
    self.compRenderTab_('search');
  }).catch(function() {
    self.compRenderTab_('search');
  });
};

App.compSwitchTab_ = function(tab) {
  this.compState_.activeTab = tab;
  document.querySelectorAll('.comp-tab').forEach(function(t) {
    var isActive = t.getAttribute('data-tab') === tab;
    t.classList.toggle('active', isActive);
    t.style.borderBottom = isActive ? '2px solid var(--primary-color)' : '2px solid transparent';
    t.style.color = isActive ? 'var(--text-primary)' : 'var(--text-secondary)';
  });
  this.compRenderTab_(tab);
};

App.compRenderTab_ = function(tab) {
  var c = document.getElementById('compTabContent');
  if (!c) return;
  switch (tab) {
    case 'search':   c.innerHTML = this.compSearchUI_(); this.compBindSearch_(); break;
    case 'record':   c.innerHTML = this.compRecordUI_(); this.compBindRecord_(); break;
    case 'list':     this.compLoadList_(c); break;
    case 'analysis': c.innerHTML = this.compAnalysisUI_(); this.compBindAnalysis_(); break;
  }
};

// --- æ¤œç´¢ã‚¿ãƒ– ---
App.compSearchUI_ = function() {
  var compOpts = '<option value="">æŒ‡å®šãªã—</option>';
  (this.compState_.competitors || []).forEach(function(c) {
    var name = c.username || '';
    compOpts += '<option value="' + App.escapeAttr(name) + '">@' + App.escapeHtml(name) + '</option>';
  });
  return '<div class="mb-16">' +
    '<label class="form-label">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>' +
    '<input type="text" id="compSearchQuery" class="input" placeholder="ä¾‹: AIå‰¯æ¥­, Threadsé‹ç”¨">' +
  '</div>' +
  '<div class="mb-16">' +
    '<label class="form-label">å¯¾è±¡ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</label>' +
    '<div class="btn-group">' +
      '<select id="compSearchTarget" class="input" style="flex:1;">' + compOpts + '</select>' +
      '<input type="text" id="compSearchTargetCustom" class="input" style="flex:1;" placeholder="ã¾ãŸã¯ @åã‚’å…¥åŠ›">' +
    '</div>' +
  '</div>' +
  '<button id="compSearchBtn" class="btn btn-primary btn-full">ğŸ” Groundingæ¤œç´¢</button>' +
  '<div id="compSearchResult" class="mt-16"></div>';
};

App.compBindSearch_ = function() {
  var self = this;
  document.getElementById('compSearchBtn').addEventListener('click', function() {
    var query = document.getElementById('compSearchQuery').value.trim();
    if (!query) { self.showToast('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    var target = document.getElementById('compSearchTarget').value || document.getElementById('compSearchTargetCustom').value.trim().replace(/^@/, '');
    var btn = this;
    btn.disabled = true; btn.textContent = 'æ¤œç´¢ä¸­ï¼ˆ15ã€œ30ç§’ï¼‰...';
    var resultDiv = document.getElementById('compSearchResult');
    resultDiv.innerHTML = '<div style="text-align:center;padding:20px;"><div class="loading-spinner" style="margin:0 auto 12px;"></div><div class="text-caption">Gemini AIãŒGoogleæ¤œç´¢ä¸­...</div></div>';
    self.api('searchCompetitorByGrounding', { query: query, searchTarget: target }).then(function(res) {
      btn.disabled = false; btn.textContent = 'ğŸ” Groundingæ¤œç´¢';
      var html = '<div class="ai-result-container">' +
        self.formatMarkdown_(res.report) + '</div>';
      if (res.sources && res.sources.length > 0) {
        html += '<div style="margin-top:12px;font-size:11px;color:var(--text-secondary);">' +
          '<div style="font-weight:600;margin-bottom:4px;">ğŸ“ å‚è€ƒã‚½ãƒ¼ã‚¹:</div>';
        res.sources.forEach(function(s) {
          html += '<div><a href="' + self.escapeAttr(s.uri) + '" target="_blank" style="color:var(--link-color);">' + self.escapeHtml(s.title || s.uri) + '</a></div>';
        });
        html += '</div>';
      }
      resultDiv.innerHTML = html;
    }).catch(function(err) {
      btn.disabled = false; btn.textContent = 'ğŸ” Groundingæ¤œç´¢';
      resultDiv.innerHTML = '<div style="color:var(--error);font-size:13px;padding:12px;">' + self.escapeHtml(err.message) + '</div>';
    });
  });
};

// --- è¨˜éŒ²ã‚¿ãƒ– ---
App.compRecordUI_ = function() {
  var compOpts = '<option value="">-- é¸æŠ or æ–°è¦å…¥åŠ› --</option>';
  (this.compState_.competitors || []).forEach(function(c) {
    var name = c.username || '';
    compOpts += '<option value="' + App.escapeAttr(name) + '">@' + App.escapeHtml(name) + '</option>';
  });
  return '<div class="mb-12">' +
    '<label class="form-label">ç«¶åˆãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>' +
    '<div class="btn-group">' +
      '<select id="compRecordUser" class="input" style="flex:1;">' + compOpts + '</select>' +
      '<input type="text" id="compRecordUserNew" class="input" style="flex:1;" placeholder="@username">' +
    '</div>' +
  '</div>' +
  '<div class="mb-12">' +
    '<label class="form-label">æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚³ãƒ”ãƒšï¼‰</label>' +
    '<textarea id="compRecordText" class="input" rows="5" placeholder="ç«¶åˆã®æŠ•ç¨¿ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘"></textarea>' +
  '</div>' +
  '<div class="grid-3 mb-12">' +
    '<div><label class="form-label-small">ã„ã„ã­</label><input type="number" id="compRecordLikes" class="input" value="0" min="0"></div>' +
    '<div><label class="form-label-small">è¿”ä¿¡</label><input type="number" id="compRecordReplies" class="input" value="0" min="0"></div>' +
    '<div><label class="form-label-small">ãƒªãƒã‚¹ãƒˆ</label><input type="number" id="compRecordReposts" class="input" value="0" min="0"></div>' +
  '</div>' +
  '<div class="grid-2 mb-12">' +
    '<div><label class="form-label-small">ãƒ¡ãƒ‡ã‚£ã‚¢</label>' +
      '<select id="compRecordMedia" class="input"><option value="TEXT">ãƒ†ã‚­ã‚¹ãƒˆ</option><option value="IMAGE">ç”»åƒ</option><option value="VIDEO">å‹•ç”»</option><option value="CAROUSEL">ã‚«ãƒ«ãƒ¼ã‚»ãƒ«</option></select></div>' +
    '<div><label class="form-label-small">æŠ•ç¨¿æ—¥</label><input type="date" id="compRecordDate" class="input"></div>' +
  '</div>' +
  '<div class="mb-12">' +
    '<label class="form-label-small">ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š: ãƒã‚º, å‚è€ƒ, å®šç•ª ç­‰ï¼‰</label>' +
    '<input type="text" id="compRecordTags" class="input" placeholder="ãƒã‚º, å‚è€ƒ">' +
  '</div>' +
  '<div class="mb-16">' +
    '<label class="form-label-small">æŠ•ç¨¿URLï¼ˆä»»æ„ï¼‰</label>' +
    '<input type="text" id="compRecordUrl" class="input" placeholder="https://www.threads.net/...">' +
  '</div>' +
  '<button id="compRecordSaveBtn" class="btn btn-primary btn-full">ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜</button>';
};

App.compBindRecord_ = function() {
  var self = this;
  var usernamePattern = /^[a-zA-Z0-9._]{1,30}$/;
  // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  var dateInput = document.getElementById('compRecordDate');
  if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
  document.getElementById('compRecordSaveBtn').addEventListener('click', function() {
    var username = document.getElementById('compRecordUser').value || document.getElementById('compRecordUserNew').value.trim().replace(/^@/, '');
    var text = document.getElementById('compRecordText').value.trim();
    if (!username) { self.showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (!usernamePattern.test(username)) { self.showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error'); return; }
    if (!text) { self.showToast('æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    var btn = this;
    btn.disabled = true; btn.textContent = 'ä¿å­˜ä¸­...';
    self.api('saveWatchPost', {
      competitorUsername: username,
      postText: text,
      likes: document.getElementById('compRecordLikes').value,
      replies: document.getElementById('compRecordReplies').value,
      reposts: document.getElementById('compRecordReposts').value,
      mediaType: document.getElementById('compRecordMedia').value,
      postDate: document.getElementById('compRecordDate').value,
      tags: document.getElementById('compRecordTags').value,
      postUrl: document.getElementById('compRecordUrl').value
    }).then(function(res) {
      btn.disabled = false; btn.textContent = 'ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜';
      self.showToast('@' + res.username + ' ã®æŠ•ç¨¿ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ', 'success');
      // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('compRecordText').value = '';
      document.getElementById('compRecordLikes').value = '0';
      document.getElementById('compRecordReplies').value = '0';
      document.getElementById('compRecordReposts').value = '0';
      document.getElementById('compRecordTags').value = '';
      document.getElementById('compRecordUrl').value = '';
      // ç«¶åˆãƒªã‚¹ãƒˆæ›´æ–°
      self.api('getCompetitors', {}).then(function(d) { self.compState_.competitors = d || []; });
    }).catch(function(err) {
      btn.disabled = false; btn.textContent = 'ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜';
      self.showToast(err.message, 'error');
    });
  });
};

// --- ä¸€è¦§ã‚¿ãƒ– ---
App.compLoadList_ = function(container) {
  var self = this;
  container.innerHTML = '<div style="text-align:center;padding:20px;"><div class="loading-spinner" style="margin:0 auto 12px;"></div></div>';
  Promise.all([
    this.api('getCompetitors', {}),
    this.api('getWatchPosts', {})
  ]).then(function(results) {
    self.compState_.competitors = results[0] || [];
    self.compState_.posts = results[1] || [];
    container.innerHTML = self.compListUI_();
    self.compBindList_();
  }).catch(function(err) {
    container.innerHTML = '<div style="color:var(--error);padding:12px;">' + self.escapeHtml(err.message) + '</div>';
  });
};

App.compListUI_ = function() {
  var comps = this.compState_.competitors || [];
  var posts = this.compState_.posts || [];
  var esc = App.escapeHtml;
  if (comps.length === 0 && posts.length === 0) {
    return '<div style="text-align:center;padding:30px;color:var(--text-secondary);">' +
      '<div style="font-size:40px;margin-bottom:12px;">ğŸ“‹</div>' +
      '<div>ã¾ã ç«¶åˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>' +
      '<div style="font-size:12px;margin-top:8px;">ã€Œè¨˜éŒ²ã€ã‚¿ãƒ–ã‹ã‚‰æŠ•ç¨¿ã‚’è¿½åŠ ã™ã‚‹ã¨è‡ªå‹•ç™»éŒ²ã•ã‚Œã¾ã™</div></div>';
  }
  var html = '';
  // ç«¶åˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰
  if (comps.length > 0) {
    html += '<div style="font-weight:600;font-size:14px;margin-bottom:12px;">ğŸ‘¥ ç«¶åˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ' + comps.length + 'ï¼‰</div>';
    comps.forEach(function(c) {
      var name = esc(c.username || '');
      var displayName = esc(c.displayName || '');
      var category = esc(c.category || '');
      html += '<div style="padding:12px;background:var(--bg-secondary);border-radius:10px;margin-bottom:8px;">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;">' +
          '<div><span style="font-weight:600;">@' + name + '</span>' +
            (displayName ? ' <span style="color:var(--text-secondary);font-size:12px;">' + displayName + '</span>' : '') +
            ' <span style="font-size:11px;padding:2px 8px;background:var(--link-soft);color:var(--link-color);border-radius:12px;">' + category + '</span></div>' +
          '<button class="comp-delete-btn btn btn-small" data-id="' + c.competitorId + '" style="font-size:11px;padding:4px 8px;">ğŸ—‘</button>' +
        '</div>' +
        '<div style="display:flex;gap:16px;margin-top:8px;font-size:12px;color:var(--text-secondary);">' +
          '<span>ğŸ‘¥ ' + (c.followersCount || 0) + ' ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</span>' +
          '<span>ğŸ“‹ ' + (c.watchCount || 0) + ' ä»¶è¨˜éŒ²</span>' +
        '</div></div>';
    });
  }
  // æœ€è¿‘ã®è¨˜éŒ²
  if (posts.length > 0) {
    html += '<div style="font-weight:600;font-size:14px;margin:16px 0 12px;">ğŸ“ æœ€è¿‘ã®è¨˜éŒ²ï¼ˆ' + posts.length + 'ä»¶ï¼‰</div>';
    var display = posts.slice(0, 20);
    display.forEach(function(p) {
      var username = esc(p.competitorUsername || '');
      var postDate = esc((p.postDate || '').substring(0, 10));
      var postTextRaw = String(p.postText || '');
      var postText = postTextRaw.substring(0, 200);
      var postTextEsc = esc(postText);
      var tags = esc(p.tags || '');
      html += '<div style="padding:12px;background:var(--bg-secondary);border-radius:10px;margin-bottom:8px;">' +
        '<div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-secondary);margin-bottom:6px;">' +
          '<span>@' + username + '</span>' +
          '<span>' + postDate + '</span>' +
        '</div>' +
        '<div style="font-size:13px;line-height:1.6;margin-bottom:8px;word-break:break-word;">' + postTextEsc + (postTextRaw.length > 200 ? '...' : '') + '</div>' +
        '<div style="display:flex;gap:12px;font-size:11px;color:var(--text-secondary);">' +
          '<span>â¤ï¸ ' + (p.likes || 0) + '</span>' +
          '<span>ğŸ’¬ ' + (p.replies || 0) + '</span>' +
          '<span>ğŸ”„ ' + (p.reposts || 0) + '</span>' +
          (tags ? '<span style="padding:1px 6px;background:var(--tag-bg);color:var(--tag-text);border-radius:8px;">ğŸ· ' + tags + '</span>' : '') +
        '</div>' +
        '<button class="watch-delete-btn" data-id="' + p.watchId + '" style="font-size:11px;color:var(--error);background:none;border:none;cursor:pointer;margin-top:6px;">å‰Šé™¤</button>' +
      '</div>';
    });
  }
  return html;
};

App.compBindList_ = function() {
  var self = this;
  document.querySelectorAll('.comp-delete-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      if (!confirm('ã“ã®ç«¶åˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      self.api('deleteCompetitor', { competitorId: this.getAttribute('data-id') }).then(function() {
        self.showToast('å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        self.compSwitchTab_('list');
      }).catch(function(err) { self.showToast(err.message, 'error'); });
    });
  });
  document.querySelectorAll('.watch-delete-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      self.api('deleteWatchPost', { watchId: this.getAttribute('data-id') }).then(function() {
        self.showToast('å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        self.compSwitchTab_('list');
      }).catch(function(err) { self.showToast(err.message, 'error'); });
    });
  });
};

// --- åˆ†æã‚¿ãƒ– ---
App.compAnalysisUI_ = function() {
  var compOpts = '<option value="">-- å…¨ç«¶åˆ --</option>';
  (this.compState_.competitors || []).forEach(function(c) {
    var name = c.username || '';
    compOpts += '<option value="' + App.escapeAttr(name) + '">@' + App.escapeHtml(name) + ' (' + (c.watchCount || 0) + 'ä»¶)</option>';
  });
  return '<div class="mb-16">' +
    '<label class="form-label">åˆ†æå¯¾è±¡</label>' +
    '<select id="compAnalysisTarget" class="input">' + compOpts + '</select>' +
  '</div>' +
  '<div class="grid-2 mb-12">' +
    '<button id="compStyleBtn" class="btn btn-secondary btn-small" style="padding:12px;">ğŸ“ ã‚¹ã‚¿ã‚¤ãƒ«åˆ†æ</button>' +
    '<button id="compVsSelfBtn" class="btn btn-secondary btn-small" style="padding:12px;">âš”ï¸ è‡ªåˆ†ã¨æ¯”è¼ƒ</button>' +
    '<button id="compBuzzBtn" class="btn btn-secondary btn-small" style="padding:12px;grid-column:1/-1;">ğŸ”¥ ãƒã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ</button>' +
  '</div>' +
  '<div id="compAnalysisResult" class="mt-12"></div>';
};

App.compBindAnalysis_ = function() {
  var self = this;
  var resultDiv = function() { return document.getElementById('compAnalysisResult'); };
  var showLoading = function(btn, msg) {
    btn.disabled = true;
    resultDiv().innerHTML = '<div style="text-align:center;padding:20px;"><div class="loading-spinner" style="margin:0 auto 12px;"></div><div class="text-caption">' + msg + '</div></div>';
  };
  var showResult = function(btn, origText, analysis) {
    btn.disabled = false; btn.textContent = origText;
    resultDiv().innerHTML = '<div class="ai-result-container">' +
      self.formatMarkdown_(analysis) + '</div>';
  };
  var showError = function(btn, origText, err) {
    btn.disabled = false; btn.textContent = origText;
    resultDiv().innerHTML = '<div style="color:var(--error);font-size:13px;padding:12px;">' + self.escapeHtml(err.message) + '</div>';
  };

  document.getElementById('compStyleBtn').addEventListener('click', function() {
    var target = document.getElementById('compAnalysisTarget').value;
    if (!target) { self.showToast('ç«¶åˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
    var btn = this; showLoading(btn, 'ã‚¹ã‚¿ã‚¤ãƒ«åˆ†æä¸­ï¼ˆ15ã€œ45ç§’ï¼‰...');
    self.api('analyzeCompetitorStyle', { username: target }).then(function(res) {
      showResult(btn, 'ğŸ“ ã‚¹ã‚¿ã‚¤ãƒ«åˆ†æ', res.analysis);
    }).catch(function(err) { showError(btn, 'ğŸ“ ã‚¹ã‚¿ã‚¤ãƒ«åˆ†æ', err); });
  });

  document.getElementById('compVsSelfBtn').addEventListener('click', function() {
    var target = document.getElementById('compAnalysisTarget').value;
    var btn = this; showLoading(btn, 'æ¯”è¼ƒåˆ†æä¸­ï¼ˆ15ã€œ45ç§’ï¼‰...');
    self.api('analyzeVsSelf', { username: target }).then(function(res) {
      showResult(btn, 'âš”ï¸ è‡ªåˆ†ã¨æ¯”è¼ƒ', res.analysis);
    }).catch(function(err) { showError(btn, 'âš”ï¸ è‡ªåˆ†ã¨æ¯”è¼ƒ', err); });
  });

  document.getElementById('compBuzzBtn').addEventListener('click', function() {
    var btn = this; showLoading(btn, 'ãƒã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æä¸­ï¼ˆ15ã€œ45ç§’ï¼‰...');
    self.api('analyzeBuzzPatterns', {}).then(function(res) {
      showResult(btn, 'ğŸ”¥ ãƒã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ', res.analysis);
    }).catch(function(err) { showError(btn, 'ğŸ”¥ ãƒã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ', err); });
  });
};

// === ãƒã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ UI ===

App.bindBuzzAnalysisEvents_ = function() {
  var self = this;
  var btn = document.getElementById('buzzAnalyzeBtn');
  if (!btn) return;

  btn.addEventListener('click', function() {
    var period = document.getElementById('buzzPeriodSelect');
    var days = period ? Number(period.value) : 30;
    btn.disabled = true;
    btn.textContent = 'åˆ†æä¸­ï¼ˆ15ã€œ45ç§’ï¼‰...';

    self.api('generateBuzzReport', { days: days }).then(function(res) {
      btn.disabled = false;
      btn.textContent = 'ğŸ“Š ãƒã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æã™ã‚‹';

      if (res.message && !res.stats) {
        self.showToast(res.message, 'error');
        return;
      }

      self.renderBuzzStats_(res);

      if (res.aiReport) {
        self.renderBuzzAIReport_(res.aiReport);
      } else if (res.aiError) {
        self.renderBuzzAIReport_(null, res.aiError);
      }
    }).catch(function(err) {
      btn.disabled = false;
      btn.textContent = 'ğŸ“Š ãƒã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æã™ã‚‹';
      self.showToast('åˆ†æã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
    });
  });
};

App.renderBuzzStats_ = function(data) {
  var area = document.getElementById('buzzStatsArea');
  if (!area) return;
  var s = data.stats;

  var html = '<div style="margin-bottom:12px;font-size:12px;color:#64748b;">' +
    'ğŸ“ˆ ' + data.days + 'æ—¥é–“ / ' + data.sampleSize + 'æŠ•ç¨¿ä¸­ ä¸Šä½' + data.topN + 'ä»¶ vs ä¸‹ä½' + data.topN + 'ä»¶ã‚’æ¯”è¼ƒ</div>';

  var metrics = [
    { label: 'å¹³å‡ER', top: s.avgER.top + '%', bottom: s.avgER.bottom + '%', topVal: s.avgER.top, bottomVal: s.avgER.bottom },
    { label: 'å¹³å‡æ–‡å­—æ•°', top: s.avgLength.top, bottom: s.avgLength.bottom, topVal: s.avgLength.top, bottomVal: s.avgLength.bottom },
    { label: 'ãƒ¡ãƒ‡ã‚£ã‚¢æ·»ä»˜ç‡', top: s.mediaRate.top + '%', bottom: s.mediaRate.bottom + '%', topVal: s.mediaRate.top, bottomVal: s.mediaRate.bottom },
    { label: 'è³ªå•å½¢å¼ç‡', top: s.questionRate.top + '%', bottom: s.questionRate.bottom + '%', topVal: s.questionRate.top, bottomVal: s.questionRate.bottom },
    { label: 'ãƒ•ãƒƒã‚¯é•·ï¼ˆå†’é ­æ–‡ï¼‰', top: s.hookLength.top + 'å­—', bottom: s.hookLength.bottom + 'å­—', topVal: s.hookLength.top, bottomVal: s.hookLength.bottom },
    { label: 'ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ç‡', top: s.hashtagRate.top + '%', bottom: s.hashtagRate.bottom + '%', topVal: s.hashtagRate.top, bottomVal: s.hashtagRate.bottom }
  ];

  html += '<div style="display:grid;gap:8px;">';
  metrics.forEach(function(m) {
    var maxVal = Math.max(m.topVal, m.bottomVal, 1);
    var topPct = Math.round(m.topVal / maxVal * 100);
    var bottomPct = Math.round(m.bottomVal / maxVal * 100);
    var diff = m.topVal - m.bottomVal;
    var diffLabel = diff > 0 ? '+' + (typeof m.topVal === 'number' && m.topVal % 1 !== 0 ? diff.toFixed(1) : Math.round(diff)) : String(Math.round(diff));
    var diffColor = diff > 0 ? '#10b981' : diff < 0 ? '#ef4444' : '#64748b';

    html += '<div style="background:#f8fafc;border-radius:8px;padding:10px;">' +
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">' +
        '<span style="font-size:12px;font-weight:600;">' + m.label + '</span>' +
        '<span style="font-size:11px;font-weight:700;color:' + diffColor + ';">' + diffLabel + '</span>' +
      '</div>' +
      '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">' +
        '<span style="font-size:10px;width:28px;color:#10b981;">ä¸Šä½</span>' +
        '<div style="flex:1;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;">' +
          '<div style="width:' + topPct + '%;height:100%;background:linear-gradient(90deg,#10b981,#34d399);border-radius:4px;"></div>' +
        '</div>' +
        '<span style="font-size:10px;width:40px;text-align:right;">' + m.top + '</span>' +
      '</div>' +
      '<div style="display:flex;align-items:center;gap:6px;">' +
        '<span style="font-size:10px;width:28px;color:#ef4444;">ä¸‹ä½</span>' +
        '<div style="flex:1;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;">' +
          '<div style="width:' + bottomPct + '%;height:100%;background:linear-gradient(90deg,#ef4444,#f87171);border-radius:4px;"></div>' +
        '</div>' +
        '<span style="font-size:10px;width:40px;text-align:right;">' + m.bottom + '</span>' +
      '</div>' +
    '</div>';
  });
  html += '</div>';

  html += '<div style="margin-top:12px;padding:10px;background:#eff6ff;border-radius:8px;border-left:3px solid #3b82f6;">' +
    '<div style="font-size:12px;font-weight:600;color:#1e40af;margin-bottom:4px;">ğŸ¯ æœ€é©æ¡ä»¶</div>' +
    '<div style="font-size:12px;color:#1e3a5f;">' +
      'æŠ•ç¨¿æ™‚é–“: <b>' + s.bestHour + 'æ™‚</b> / æ›œæ—¥: <b>' + s.bestDay + 'æ›œæ—¥</b> / ' +
      'æ–‡å­—æ•°: <b>' + Math.round(s.avgLength.top * 0.8) + 'ã€œ' + Math.round(s.avgLength.top * 1.2) + 'æ–‡å­—</b>' +
    '</div>' +
  '</div>';

  if (data.topPosts && data.topPosts.length > 0) {
    html += '<div style="margin-top:12px;"><div style="font-size:12px;font-weight:600;margin-bottom:6px;">ğŸ† ä¸Šä½æŠ•ç¨¿ã‚µãƒ³ãƒ—ãƒ«</div>';
    data.topPosts.slice(0, 3).forEach(function(p, i) {
      html += '<div style="padding:8px;background:#f0fdf4;border-radius:6px;margin-bottom:4px;font-size:11px;">' +
        '<span style="color:#10b981;font-weight:700;">ER ' + p.er.toFixed(1) + '%</span> ' +
        '<span style="color:#64748b;">' + p.day + ' ' + p.hour + 'æ™‚</span> ' +
        p.text + '</div>';
    });
    html += '</div>';
  }

  area.style.display = 'block';
  area.innerHTML = html;
};

App.renderBuzzAIReport_ = function(report, error) {
  var area = document.getElementById('buzzAIReportArea');
  if (!area) return;

  if (error) {
    area.style.display = 'block';
    area.innerHTML = '<div style="padding:10px;background:#fef3c7;border-radius:8px;font-size:12px;color:#92400e;">' +
      'âš ï¸ ' + error + '</div>';
    return;
  }

  if (report) {
    area.style.display = 'block';
    area.innerHTML = '<div style="margin-top:12px;padding:12px;background:#ffffff;border:1px solid #e2e8f0;border-radius:8px;">' +
      '<div class="markdown-body" style="font-size:13px;line-height:1.7;">' + App.parseMarkdown(report) + '</div>' +
    '</div>';
  }
};
</script>
